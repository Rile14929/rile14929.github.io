<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"rile14929.github.io","root":"/","scheme":"Pisces","version":"7.7.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="12345&#x2F;&#x2F; !3. commit&#x2F;&#x2F; 我们现在有了一个一致的树。下一步要么是 commit，要么是，如果有什么被暂停了，就等待一段时间后再 commit。root.finishedWork &#x3D; finishedWork;root.finishedLanes &#x3D; lanes;finishConcurrentRender(root, exitStatus, finishedWork, lanes)">
<meta property="og:type" content="article">
<meta property="og:title" content="react18.2源码分析（四）render-commit阶段">
<meta property="og:url" content="https://rile14929.github.io/zh-CN/react%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%88%E5%9B%9B%EF%BC%89render-commit%E9%98%B6%E6%AE%B5.html">
<meta property="og:site_name" content="右耳听风">
<meta property="og:description" content="12345&#x2F;&#x2F; !3. commit&#x2F;&#x2F; 我们现在有了一个一致的树。下一步要么是 commit，要么是，如果有什么被暂停了，就等待一段时间后再 commit。root.finishedWork &#x3D; finishedWork;root.finishedLanes &#x3D; lanes;finishConcurrentRender(root, exitStatus, finishedWork, lanes)">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://rile14929.github.io/images/react%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9B%9Brender-commit%E9%98%B6%E6%AE%B5/image.png">
<meta property="article:published_time" content="2024-08-11T16:00:00.000Z">
<meta property="article:modified_time" content="2024-08-11T16:00:00.000Z">
<meta property="article:author" content="rile">
<meta property="article:tag" content="react18.2">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://rile14929.github.io/images/react%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9B%9Brender-commit%E9%98%B6%E6%AE%B5/image.png">

<link rel="canonical" href="https://rile14929.github.io/zh-CN/react%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%88%E5%9B%9B%EF%BC%89render-commit%E9%98%B6%E6%AE%B5.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>react18.2源码分析（四）render-commit阶段 | 右耳听风</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">右耳听风</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tag"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://rile14929.github.io/zh-CN/react%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%88%E5%9B%9B%EF%BC%89render-commit%E9%98%B6%E6%AE%B5.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/IMG_2044.jpg">
      <meta itemprop="name" content="rile">
      <meta itemprop="description" content="FE">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="右耳听风">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          react18.2源码分析（四）render-commit阶段
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-08-12 00:00:00" itemprop="dateCreated datePublished" datetime="2024-08-12T00:00:00+08:00">2024-08-12</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// !3. commit</span></span><br><span class="line"><span class="comment">// 我们现在有了一个一致的树。下一步要么是 commit，要么是，如果有什么被暂停了，就等待一段时间后再 commit。</span></span><br><span class="line">root.finishedWork = finishedWork;</span><br><span class="line">root.finishedLanes = lanes;</span><br><span class="line">finishConcurrentRender(root, exitStatus, finishedWork, lanes);</span><br></pre></td></tr></table></figure>

<h2 id="2-commit阶段-finishConcurrentRender"><a href="#2-commit阶段-finishConcurrentRender" class="headerlink" title="2. commit阶段 - finishConcurrentRender"></a>2. commit阶段 - finishConcurrentRender</h2><h3 id="2-1-finishConcurrentRender"><a href="#2-1-finishConcurrentRender" class="headerlink" title="2.1 finishConcurrentRender"></a>2.1 finishConcurrentRender</h3><p><font color=gray><em>packages\react-reconciler\src\ReactFiberWorkLoop.js</em></font></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">finishConcurrentRender</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  root: FiberRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  exitStatus: RootExitStatus,</span></span></span><br><span class="line"><span class="function"><span class="params">  finishedWork: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  lanes: Lanes,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  commitRootWhenReady(</span><br><span class="line">      root,</span><br><span class="line">      finishedWork,</span><br><span class="line">      workInProgressRootRecoverableErrors,</span><br><span class="line">      workInProgressTransitions,</span><br><span class="line">      workInProgressRootDidIncludeRecursiveRenderUpdate,</span><br><span class="line">      lanes,</span><br><span class="line">      workInProgressDeferredLane,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-commitRootWhenReady"><a href="#2-2-commitRootWhenReady" class="headerlink" title="2.2 commitRootWhenReady"></a>2.2 commitRootWhenReady</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitRootWhenReady</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  root: FiberRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  finishedWork: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  recoverableErrors: Array&lt;CapturedValue&lt;mixed&gt;&gt; | null,</span></span></span><br><span class="line"><span class="function"><span class="params">  transitions: Array&lt;Transition&gt; | null,</span></span></span><br><span class="line"><span class="function"><span class="params">  didIncludeRenderPhaseUpdate: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params">  lanes: Lanes,</span></span></span><br><span class="line"><span class="function"><span class="params">  spawnedLane: Lane,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Otherwise, commit immediately.</span></span><br><span class="line">  commitRoot(</span><br><span class="line">    root,</span><br><span class="line">    recoverableErrors,</span><br><span class="line">    transitions,</span><br><span class="line">    didIncludeRenderPhaseUpdate,</span><br><span class="line">    spawnedLane,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-commitRoot"><a href="#2-3-commitRoot" class="headerlink" title="2.3 commitRoot"></a>2.3 commitRoot</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitRoot</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  root: FiberRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  recoverableErrors: null | Array&lt;CapturedValue&lt;mixed&gt;&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  transitions: Array&lt;Transition&gt; | null,</span></span></span><br><span class="line"><span class="function"><span class="params">  didIncludeRenderPhaseUpdate: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params">  spawnedLane: Lane,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> This no longer makes any sense. We already wrap the mutation and</span></span><br><span class="line">  <span class="comment">// layout phases. Should be able to remove.</span></span><br><span class="line">  <span class="keyword">const</span> previousUpdateLanePriority = getCurrentUpdatePriority();</span><br><span class="line">  <span class="keyword">const</span> prevTransition = ReactCurrentBatchConfig.transition;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    ReactCurrentBatchConfig.transition = <span class="literal">null</span>;</span><br><span class="line">    setCurrentUpdatePriority(DiscreteEventPriority);</span><br><span class="line">    commitRootImpl(</span><br><span class="line">      root,</span><br><span class="line">      recoverableErrors,</span><br><span class="line">      transitions,</span><br><span class="line">      didIncludeRenderPhaseUpdate,</span><br><span class="line">      previousUpdateLanePriority,</span><br><span class="line">      spawnedLane,</span><br><span class="line">    );</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    ReactCurrentBatchConfig.transition = prevTransition;</span><br><span class="line">    setCurrentUpdatePriority(previousUpdateLanePriority);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-commitRootImpl"><a href="#2-4-commitRootImpl" class="headerlink" title="2.4 commitRootImpl"></a>2.4 commitRootImpl</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitRootImpl</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  root: FiberRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  recoverableErrors: null | Array&lt;CapturedValue&lt;mixed&gt;&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  transitions: Array&lt;Transition&gt; | null,</span></span></span><br><span class="line"><span class="function"><span class="params">  didIncludeRenderPhaseUpdate: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params">  renderPriorityLevel: EventPriority,</span></span></span><br><span class="line"><span class="function"><span class="params">  spawnedLane: Lane,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> finishedWork = root.finishedWork;</span><br><span class="line">  <span class="keyword">const</span> lanes = root.finishedLanes;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    (finishedWork.subtreeFlags &amp; PassiveMask) !== NoFlags ||</span><br><span class="line">    (finishedWork.flags &amp; PassiveMask) !== NoFlags</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!rootDoesHavePassiveEffects) &#123;</span><br><span class="line">      rootDoesHavePassiveEffects = <span class="literal">true</span>;</span><br><span class="line">      pendingPassiveEffectsRemainingLanes = remainingLanes;</span><br><span class="line"></span><br><span class="line">      pendingPassiveTransitions = transitions;</span><br><span class="line">      scheduleCallback(NormalSchedulerPriority, () =&gt; &#123;</span><br><span class="line">        <span class="comment">// ! 1. 异步执行 passive effects</span></span><br><span class="line">        flushPassiveEffects();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 检查HostFiber的子孙元素是存在副作用</span></span><br><span class="line">  <span class="keyword">const</span> subtreeHasEffects =</span><br><span class="line">    (finishedWork.subtreeFlags &amp;</span><br><span class="line">      (BeforeMutationMask | MutationMask | LayoutMask | PassiveMask)) !==</span><br><span class="line">    NoFlags;</span><br><span class="line">  <span class="comment">// 检查HostFiber自身存在副作用</span></span><br><span class="line">  <span class="keyword">const</span> rootHasEffect =</span><br><span class="line">    (finishedWork.flags &amp;</span><br><span class="line">      (BeforeMutationMask | MutationMask | LayoutMask | PassiveMask)) !==</span><br><span class="line">    NoFlags;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 任何一个有副作用，说明需要更新，进入commit逻辑</span></span><br><span class="line">  <span class="keyword">if</span> (subtreeHasEffects || rootHasEffect) &#123;</span><br><span class="line">    <span class="keyword">const</span> prevTransition = ReactCurrentBatchConfig.transition;</span><br><span class="line">    ReactCurrentBatchConfig.transition = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// 获取当前更新优先级</span></span><br><span class="line">    <span class="keyword">const</span> previousPriority = getCurrentUpdatePriority();</span><br><span class="line">    <span class="comment">// 设置同步优先级，commit必须同步执行</span></span><br><span class="line">    setCurrentUpdatePriority(DiscreteEventPriority);</span><br><span class="line">    <span class="comment">// 当前上下文</span></span><br><span class="line">    <span class="keyword">const</span> prevExecutionContext = executionContext;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ! 2. 进入commit阶段</span></span><br><span class="line">    executionContext |= CommitContext;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在调用生命周期之前将其重置为null</span></span><br><span class="line">    ReactCurrentOwner.current = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ! 3. BeforeMutation阶段【这个阶段执行与flags相关的副作用】</span></span><br><span class="line">    <span class="keyword">const</span> shouldFireAfterActiveInstanceBlur = commitBeforeMutationEffects(</span><br><span class="line">      root,</span><br><span class="line">      finishedWork,</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ! 4. mutation阶段 (完成真实的dom渲染，更新页面)</span></span><br><span class="line">    commitMutationEffects(root, finishedWork, lanes);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 渲染后，重置container容器信息</span></span><br><span class="line">    resetAfterCommit(root.containerInfo);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据Fiber双缓冲机制，完成Current Fiber Tree的切换</span></span><br><span class="line">    <span class="comment">// 其实也并不一定叫切换，就是将最新work内容存储为当前的内容，下一次的work就可以利用当前的内容</span></span><br><span class="line">    <span class="comment">// 注意：到这里是页面已经完成了更新渲染，这个交互Fiber Tree是为了保留最新的Tree，提供给下次更新使用</span></span><br><span class="line">    <span class="comment">// 同时也方便调用生命周期钩子时是最新的DOM</span></span><br><span class="line">    root.current = finishedWork;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ! 5. layout阶段</span></span><br><span class="line">    commitLayoutEffects(finishedWork, root, lanes);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// No effects.</span></span><br><span class="line">    root.current = finishedWork;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-4-1-异步执行-passive-effects"><a href="#2-4-1-异步执行-passive-effects" class="headerlink" title="2.4.1 异步执行 passive effects"></a>2.4.1 异步执行 passive effects</h4><p>执行 useEffect 的 effects</p>
<h4 id="2-4-2-进入-commit-阶段"><a href="#2-4-2-进入-commit-阶段" class="headerlink" title="2.4.2 进入 commit 阶段"></a>2.4.2 进入 commit 阶段</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">executionContext |= CommitContext</span><br></pre></td></tr></table></figure>

<h4 id="2-4-3-beforeMutation阶段-commitBeforeMutationEffects"><a href="#2-4-3-beforeMutation阶段-commitBeforeMutationEffects" class="headerlink" title="2.4.3 beforeMutation阶段 - commitBeforeMutationEffects"></a>2.4.3 beforeMutation阶段 - commitBeforeMutationEffects</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">commitBeforeMutationEffects</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  root: FiberRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  firstChild: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  focusedInstanceHandle = prepareForCommit(root.containerInfo);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置第一个处理的节点为 hostFiber</span></span><br><span class="line">  nextEffect = firstChild;</span><br><span class="line">  <span class="comment">// 提交开始</span></span><br><span class="line">  commitBeforeMutationEffects_begin();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> shouldFire = shouldFireAfterActiveInstanceBlur;</span><br><span class="line">  shouldFireAfterActiveInstanceBlur = <span class="literal">false</span>;</span><br><span class="line">  focusedInstanceHandle = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> shouldFire;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>初始化 <code>nextEffect</code> 变量，这里的 <code>firstChild</code> 代表第一个处理的节点为 <code>hostFiber</code>。</p>
<p>然后调用 <code>commitBeforeMutationEffects_begin</code>，开始递归遍历 <code>FiberTree</code>，处理有副作用的 <code>Fiber</code> 节点。</p>
<h5 id="2-4-3-1-commitBeforeMutationEffects-begin"><a href="#2-4-3-1-commitBeforeMutationEffects-begin" class="headerlink" title="2.4.3.1 commitBeforeMutationEffects_begin"></a>2.4.3.1 commitBeforeMutationEffects_begin</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitBeforeMutationEffects_begin</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// while循环，处理所有节点</span></span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect;</span><br><span class="line">    <span class="comment">// 取出子节点， 刚开始是hostFiber节点的child： 即App 组件</span></span><br><span class="line">    <span class="keyword">const</span> child = fiber.child;</span><br><span class="line">    <span class="comment">// 如果该fiber的子节点存在BeforeMutation阶段相关的flgas标记 且 child不为null;  则继续循环，</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      (fiber.subtreeFlags &amp; BeforeMutationMask) !== NoFlags &amp;&amp;</span><br><span class="line">      child !== <span class="literal">null</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      child.return = fiber;</span><br><span class="line">      <span class="comment">// 设置child为下一个处理的节点</span></span><br><span class="line">      nextEffect = child;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 只有当fiber的子节点不存在BeforeMutation阶段相关的flgas标记 且 child为null; 【叶子节点】</span></span><br><span class="line">      <span class="comment">// 和reconciler流程一样，第一个进入complete工作的都是【div react源码调试】节点</span></span><br><span class="line">      commitBeforeMutationEffects_complete();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-4-3-2-commitBeforeMutationEffects-complete"><a href="#2-4-3-2-commitBeforeMutationEffects-complete" class="headerlink" title="2.4.3.2 commitBeforeMutationEffects_complete"></a>2.4.3.2 commitBeforeMutationEffects_complete</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitBeforeMutationEffects_complete</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect;</span><br><span class="line">    setCurrentDebugFiberInDEV(fiber);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 处理当前节点的副作用</span></span><br><span class="line">      commitBeforeMutationEffectsOnFiber(fiber);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      captureCommitPhaseError(fiber, fiber.return, error);</span><br><span class="line">    &#125;</span><br><span class="line">    resetCurrentDebugFiberInDEV();</span><br><span class="line">    <span class="comment">// 取出兄弟节点</span></span><br><span class="line">    <span class="keyword">const</span> sibling = fiber.sibling;</span><br><span class="line">    <span class="keyword">if</span> (sibling !== <span class="literal">null</span>) &#123;</span><br><span class="line">      sibling.return = fiber.return;</span><br><span class="line">      <span class="comment">// 将兄弟节点设置为下一个nextEffect 【回到begin工作】</span></span><br><span class="line">      nextEffect = sibling;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    nextEffect = fiber.return;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>commitBeforeMutationEffects_complete方法也是一个while循环，对当前Fiber节点执行flags标记对应的操作，即执行commitBeforeMutationEffectsOnFiber方法。执行完成后，如果当前Fiber节点存在sibling兄弟节点，则将兄弟节点设置为最新的nextEffect，退出当前函数，开启兄弟节点的begin工作。如果不存在兄弟节点，则将当前Fiber节点的父级节点设置为最新的nextEffect，执行父级节点的commitBeforeMutationEffects_complete工作。</p>
<p>根据上面可以看出，BeforeMutation阶段逻辑和之前创建FiberTree的逻辑基本相同，都是深度优先遍历的顺序从HostFiber根节点开始【自上而下】遍历处理每一个满足条件的Fiber节点，执行flags对应的副作用操作，即相似的begin和complete工作逻辑。这里主要的执行内容在commitBeforeMutationEffectsOnFiber方法之中。</p>
<blockquote>
<p>注意，其实commit阶段中三个子阶段的逻辑：基本都是以这种逻辑方式来处理相关的副作用内容。</p>
</blockquote>
<h5 id="2-4-3-3-commitBeforeMutationEffectsOnFiber"><a href="#2-4-3-3-commitBeforeMutationEffectsOnFiber" class="headerlink" title="2.4.3.3 commitBeforeMutationEffectsOnFiber"></a>2.4.3.3 commitBeforeMutationEffectsOnFiber</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitBeforeMutationEffectsOnFiber</span>(<span class="params">finishedWork: Fiber</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> current = finishedWork.alternate;</span><br><span class="line">  <span class="keyword">const</span> flags = finishedWork.flags;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 根据节点的类型，进行不同的副作用处理</span></span><br><span class="line">  <span class="keyword">switch</span> (finishedWork.tag) &#123;</span><br><span class="line">    <span class="keyword">case</span> FunctionComponent: &#123;</span><br><span class="line">      <span class="keyword">if</span> (enableUseEffectEventHook) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((flags &amp; Update) !== NoFlags) &#123;</span><br><span class="line">          commitUseEffectEventMount(finishedWork);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> ForwardRef:</span><br><span class="line">    <span class="keyword">case</span> SimpleMemoComponent: &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> ClassComponent: &#123;</span><br><span class="line">      <span class="keyword">if</span> ((flags &amp; Snapshot) !== NoFlags) &#123;</span><br><span class="line">        <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> prevProps = current.memoizedProps;</span><br><span class="line">          <span class="keyword">const</span> prevState = current.memoizedState;</span><br><span class="line">          <span class="keyword">const</span> instance = finishedWork.stateNode;</span><br><span class="line">          <span class="keyword">const</span> snapshot = instance.getSnapshotBeforeUpdate(</span><br><span class="line">            finishedWork.elementType === finishedWork.type</span><br><span class="line">              ? prevProps</span><br><span class="line">              : resolveDefaultProps(finishedWork.type, prevProps),</span><br><span class="line">            prevState,</span><br><span class="line">          );</span><br><span class="line">          instance.__reactInternalSnapshotBeforeUpdate = snapshot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// hostFiber节点的处理</span></span><br><span class="line">    <span class="keyword">case</span> HostRoot: &#123;</span><br><span class="line">      <span class="keyword">if</span> ((flags &amp; Snapshot) !== NoFlags) &#123;</span><br><span class="line">        <span class="keyword">if</span> (supportsMutation) &#123;</span><br><span class="line">          <span class="comment">// 应用根节点</span></span><br><span class="line">          <span class="keyword">const</span> root = finishedWork.stateNode;</span><br><span class="line">          <span class="comment">// 设置textContent = ''; 也就是清空#div容器内容， 方便Mutation阶段的渲染</span></span><br><span class="line">          clearContainer(root.containerInfo);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> HostComponent:</span><br><span class="line">    <span class="keyword">case</span> HostHoistable:</span><br><span class="line">    <span class="keyword">case</span> HostSingleton:</span><br><span class="line">    <span class="keyword">case</span> HostText:</span><br><span class="line">    <span class="keyword">case</span> HostPortal:</span><br><span class="line">    <span class="keyword">case</span> IncompleteClassComponent:</span><br><span class="line">      <span class="comment">// Nothing to do for these component types</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>: &#123;</span><br><span class="line">      <span class="keyword">if</span> ((flags &amp; Snapshot) !== NoFlags) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">          <span class="string">'This unit of work tag should not have side-effects. This error is '</span> +</span><br><span class="line">            <span class="string">'likely caused by a bug in React. Please file an issue.'</span>,</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((flags &amp; Snapshot) !== NoFlags) &#123;</span><br><span class="line">    resetCurrentDebugFiberInDEV();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进入 <code>commitBeforeMutationEffectsOnFiber</code> 方法后，发现只有 <code>Snapshot</code> 标记的副作用才会执行。</p>
<blockquote>
<p><code>hostFiber</code> 节点的 <code>Snapshot</code> 副作用是在 <code>completeWork</code> 工作中被标记的。</p>
</blockquote>
<h5 id="2-4-3-4-BeforeMutation阶段总结"><a href="#2-4-3-4-BeforeMutation阶段总结" class="headerlink" title="2.4.3.4 BeforeMutation阶段总结"></a>2.4.3.4 BeforeMutation阶段总结</h5><p>所以BeforeMutation阶段最终只会执行这两种副作用：</p>
<ol>
<li>触发类组件的getSnapshotBeforeUpdate钩子。</li>
<li>处理HostRoot类型节点【HostFiber】，清空#root容器内容， 方便下面Mutation阶段的DOM挂载。</li>
</ol>
<h4 id="2-4-4-mutation-阶段-commitMutationEffects"><a href="#2-4-4-mutation-阶段-commitMutationEffects" class="headerlink" title="2.4.4 mutation 阶段 - commitMutationEffects"></a>2.4.4 mutation 阶段 - commitMutationEffects</h4><p>前面我们已经知道了 <code>MutationMask</code> 的定义：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MutationMask = Placement | Update | ChildDeletion | ContentReset | Ref | Hydrating | Visibility;</span><br></pre></td></tr></table></figure>

<p>而 <code>MutationMask</code> 就是代表 <code>Mutation</code> 阶段所需要执行的哪些副作用类型，虽然可以看到 <code>MutationMask</code> 集成了很多的副作用标记，但是 <code>Mutation</code> 阶段的重点内容：还是针对 <code>Fiber</code> 节点上 <code>DOM</code> 内容的处理，然后将最终的 <code>DOM</code> 内容渲染到页面。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">commitMutationEffects</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  root: FiberRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  finishedWork: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  committedLanes: Lanes,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  inProgressLanes = committedLanes;</span><br><span class="line">  inProgressRoot = root;</span><br><span class="line"></span><br><span class="line">  commitMutationEffectsOnFiber(finishedWork, root, committedLanes);</span><br><span class="line"></span><br><span class="line">  inProgressLanes = <span class="literal">null</span>;</span><br><span class="line">  inProgressRoot = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-4-4-1-commitMutationEffectsOnFiber"><a href="#2-4-4-1-commitMutationEffectsOnFiber" class="headerlink" title="2.4.4.1 commitMutationEffectsOnFiber"></a>2.4.4.1 commitMutationEffectsOnFiber</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitMutationEffectsOnFiber</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  finishedWork: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  root: FiberRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  lanes: Lanes,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 旧hostFiber 节点</span></span><br><span class="line">  <span class="keyword">const</span> current = finishedWork.alternate;</span><br><span class="line">  <span class="comment">// 取出dom操作的标识flags</span></span><br><span class="line">  <span class="keyword">const</span> flags = finishedWork.flags;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 根据节点tag，执行不同的逻辑</span></span><br><span class="line">  <span class="keyword">switch</span> (finishedWork.tag) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 函数组件处理</span></span><br><span class="line">    <span class="keyword">case</span> FunctionComponent:</span><br><span class="line">    <span class="keyword">case</span> ForwardRef:</span><br><span class="line">    <span class="keyword">case</span> MemoComponent:</span><br><span class="line">    <span class="keyword">case</span> SimpleMemoComponent: &#123;</span><br><span class="line">      <span class="comment">// recursivelyTraverse：递归遍历</span></span><br><span class="line">      recursivelyTraverseMutationEffects(root, finishedWork, lanes);</span><br><span class="line">      <span class="comment">// app组件跳出了循环，向下继续执行</span></span><br><span class="line">      commitReconciliationEffects(finishedWork);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (flags &amp; Update) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          commitHookEffectListUnmount(</span><br><span class="line">            HookInsertion | HookHasEffect,</span><br><span class="line">            finishedWork,</span><br><span class="line">            finishedWork.return,</span><br><span class="line">          );</span><br><span class="line">          commitHookEffectListMount(</span><br><span class="line">            HookInsertion | HookHasEffect,</span><br><span class="line">            finishedWork,</span><br><span class="line">          );</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">          captureCommitPhaseError(finishedWork, finishedWork.return, error);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">          enableProfilerTimer &amp;&amp;</span><br><span class="line">          enableProfilerCommitHooks &amp;&amp;</span><br><span class="line">          finishedWork.mode &amp; ProfileMode</span><br><span class="line">        ) &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            startLayoutEffectTimer();</span><br><span class="line">            commitHookEffectListUnmount(</span><br><span class="line">              HookLayout | HookHasEffect,</span><br><span class="line">              finishedWork,</span><br><span class="line">              finishedWork.return,</span><br><span class="line">            );</span><br><span class="line">          &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            captureCommitPhaseError(finishedWork, finishedWork.return, error);</span><br><span class="line">          &#125;</span><br><span class="line">          recordLayoutEffectDuration(finishedWork);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            commitHookEffectListUnmount(</span><br><span class="line">              HookLayout | HookHasEffect,</span><br><span class="line">              finishedWork,</span><br><span class="line">              finishedWork.return,</span><br><span class="line">            );</span><br><span class="line">          &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            captureCommitPhaseError(finishedWork, finishedWork.return, error);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 类组件处理</span></span><br><span class="line">    <span class="keyword">case</span> ClassComponent: &#123;</span><br><span class="line">      recursivelyTraverseMutationEffects(root, finishedWork, lanes);</span><br><span class="line">      commitReconciliationEffects(finishedWork);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (flags &amp; Ref) &#123;</span><br><span class="line">        <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">          safelyDetachRef(current, current.return);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 原生dom元素处理</span></span><br><span class="line">    <span class="keyword">case</span> HostComponent: &#123;</span><br><span class="line">      <span class="comment">// 递归遍历</span></span><br><span class="line">      recursivelyTraverseMutationEffects(root, finishedWork, lanes);</span><br><span class="line">      <span class="comment">// 处理dom</span></span><br><span class="line">      commitReconciliationEffects(finishedWork);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (flags &amp; Ref) &#123;</span><br><span class="line">        <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">          safelyDetachRef(current, current.return);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (supportsMutation) &#123;</span><br><span class="line">        <span class="comment">// 如果flags标记为ContentReset</span></span><br><span class="line">        <span class="keyword">if</span> (finishedWork.flags &amp; ContentReset) &#123;</span><br><span class="line">          <span class="comment">// dom实例</span></span><br><span class="line">          <span class="keyword">const</span> instance: Instance = finishedWork.stateNode;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 重置dom的内容</span></span><br><span class="line">            resetTextContent(instance);</span><br><span class="line">          &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            captureCommitPhaseError(finishedWork, finishedWork.return, error);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果flgas标记为Update更新</span></span><br><span class="line">        <span class="keyword">if</span> (flags &amp; Update) &#123;</span><br><span class="line">          <span class="comment">// 取出当前节点对应的DOM对象</span></span><br><span class="line">          <span class="keyword">const</span> instance: Instance = finishedWork.stateNode;</span><br><span class="line">          <span class="keyword">if</span> (instance != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Commit the work prepared earlier.</span></span><br><span class="line">            <span class="keyword">const</span> newProps = finishedWork.memoizedProps;</span><br><span class="line">            <span class="comment">// For hydration we reuse the update path but we treat the oldProps</span></span><br><span class="line">            <span class="comment">// as the newProps. The updatePayload will contain the real change in</span></span><br><span class="line">            <span class="comment">// this case.</span></span><br><span class="line">            <span class="keyword">const</span> oldProps =</span><br><span class="line">              current !== <span class="literal">null</span> ? current.memoizedProps : newProps;</span><br><span class="line">            <span class="keyword">const</span> type = finishedWork.type;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> Type the updateQueue to be specific to host components.</span></span><br><span class="line">            <span class="keyword">const</span> updatePayload: <span class="literal">null</span> | UpdatePayload = (finishedWork.updateQueue: any);</span><br><span class="line">            finishedWork.updateQueue = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (updatePayload !== <span class="literal">null</span>) &#123;</span><br><span class="line">              <span class="keyword">try</span> &#123;</span><br><span class="line">                commitUpdate(</span><br><span class="line">                  instance,</span><br><span class="line">                  updatePayload,</span><br><span class="line">                  type,</span><br><span class="line">                  oldProps,</span><br><span class="line">                  newProps,</span><br><span class="line">                  finishedWork,</span><br><span class="line">                );</span><br><span class="line">              &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                captureCommitPhaseError(</span><br><span class="line">                  finishedWork,</span><br><span class="line">                  finishedWork.return,</span><br><span class="line">                  error,</span><br><span class="line">                );</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 文本处理</span></span><br><span class="line">    <span class="keyword">case</span> HostText: &#123;</span><br><span class="line">      recursivelyTraverseMutationEffects(root, finishedWork, lanes);</span><br><span class="line">      commitReconciliationEffects(finishedWork);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (flags &amp; Update) &#123;</span><br><span class="line">        <span class="keyword">if</span> (supportsMutation) &#123;</span><br><span class="line">          <span class="keyword">if</span> (finishedWork.stateNode === <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">              <span class="string">'This should have a text node initialized. This error is likely '</span> +</span><br><span class="line">                <span class="string">'caused by a bug in React. Please file an issue.'</span>,</span><br><span class="line">            );</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">const</span> textInstance: TextInstance = finishedWork.stateNode;</span><br><span class="line">          <span class="keyword">const</span> newText: string = finishedWork.memoizedProps;</span><br><span class="line">          <span class="comment">// For hydration we reuse the update path but we treat the oldProps</span></span><br><span class="line">          <span class="comment">// as the newProps. The updatePayload will contain the real change in</span></span><br><span class="line">          <span class="comment">// this case.</span></span><br><span class="line">          <span class="keyword">const</span> oldText: string =</span><br><span class="line">            current !== <span class="literal">null</span> ? current.memoizedProps : newText;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            commitTextUpdate(textInstance, oldText, newText);</span><br><span class="line">          &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            captureCommitPhaseError(finishedWork, finishedWork.return, error);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// hostFiber根节点处理 【第一次会走根节点， 从根节点向下递归渲染dom】</span></span><br><span class="line">    <span class="keyword">case</span> HostRoot: &#123;</span><br><span class="line">      <span class="comment">// recursivelyTraverse：递归遍历 【页面显示】</span></span><br><span class="line">      recursivelyTraverseMutationEffects(root, finishedWork, lanes);</span><br><span class="line"></span><br><span class="line">      commitReconciliationEffects(finishedWork);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (flags &amp; Update) &#123;</span><br><span class="line">        <span class="keyword">if</span> (supportsMutation &amp;&amp; supportsHydration) &#123;</span><br><span class="line">          <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> prevRootState: RootState = current.memoizedState;</span><br><span class="line">            <span class="keyword">if</span> (prevRootState.isDehydrated) &#123;</span><br><span class="line">              <span class="keyword">try</span> &#123;</span><br><span class="line">                commitHydratedContainer(root.containerInfo);</span><br><span class="line">              &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                captureCommitPhaseError(</span><br><span class="line">                  finishedWork,</span><br><span class="line">                  finishedWork.return,</span><br><span class="line">                  error,</span><br><span class="line">                );</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (supportsPersistence) &#123;</span><br><span class="line">          <span class="keyword">const</span> containerInfo = root.containerInfo;</span><br><span class="line">          <span class="keyword">const</span> pendingChildren = root.pendingChildren;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            replaceContainerChildren(containerInfo, pendingChildren);</span><br><span class="line">          &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            captureCommitPhaseError(finishedWork, finishedWork.return, error);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>: &#123;</span><br><span class="line">      recursivelyTraverseMutationEffects(root, finishedWork, lanes);</span><br><span class="line">      commitReconciliationEffects(finishedWork);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>commitMutationEffectsOnFiber</code> 方法内容很多，但是它的核心逻辑依然是switch case结构：根据当前Fiber节点tag值，对不同组件类型进行不同的逻辑处理。</p>
<p>要处理的组件类型有很多，我们主要掌握几个常见的组件类型处理逻辑：</p>
<ul>
<li>FunctionComponent：函数组件。</li>
<li>ClassComponent：类组件。</li>
<li>HostComponent：DOM节点。</li>
<li>HostText：文本节点。</li>
<li>HostRoot：HostFiber根节点。</li>
</ul>
<p>从上面几个组件类型的处理逻辑来看，它们都是一套相同的处理逻辑：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1，删除DOM</span></span><br><span class="line">recursivelyTraverseMutationEffects(root, finishedWork, lanes);</span><br><span class="line"><span class="comment">// 2，插入DOM</span></span><br><span class="line">commitReconciliationEffects(finishedWork);</span><br><span class="line"><span class="comment">// 3，更新(DOM内容)</span></span><br></pre></td></tr></table></figure>

<h5 id="2-4-4-2-Mutation阶段执行顺序"><a href="#2-4-4-2-Mutation阶段执行顺序" class="headerlink" title="2.4.4.2 Mutation阶段执行顺序"></a>2.4.4.2 Mutation阶段执行顺序</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">commitMutationEffectsOnFiber  =&gt; commit()</span><br><span class="line">recursivelyTraverseMutationEffects  这个方法中使用了循环，并且调用了上面的方法=&gt; <span class="keyword">for</span>()</span><br><span class="line"><span class="comment">// 2，插入DOM</span></span><br><span class="line">commitReconciliationEffects(finishedWork);  <span class="comment">// 2，3两部分视为一个内容 =&gt; content()</span></span><br><span class="line"><span class="comment">// 3，更新(DOM内容)</span></span><br><span class="line">commitPlacement(finishedWork);</span><br></pre></td></tr></table></figure>

<p>所以Mutation阶段的执行顺序就可以表示为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Fiber顺序: <span class="function"><span class="params">HostFiber</span>  =&gt;</span>    fun App    =&gt; 	 div.App  =&gt;   ...</span><br><span class="line"><span class="comment">// 代码执行顺序</span></span><br><span class="line">commit</span><br><span class="line">	      <span class="keyword">for</span></span><br><span class="line">			      commit</span><br><span class="line">			  		  	    <span class="keyword">for</span></span><br><span class="line">						  		   commit</span><br><span class="line">						  				      <span class="keyword">for</span></span><br><span class="line">						  				  		     commit</span><br><span class="line">						  				  		  		      ...</span><br><span class="line">						  				      content</span><br><span class="line">						    content</span><br><span class="line">	      content</span><br></pre></td></tr></table></figure>

<p>执行顺序为从上往下，通过这种递归遍历方式，可以发现HostFiber虽然是第一个进入commit逻辑的节点，但是它的content内容却是最后一个执行，也就是说在HostFiber的content内容处理完成之后，即代表完整的DOM树已经渲染到页面。实际上最后执行插入到页面的操作是在【fun App】组件节点上执行的，后续会有说明，这部分内容在第三章也有解释。</p>
<p><img src="../images/react%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9B%9Brender-commit%E9%98%B6%E6%AE%B5/image.png" alt="alt text"></p>
<h5 id="2-4-4-3-recursivelyTraverseMutationEffects"><a href="#2-4-4-3-recursivelyTraverseMutationEffects" class="headerlink" title="2.4.4.3 recursivelyTraverseMutationEffects"></a>2.4.4.3 recursivelyTraverseMutationEffects</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">recursivelyTraverseMutationEffects</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  root: FiberRoot, <span class="regexp">//</span> root</span></span></span><br><span class="line"><span class="function"><span class="params">  parentFiber: Fiber, <span class="regexp">//</span> HostFiber</span></span></span><br><span class="line"><span class="function"><span class="params">  lanes: Lanes,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  # 删除标记，是否存在</span><br><span class="line">  <span class="keyword">const</span> deletions = parentFiber.deletions;</span><br><span class="line">  <span class="keyword">if</span> (deletions !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; deletions.length; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> childToDelete = deletions[i];</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 执行删除副作用</span></span><br><span class="line">        commitDeletionEffects(root, parentFiber, childToDelete);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        captureCommitPhaseError(childToDelete, parentFiber, error);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  # 如果子节点树有副作用标记</span><br><span class="line">  <span class="keyword">if</span> (parentFiber.subtreeFlags &amp; MutationMask) &#123;</span><br><span class="line">    <span class="comment">// 取出子节点</span></span><br><span class="line">    <span class="keyword">let</span> child = parentFiber.child;</span><br><span class="line">    <span class="keyword">while</span> (child !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// 开始递归渲染</span></span><br><span class="line">      commitMutationEffectsOnFiber(child, root, lanes);</span><br><span class="line">      child = child.sibling;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据上面的代码可以看出，<code>recursivelyTraverseMutationEffects</code> 方法主要就两个逻辑：</p>
<ul>
<li>判断当前 <code>Fiber</code> 节点是否存在 <code>deletions</code> 删除标记，如果存在则循环 <code>deletions</code>，删除子节点对应DOM元素的内容。</li>
<li>遍历子树，递归调用 <code>commitMutationEffectsOnFiber</code>。</li>
</ul>
<p>这里主要讲解第一点内容删除的逻辑，第二点遍历的内容就是前面 <code>Mutation</code> 阶段执行顺序的内容。<br>具体的删除逻辑就是执行 <code>commitDeletionEffects</code> 方法，真实的删除逻辑比较复杂，删除一个DOM元素要考虑很多东西，这里我们不会展开 <code>commitDeletionEffects</code> 方法，但是还是要了解一下可能会造成的一些副作用影响：</p>
<ul>
<li>执行子树所有组件的 <code>unmount</code> 卸载逻辑。</li>
<li>执行子树某些类组件的 <code>componentWillUnmount</code> 方法。</li>
<li>执行子树某些函数组件的 <code>useEffect</code>，<code>useLayoutEffect</code>等 hooks 的 <code>destory</code> 销毁方法。</li>
<li>执行子树所有 <code>ref</code> 属性的卸载操作。</li>
</ul>
<p>这里将删除DOM的逻辑放在每个组件的第一个执行，也是非常必要的。因为Mutation阶段的核心就是DOM操作，如果对应的DOM都已经被删除了，那么也就没有必要再去执行剩下的修改更新了。</p>
<h5 id="2-4-4-4-commitReconciliationEffects"><a href="#2-4-4-4-commitReconciliationEffects" class="headerlink" title="2.4.4.4 commitReconciliationEffects"></a>2.4.4.4 commitReconciliationEffects</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitReconciliationEffects</span>(<span class="params">finishedWork: Fiber</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> flags = finishedWork.flags;</span><br><span class="line">  <span class="comment">// 如果是插入/移动标记</span></span><br><span class="line">  <span class="keyword">if</span> (flags &amp; Placement) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      # 执行dom插入添加操作</span><br><span class="line">      commitPlacement(finishedWork);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      captureCommitPhaseError(finishedWork, finishedWork.return, error);</span><br><span class="line">    &#125;</span><br><span class="line">    finishedWork.flags &amp;= ~Placement;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (flags &amp; Hydrating) &#123;</span><br><span class="line">    finishedWork.flags &amp;= ~Hydrating;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>commitReconciliationEffects</code> 方法就是执行 <code>DOM</code> 的插入或者移动操作，判断当前 <code>Fiber</code> 节点是否存在 <code>Placement</code> 标记，存在就会执行 <code>commitPlacement</code> 方法，执行相关的 <code>DOM</code> 的操作。</p>
<h5 id="2-4-4-5-commitPlacement"><a href="#2-4-4-5-commitPlacement" class="headerlink" title="2.4.4.5 commitPlacement"></a>2.4.4.5 commitPlacement</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitPlacement</span>(<span class="params">finishedWork: Fiber</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!supportsMutation) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// finishedWork: fun App 它的父级节点为HostFIber</span></span><br><span class="line">  <span class="keyword">const</span> parentFiber = getHostParentFiber(finishedWork);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (parentFiber.tag) &#123;</span><br><span class="line">    # 普通DOM节点</span><br><span class="line">    <span class="keyword">case</span> HostComponent: &#123;</span><br><span class="line">      <span class="keyword">const</span> parent: Instance = parentFiber.stateNode;</span><br><span class="line">      <span class="keyword">if</span> (parentFiber.flags &amp; ContentReset) &#123;</span><br><span class="line">        resetTextContent(parent);</span><br><span class="line">        parentFiber.flags &amp;= ~ContentReset;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> before = getHostSibling(finishedWork);</span><br><span class="line">      <span class="comment">// 插入节点</span></span><br><span class="line">      insertOrAppendPlacementNode(finishedWork, before, parent);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # 处理HostFiber节点的插入动作：</span><br><span class="line">    <span class="keyword">case</span> HostRoot:</span><br><span class="line">    <span class="keyword">case</span> HostPortal: &#123;</span><br><span class="line">      <span class="comment">// #div</span></span><br><span class="line">      <span class="keyword">const</span> parent: Container = parentFiber.stateNode.containerInfo;</span><br><span class="line">      <span class="comment">// 无兄弟节点</span></span><br><span class="line">      <span class="keyword">const</span> before = getHostSibling(finishedWork);</span><br><span class="line">      # 将离屏的DOM树插入到#div； 马上页面上显示出DOM内容</span><br><span class="line">      insertOrAppendPlacementNodeIntoContainer(finishedWork, before, parent);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>能够执行 <code>Placement</code> 副作用的，只有两种组件节点 <code>HostComponent</code> 和 <code>HostRoot</code>。</p>
<p>对于 <code>HostComponent</code> 来说，就是常规的 <code>DOM</code> 插入和移动，即调用原生的 <code>DOM</code> 方法执行对应的逻辑：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 原生DOM操作</span></span><br><span class="line">parentNode.appendChild()</span><br><span class="line">parentNode.insertBefore()</span><br></pre></td></tr></table></figure>

<h5 id="mutation阶段总结"><a href="#mutation阶段总结" class="headerlink" title="mutation阶段总结"></a>mutation阶段总结</h5><p>mutation 阶段的主要工作是：</p>
<ul>
<li>对 <code>DOM</code> 内容的增删改操作，最后将构建完成的离屏 <code>DOM</code> 树渲染到页面。</li>
<li>针对函数组件触发 <code>useInsertionEffect hook</code> 的副作用以及 <code>useLayoutEffect hook</code> 的 <code>destroy</code> 方法。</li>
<li>针对类组件和普通 <code>DOM</code> 组件重置 <code>ref</code> 对象的内容。</li>
</ul>
<h4 id="2-4-5-layout-阶段-commitLayoutEffects"><a href="#2-4-5-layout-阶段-commitLayoutEffects" class="headerlink" title="2.4.5 layout 阶段 - commitLayoutEffects"></a>2.4.5 layout 阶段 - commitLayoutEffects</h4><p>前面我们已经知道了 <code>LayoutMask</code> 的定义：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LayoutMask = Update | Callback | Ref | Visibility;</span><br></pre></td></tr></table></figure>

<p>而 <code>LayoutMask</code> 就是代表 <code>Layout</code> 阶段所需要执行的哪些副作用类型：</p>
<ul>
<li>类组件的 <code>componentDidMount/componentDidUpdate</code> 生命周期钩子函数的执行。</li>
<li>类组件调用 <code>this.setState</code> 时传递的 <code>callback</code> 回调函数的会被保存到 <code>Fiber</code> 节点的 <code>updateQueue</code> 属性中在这里执行。</li>
<li>执行函数组件的 <code>useLayoutEffect hook</code> 回调。</li>
</ul>
<p>可以说 Layout 阶段的主要内容：就是在DOM渲染完成后，执行函数组件和类组件定义的一些callback回调函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">commitLayoutEffects</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  finishedWork: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  root: FiberRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  committedLanes: Lanes,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  inProgressLanes = committedLanes;</span><br><span class="line">  inProgressRoot = root;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// HostFiber</span></span><br><span class="line">  nextEffect = finishedWork;</span><br><span class="line">  # 又是begin 和complete工作逻辑</span><br><span class="line">  # 相当于递归循环触发每个组件的生命周期钩子函数 以及相关的 hooks 回调</span><br><span class="line">  commitLayoutEffects_begin(finishedWork, root, committedLanes);</span><br><span class="line"></span><br><span class="line">  inProgressLanes = <span class="literal">null</span>;</span><br><span class="line">  inProgressRoot = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-4-5-1-commitLayoutEffects-begin"><a href="#2-4-5-1-commitLayoutEffects-begin" class="headerlink" title="2.4.5.1 commitLayoutEffects_begin"></a>2.4.5.1 commitLayoutEffects_begin</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitLayoutEffects_begin</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  subtreeRoot: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  root: FiberRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  committedLanes: Lanes,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> isModernRoot = (subtreeRoot.mode &amp; ConcurrentMode) !== NoMode;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 循环触发</span></span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// HostFiber</span></span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect;</span><br><span class="line">    <span class="comment">// fun App组件节点</span></span><br><span class="line">    <span class="keyword">const</span> firstChild = fiber.child;</span><br><span class="line"></span><br><span class="line">    # 说明子树存在副作用，需要更新nextEffect为子节点，进入下一级的循环</span><br><span class="line">    <span class="keyword">if</span> ((fiber.subtreeFlags &amp; LayoutMask) !== NoFlags &amp;&amp; firstChild !== <span class="literal">null</span>) &#123;</span><br><span class="line">      firstChild.return = fiber;</span><br><span class="line">      nextEffect = firstChild;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      # 说明副作用在自身节点了，进入complete阶段</span><br><span class="line">      commitLayoutMountEffects_complete(subtreeRoot, root, committedLanes);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-4-5-2-commitLayoutMountEffects-complete"><a href="#2-4-5-2-commitLayoutMountEffects-complete" class="headerlink" title="2.4.5.2 commitLayoutMountEffects_complete"></a>2.4.5.2 commitLayoutMountEffects_complete</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitLayoutMountEffects_complete</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  subtreeRoot: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  root: FiberRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  committedLanes: Lanes,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// while循环</span></span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect;</span><br><span class="line">    <span class="comment">// 存在layout相关的副作用 才会进入</span></span><br><span class="line">    <span class="keyword">if</span> ((fiber.flags &amp; LayoutMask) !== NoFlags) &#123;</span><br><span class="line">      <span class="keyword">const</span> current = fiber.alternate;</span><br><span class="line">      setCurrentDebugFiberInDEV(fiber);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        # 执行副作用</span><br><span class="line">        commitLayoutEffectOnFiber(root, current, fiber, committedLanes);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        captureCommitPhaseError(fiber, fiber.return, error);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # 当回到HostFiber时，代表循环完成，退出layout工作</span><br><span class="line">    <span class="keyword">if</span> (fiber === subtreeRoot) &#123;</span><br><span class="line">      nextEffect = <span class="literal">null</span>;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # 存在兄弟节点，开始兄弟节点的工作</span><br><span class="line">    <span class="keyword">const</span> sibling = fiber.sibling;</span><br><span class="line">    <span class="keyword">if</span> (sibling !== <span class="literal">null</span>) &#123;</span><br><span class="line">      sibling.return = fiber.return;</span><br><span class="line">      nextEffect = sibling;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	# 不存在兄弟节点，则返回父级节点</span><br><span class="line">    nextEffect = fiber.return;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-4-5-3-commitLayoutEffectOnFiber"><a href="#2-4-5-3-commitLayoutEffectOnFiber" class="headerlink" title="2.4.5.3 commitLayoutEffectOnFiber"></a>2.4.5.3 commitLayoutEffectOnFiber</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitLayoutEffectOnFiber</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  finishedRoot: FiberRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  current: Fiber | null,</span></span></span><br><span class="line"><span class="function"><span class="params">  finishedWork: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  committedLanes: Lanes,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ((finishedWork.flags &amp; LayoutMask) !== NoFlags) &#123;</span><br><span class="line">    # 根据组件类型：进行不同的处理</span><br><span class="line">    <span class="keyword">switch</span> (finishedWork.tag) &#123;</span><br><span class="line">      # 1，函数组件的处理</span><br><span class="line">      <span class="keyword">case</span> FunctionComponent:</span><br><span class="line">      <span class="keyword">case</span> ForwardRef:</span><br><span class="line">      <span class="keyword">case</span> SimpleMemoComponent: &#123;</span><br><span class="line">        <span class="keyword">if</span> (!enableSuspenseLayoutEffectSemantics || !offscreenSubtreeWasHidden) &#123;</span><br><span class="line">          <span class="comment">// 处理副作用</span></span><br><span class="line">          commitHookEffectListMount(HookLayout | HookHasEffect, finishedWork);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      # 2，类组件的处理</span><br><span class="line">      <span class="keyword">case</span> ClassComponent: &#123;</span><br><span class="line">        <span class="comment">// 组件实例</span></span><br><span class="line">        <span class="keyword">const</span> instance = finishedWork.stateNode;</span><br><span class="line">        <span class="keyword">if</span> (finishedWork.flags &amp; Update) &#123;</span><br><span class="line">          <span class="keyword">if</span> (!offscreenSubtreeWasHidden) &#123;</span><br><span class="line">            <span class="keyword">if</span> (current === <span class="literal">null</span>) &#123;</span><br><span class="line">			  <span class="comment">// mount加载阶段</span></span><br><span class="line"></span><br><span class="line">              # 触发componentDidMount 生命周期钩子函数【这类静态方法：是存储在instance对象原型上的】</span><br><span class="line">              instance.componentDidMount();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">              <span class="comment">// update更新阶段</span></span><br><span class="line">              <span class="keyword">const</span> prevProps = finishedWork.elementType === finishedWork.type ? current.memoizedProps</span><br><span class="line">                  : resolveDefaultProps( finishedWork.type, current.memoizedProps);</span><br><span class="line">              <span class="keyword">const</span> prevState = current.memoizedState;</span><br><span class="line">			  # 触发componentDidUpdate 生命周期钩子函数</span><br><span class="line">              instance.componentDidUpdate( prevProps,prevState,</span><br><span class="line">                  instance.__reactInternalSnapshotBeforeUpdate,</span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        # 取出当前组件节点的updateQueue更新对象</span><br><span class="line">        <span class="keyword">const</span> updateQueue: UpdateQueue = finishedWork.updateQueue;</span><br><span class="line">        <span class="keyword">if</span> (updateQueue !== <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="comment">// 触发更新</span></span><br><span class="line">          commitUpdateQueue(finishedWork, updateQueue, instance);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> HostRoot: &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> I think this is now always non-null by the time it reaches the</span></span><br><span class="line">        <span class="comment">// commit phase. Consider removing the type check.</span></span><br><span class="line">        <span class="keyword">const</span> updateQueue: UpdateQueue = finishedWork.updateQueue;</span><br><span class="line">        <span class="keyword">if</span> (updateQueue !== <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">let</span> instance = <span class="literal">null</span>;</span><br><span class="line">          <span class="keyword">if</span> (finishedWork.child !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">switch</span> (finishedWork.child.tag) &#123;</span><br><span class="line">              <span class="keyword">case</span> HostComponent:</span><br><span class="line">                instance = getPublicInstance(finishedWork.child.stateNode);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">              <span class="keyword">case</span> ClassComponent:</span><br><span class="line">                instance = finishedWork.child.stateNode;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// 触发更新</span></span><br><span class="line">          commitUpdateQueue(finishedWork, updateQueue, instance);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> HostComponent: &#123;</span><br><span class="line">        <span class="comment">// 取出DOM对象</span></span><br><span class="line">        <span class="keyword">const</span> instance: Instance = finishedWork.stateNode;</span><br><span class="line">        <span class="keyword">if</span> (current === <span class="literal">null</span> &amp;&amp; finishedWork.flags &amp; Update) &#123;</span><br><span class="line">          <span class="keyword">const</span> type = finishedWork.type;</span><br><span class="line">          <span class="keyword">const</span> props = finishedWork.memoizedProps;</span><br><span class="line">          # 针对一些特殊的DOM元素做加载处理：button,input等做自动聚焦，对Img图片做加载</span><br><span class="line">          commitMount(instance, type, props, finishedWork);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      ...</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>commitLayoutEffectOnFiber</code> 方法依然是和前面两个阶段的逻辑一样，根据不同的组件节点进行不同的逻辑处理，这里我们还是理解几个重点组件类型即可。</p>
<ul>
<li><p>函数组件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">commitHookEffectListMount(HookLayout | HookHasEffect, finishedWork);</span><br></pre></td></tr></table></figure>
<p>同步执行当前函数组件节点的useLayoutEffect 回调。</p>
</li>
<li><p>类组件<br>根据当前Fiber节点是否存在current【旧的Fiber】来区分是mount阶段还是update阶段：</p>
<ul>
<li>mount阶段：执行当前类组件的componentDidMount生命周期钩子函数。</li>
<li>update阶段：执行当前类组件的componentDidUpdate生命周期钩子函数。</li>
</ul>
</li>
</ul>
<h5 id="layout阶段总结"><a href="#layout阶段总结" class="headerlink" title="layout阶段总结"></a>layout阶段总结</h5><p>在真实DOM加载完成后：</p>
<ul>
<li>执行函数组件的useLayoutEffect hook的回调。</li>
<li>类组件执⾏ componentDidMount 或者 componentDidUpdate。。</li>
<li>由此可⻅，函数组件的 effects 和类组件中⽣命周期执⾏时机是不同的</li>
</ul>
<h3 id="FiberTree的切换"><a href="#FiberTree的切换" class="headerlink" title="FiberTree的切换"></a>FiberTree的切换</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 2，Mutation阶段</span></span><br><span class="line">commitMutationEffects(root, finishedWork, lanes);</span><br><span class="line"># FiberTree的切换</span><br><span class="line">root.current = finishedWork;</span><br><span class="line"><span class="comment">// 3, Layout阶段</span></span><br><span class="line">commitLayoutEffects(finishedWork, root, lanes);</span><br></pre></td></tr></table></figure>

<p>在 <code>Mutation</code> 阶段和 <code>Layout</code> 阶段之间还有一个重要处理没有说明，那就是 <code>FiberTree</code> 的切换。</p>
<p>通过前面我们已经知道，<code>Mutation</code> 阶段处理完成之后，页面就已经完成了真实的 <code>DOM</code> 渲染。所以此时<code>finishedWork</code> 就是最新的 <code>FiberTree</code> 以及存储着最新的 <code>DOM</code> 内容，在这里更新 <code>current</code> 的内容，主要有两个方面的作用：</p>
<ul>
<li>保留最新的 <code>Fiber</code> 树结构，在下一次更新时就可以利用本次的 <code>FiberTree</code> 来做数据的复用以及差异对比。</li>
<li>对于类组件来说：当在 <code>Layout</code> 阶段执行 <code>componentDidMount</code> 或者 <code>componentDidUpdate</code> 生命周期钩子时就可以获取最新的 <code>DOM</code> 内容。</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>到此为止，react18.2源码解析最重要的内容：即一个react应用的基本加载流程算是解析完成了，虽然其中一些逻辑描述可能不够准确，但整体来说还是比较符合。当然其中也有一些逻辑的细节并没有展开讲解，这是因为本身应用的加载流程就已经比较复杂了，如果在解析过程中每个逻辑都放在一起讲解，那文章的内容可能翻倍不止，阅读效果也会大打折扣。所以关于一些细节方面的逻辑处理会在新的章节里面展开讲解，比如类组件，函数组件的具体加载过程、hooks原理、合成事件等等。</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/react18-2/" rel="tag"># react18.2</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/zh-CN/react%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%88%E4%B8%89%EF%BC%89render-render%E9%98%B6%E6%AE%B5.html" rel="prev" title="react18.2源码分析（三）render-render阶段">
      <i class="fa fa-chevron-left"></i> react18.2源码分析（三）render-render阶段
    </a></div>
      <div class="post-nav-item">
    <a href="/zh-CN/react%E8%B0%83%E5%BA%A6%E5%99%A8scheduler%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html" rel="next" title="react18.2调度器scheduler源码分析">
      react18.2调度器scheduler源码分析 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-commit阶段-finishConcurrentRender"><span class="nav-number">1.</span> <span class="nav-text">2. commit阶段 - finishConcurrentRender</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-finishConcurrentRender"><span class="nav-number">1.1.</span> <span class="nav-text">2.1 finishConcurrentRender</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-commitRootWhenReady"><span class="nav-number">1.2.</span> <span class="nav-text">2.2 commitRootWhenReady</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-commitRoot"><span class="nav-number">1.3.</span> <span class="nav-text">2.3 commitRoot</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-commitRootImpl"><span class="nav-number">1.4.</span> <span class="nav-text">2.4 commitRootImpl</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-1-异步执行-passive-effects"><span class="nav-number">1.4.1.</span> <span class="nav-text">2.4.1 异步执行 passive effects</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-2-进入-commit-阶段"><span class="nav-number">1.4.2.</span> <span class="nav-text">2.4.2 进入 commit 阶段</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-3-beforeMutation阶段-commitBeforeMutationEffects"><span class="nav-number">1.4.3.</span> <span class="nav-text">2.4.3 beforeMutation阶段 - commitBeforeMutationEffects</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#2-4-3-1-commitBeforeMutationEffects-begin"><span class="nav-number">1.4.3.1.</span> <span class="nav-text">2.4.3.1 commitBeforeMutationEffects_begin</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-4-3-2-commitBeforeMutationEffects-complete"><span class="nav-number">1.4.3.2.</span> <span class="nav-text">2.4.3.2 commitBeforeMutationEffects_complete</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-4-3-3-commitBeforeMutationEffectsOnFiber"><span class="nav-number">1.4.3.3.</span> <span class="nav-text">2.4.3.3 commitBeforeMutationEffectsOnFiber</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-4-3-4-BeforeMutation阶段总结"><span class="nav-number">1.4.3.4.</span> <span class="nav-text">2.4.3.4 BeforeMutation阶段总结</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-4-mutation-阶段-commitMutationEffects"><span class="nav-number">1.4.4.</span> <span class="nav-text">2.4.4 mutation 阶段 - commitMutationEffects</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#2-4-4-1-commitMutationEffectsOnFiber"><span class="nav-number">1.4.4.1.</span> <span class="nav-text">2.4.4.1 commitMutationEffectsOnFiber</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-4-4-2-Mutation阶段执行顺序"><span class="nav-number">1.4.4.2.</span> <span class="nav-text">2.4.4.2 Mutation阶段执行顺序</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-4-4-3-recursivelyTraverseMutationEffects"><span class="nav-number">1.4.4.3.</span> <span class="nav-text">2.4.4.3 recursivelyTraverseMutationEffects</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-4-4-4-commitReconciliationEffects"><span class="nav-number">1.4.4.4.</span> <span class="nav-text">2.4.4.4 commitReconciliationEffects</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-4-4-5-commitPlacement"><span class="nav-number">1.4.4.5.</span> <span class="nav-text">2.4.4.5 commitPlacement</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#mutation阶段总结"><span class="nav-number">1.4.4.6.</span> <span class="nav-text">mutation阶段总结</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-5-layout-阶段-commitLayoutEffects"><span class="nav-number">1.4.5.</span> <span class="nav-text">2.4.5 layout 阶段 - commitLayoutEffects</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#2-4-5-1-commitLayoutEffects-begin"><span class="nav-number">1.4.5.1.</span> <span class="nav-text">2.4.5.1 commitLayoutEffects_begin</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-4-5-2-commitLayoutMountEffects-complete"><span class="nav-number">1.4.5.2.</span> <span class="nav-text">2.4.5.2 commitLayoutMountEffects_complete</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-4-5-3-commitLayoutEffectOnFiber"><span class="nav-number">1.4.5.3.</span> <span class="nav-text">2.4.5.3 commitLayoutEffectOnFiber</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#layout阶段总结"><span class="nav-number">1.4.5.4.</span> <span class="nav-text">layout阶段总结</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#FiberTree的切换"><span class="nav-number">1.5.</span> <span class="nav-text">FiberTree的切换</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">2.</span> <span class="nav-text">总结</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="rile"
      src="/images/IMG_2044.jpg">
  <p class="site-author-name" itemprop="name">rile</p>
  <div class="site-description" itemprop="description">FE</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">42</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Rile14929" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Rile14929" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:rile14929@163.com" title="E-Mail → mailto:rile14929@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2020 – 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-rocket"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">rile</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
