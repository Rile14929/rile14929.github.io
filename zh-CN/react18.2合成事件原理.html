<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"rile14929.github.io","root":"/","scheme":"Pisces","version":"7.7.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="事件注册注册事件名12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697989910">
<meta property="og:type" content="article">
<meta property="og:title" content="react18.2合成事件原理">
<meta property="og:url" content="https://rile14929.github.io/zh-CN/react18.2%E5%90%88%E6%88%90%E4%BA%8B%E4%BB%B6%E5%8E%9F%E7%90%86.html">
<meta property="og:site_name" content="右耳听风">
<meta property="og:description" content="事件注册注册事件名12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697989910">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-01-07T16:00:00.000Z">
<meta property="article:modified_time" content="2025-01-07T16:00:00.000Z">
<meta property="article:author" content="rile">
<meta property="article:tag" content="react18.2">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://rile14929.github.io/zh-CN/react18.2%E5%90%88%E6%88%90%E4%BA%8B%E4%BB%B6%E5%8E%9F%E7%90%86.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>react18.2合成事件原理 | 右耳听风</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">右耳听风</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tag"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://rile14929.github.io/zh-CN/react18.2%E5%90%88%E6%88%90%E4%BA%8B%E4%BB%B6%E5%8E%9F%E7%90%86.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/Trevor.jpeg">
      <meta itemprop="name" content="rile">
      <meta itemprop="description" content="FE">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="右耳听风">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          react18.2合成事件原理
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2025-01-08 00:00:00" itemprop="dateCreated datePublished" datetime="2025-01-08T00:00:00+08:00">2025-01-08</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="事件注册"><a href="#事件注册" class="headerlink" title="事件注册"></a>事件注册</h2><h3 id="注册事件名"><a href="#注册事件名" class="headerlink" title="注册事件名"></a>注册事件名</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// \react-dom-bindings\src\events\DOMEventNames.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> getVendorPrefixedEventName <span class="keyword">from</span> <span class="string">'./getVendorPrefixedEventName'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> type DOMEventName =</span><br><span class="line">  | <span class="string">'abort'</span></span><br><span class="line">  | <span class="string">'afterblur'</span> <span class="comment">// Not a real event. This is used by event experiments.</span></span><br><span class="line">  <span class="comment">// These are vendor-prefixed so you should use the exported constants instead:</span></span><br><span class="line">  <span class="comment">// 'animationiteration' |</span></span><br><span class="line">  <span class="comment">// 'animationend |</span></span><br><span class="line">  <span class="comment">// 'animationstart' |</span></span><br><span class="line">  | <span class="string">'beforeblur'</span> <span class="comment">// Not a real event. This is used by event experiments.</span></span><br><span class="line">  | <span class="string">'beforeinput'</span></span><br><span class="line">  | <span class="string">'blur'</span></span><br><span class="line">  | <span class="string">'canplay'</span></span><br><span class="line">  | <span class="string">'canplaythrough'</span></span><br><span class="line">  | <span class="string">'cancel'</span></span><br><span class="line">  | <span class="string">'change'</span></span><br><span class="line">  | <span class="string">'click'</span></span><br><span class="line">  | <span class="string">'close'</span></span><br><span class="line">  | <span class="string">'compositionend'</span></span><br><span class="line">  | <span class="string">'compositionstart'</span></span><br><span class="line">  | <span class="string">'compositionupdate'</span></span><br><span class="line">  | <span class="string">'contextmenu'</span></span><br><span class="line">  | <span class="string">'copy'</span></span><br><span class="line">  | <span class="string">'cut'</span></span><br><span class="line">  | <span class="string">'dblclick'</span></span><br><span class="line">  | <span class="string">'auxclick'</span></span><br><span class="line">  | <span class="string">'drag'</span></span><br><span class="line">  | <span class="string">'dragend'</span></span><br><span class="line">  | <span class="string">'dragenter'</span></span><br><span class="line">  | <span class="string">'dragexit'</span></span><br><span class="line">  | <span class="string">'dragleave'</span></span><br><span class="line">  | <span class="string">'dragover'</span></span><br><span class="line">  | <span class="string">'dragstart'</span></span><br><span class="line">  | <span class="string">'drop'</span></span><br><span class="line">  | <span class="string">'durationchange'</span></span><br><span class="line">  | <span class="string">'emptied'</span></span><br><span class="line">  | <span class="string">'encrypted'</span></span><br><span class="line">  | <span class="string">'ended'</span></span><br><span class="line">  | <span class="string">'error'</span></span><br><span class="line">  | <span class="string">'focus'</span></span><br><span class="line">  | <span class="string">'focusin'</span></span><br><span class="line">  | <span class="string">'focusout'</span></span><br><span class="line">  | <span class="string">'fullscreenchange'</span></span><br><span class="line">  | <span class="string">'gotpointercapture'</span></span><br><span class="line">  | <span class="string">'hashchange'</span></span><br><span class="line">  | <span class="string">'input'</span></span><br><span class="line">  | <span class="string">'invalid'</span></span><br><span class="line">  | <span class="string">'keydown'</span></span><br><span class="line">  | <span class="string">'keypress'</span></span><br><span class="line">  | <span class="string">'keyup'</span></span><br><span class="line">  | <span class="string">'load'</span></span><br><span class="line">  | <span class="string">'loadstart'</span></span><br><span class="line">  | <span class="string">'loadeddata'</span></span><br><span class="line">  | <span class="string">'loadedmetadata'</span></span><br><span class="line">  | <span class="string">'lostpointercapture'</span></span><br><span class="line">  | <span class="string">'message'</span></span><br><span class="line">  | <span class="string">'mousedown'</span></span><br><span class="line">  | <span class="string">'mouseenter'</span></span><br><span class="line">  | <span class="string">'mouseleave'</span></span><br><span class="line">  | <span class="string">'mousemove'</span></span><br><span class="line">  | <span class="string">'mouseout'</span></span><br><span class="line">  | <span class="string">'mouseover'</span></span><br><span class="line">  | <span class="string">'mouseup'</span></span><br><span class="line">  | <span class="string">'paste'</span></span><br><span class="line">  | <span class="string">'pause'</span></span><br><span class="line">  | <span class="string">'play'</span></span><br><span class="line">  | <span class="string">'playing'</span></span><br><span class="line">  | <span class="string">'pointercancel'</span></span><br><span class="line">  | <span class="string">'pointerdown'</span></span><br><span class="line">  | <span class="string">'pointerenter'</span></span><br><span class="line">  | <span class="string">'pointerleave'</span></span><br><span class="line">  | <span class="string">'pointermove'</span></span><br><span class="line">  | <span class="string">'pointerout'</span></span><br><span class="line">  | <span class="string">'pointerover'</span></span><br><span class="line">  | <span class="string">'pointerup'</span></span><br><span class="line">  | <span class="string">'popstate'</span></span><br><span class="line">  | <span class="string">'progress'</span></span><br><span class="line">  | <span class="string">'ratechange'</span></span><br><span class="line">  | <span class="string">'reset'</span></span><br><span class="line">  | <span class="string">'resize'</span></span><br><span class="line">  | <span class="string">'scroll'</span></span><br><span class="line">  | <span class="string">'scrollend'</span></span><br><span class="line">  | <span class="string">'seeked'</span></span><br><span class="line">  | <span class="string">'seeking'</span></span><br><span class="line">  | <span class="string">'select'</span></span><br><span class="line">  | <span class="string">'selectstart'</span></span><br><span class="line">  | <span class="string">'selectionchange'</span></span><br><span class="line">  | <span class="string">'stalled'</span></span><br><span class="line">  | <span class="string">'submit'</span></span><br><span class="line">  | <span class="string">'suspend'</span></span><br><span class="line">  | <span class="string">'textInput'</span> <span class="comment">// Intentionally camelCase. Non-standard.</span></span><br><span class="line">  | <span class="string">'timeupdate'</span></span><br><span class="line">  | <span class="string">'toggle'</span></span><br><span class="line">  | <span class="string">'touchcancel'</span></span><br><span class="line">  | <span class="string">'touchend'</span></span><br><span class="line">  | <span class="string">'touchmove'</span></span><br><span class="line">  | <span class="string">'touchstart'</span></span><br><span class="line">  <span class="comment">// These are vendor-prefixed so you should use the exported constants instead:</span></span><br><span class="line">  <span class="comment">// 'transitionend' |</span></span><br><span class="line">  | <span class="string">'volumechange'</span></span><br><span class="line">  | <span class="string">'waiting'</span></span><br><span class="line">  | <span class="string">'wheel'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> ANIMATION_END: DOMEventName =</span><br><span class="line">  getVendorPrefixedEventName(<span class="string">'animationend'</span>);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> ANIMATION_ITERATION: DOMEventName =</span><br><span class="line">  getVendorPrefixedEventName(<span class="string">'animationiteration'</span>);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> ANIMATION_START: DOMEventName =</span><br><span class="line">  getVendorPrefixedEventName(<span class="string">'animationstart'</span>);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> TRANSITION_END: DOMEventName =</span><br><span class="line">  getVendorPrefixedEventName(<span class="string">'transitionend'</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// \react-dom-bindings\src\events\EventRegistry.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// React中的事件</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> allNativeEvents: <span class="built_in">Set</span>&lt;DOMEventName&gt; = <span class="keyword">new</span> <span class="built_in">Set</span>();</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> registrationNameDependencies: &#123;</span><br><span class="line">    [registrationName: string]: <span class="built_in">Array</span>&lt;DOMEventName&gt;,</span><br><span class="line">&#125; = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 事件注册</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">registerTwoPhaseEvent</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    registrationName: string,</span></span></span><br><span class="line"><span class="function"><span class="params">    dependencies: Array&lt;DOMEventName&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">    registerDirectEvent(registrationName, dependencies);</span><br><span class="line">    registerDirectEvent(registrationName + <span class="string">'Capture'</span>, dependencies);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">registerDirectEvent</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    registrationName: string,</span></span></span><br><span class="line"><span class="function"><span class="params">    dependencies: Array&lt;DOMEventName&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">    registrationNameDependencies[registrationName] = dependencies;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; dependencies.length; i++) &#123;</span><br><span class="line">        allNativeEvents.add(dependencies[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="不同类型的事件注册"><a href="#不同类型的事件注册" class="headerlink" title="不同类型的事件注册"></a>不同类型的事件注册</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// \react-dom-bindings\src\events\DOMPluginEventSystem.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> BeforeInputEventPlugin <span class="keyword">from</span> <span class="string">'./plugins/BeforeInputEventPlugin'</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> ChangeEventPlugin <span class="keyword">from</span> <span class="string">'./plugins/ChangeEventPlugin'</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> EnterLeaveEventPlugin <span class="keyword">from</span> <span class="string">'./plugins/EnterLeaveEventPlugin'</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> SelectEventPlugin <span class="keyword">from</span> <span class="string">'./plugins/SelectEventPlugin'</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> SimpleEventPlugin <span class="keyword">from</span> <span class="string">'./plugins/SimpleEventPlugin'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ! 注册事件</span></span><br><span class="line">SimpleEventPlugin.registerEvents();</span><br><span class="line">EnterLeaveEventPlugin.registerEvents();</span><br><span class="line">ChangeEventPlugin.registerEvents();</span><br><span class="line">SelectEventPlugin.registerEvents();</span><br><span class="line">BeforeInputEventPlugin.registerEvents();</span><br></pre></td></tr></table></figure>

<h4 id="SimpleEventPlugin"><a href="#SimpleEventPlugin" class="headerlink" title="SimpleEventPlugin"></a>SimpleEventPlugin</h4><p>普通事件，如 click、drag、drop 等。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// \react-dom-bindings\src\events\plugins\SimpleEventPlugin.js</span></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  registerSimpleEvents,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'../DOMEventProperties'</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// \react-dom-bindings\src\events\DOMEventProperties.js</span></span><br><span class="line"><span class="keyword">const</span> simpleEventPluginEvents = [</span><br><span class="line">  <span class="string">'abort'</span>,</span><br><span class="line">  <span class="string">'auxClick'</span>,</span><br><span class="line">  <span class="string">'cancel'</span>,</span><br><span class="line">  <span class="string">'canPlay'</span>,</span><br><span class="line">  <span class="string">'canPlayThrough'</span>,</span><br><span class="line">  <span class="string">'click'</span>,</span><br><span class="line">  <span class="string">'close'</span>,</span><br><span class="line">  <span class="string">'contextMenu'</span>,</span><br><span class="line">  <span class="string">'copy'</span>,</span><br><span class="line">  <span class="string">'cut'</span>,</span><br><span class="line">  <span class="string">'drag'</span>,</span><br><span class="line">  <span class="string">'dragEnd'</span>,</span><br><span class="line">  <span class="string">'dragEnter'</span>,</span><br><span class="line">  <span class="string">'dragExit'</span>,</span><br><span class="line">  <span class="string">'dragLeave'</span>,</span><br><span class="line">  <span class="string">'dragOver'</span>,</span><br><span class="line">  <span class="string">'dragStart'</span>,</span><br><span class="line">  <span class="string">'drop'</span>,</span><br><span class="line">  <span class="string">'durationChange'</span>,</span><br><span class="line">  <span class="string">'emptied'</span>,</span><br><span class="line">  <span class="string">'encrypted'</span>,</span><br><span class="line">  <span class="string">'ended'</span>,</span><br><span class="line">  <span class="string">'error'</span>,</span><br><span class="line">  <span class="string">'gotPointerCapture'</span>,</span><br><span class="line">  <span class="string">'input'</span>,</span><br><span class="line">  <span class="string">'invalid'</span>,</span><br><span class="line">  <span class="string">'keyDown'</span>,</span><br><span class="line">  <span class="string">'keyPress'</span>,</span><br><span class="line">  <span class="string">'keyUp'</span>,</span><br><span class="line">  <span class="string">'load'</span>,</span><br><span class="line">  <span class="string">'loadedData'</span>,</span><br><span class="line">  <span class="string">'loadedMetadata'</span>,</span><br><span class="line">  <span class="string">'loadStart'</span>,</span><br><span class="line">  <span class="string">'lostPointerCapture'</span>,</span><br><span class="line">  <span class="string">'mouseDown'</span>,</span><br><span class="line">  <span class="string">'mouseMove'</span>,</span><br><span class="line">  <span class="string">'mouseOut'</span>,</span><br><span class="line">  <span class="string">'mouseOver'</span>,</span><br><span class="line">  <span class="string">'mouseUp'</span>,</span><br><span class="line">  <span class="string">'paste'</span>,</span><br><span class="line">  <span class="string">'pause'</span>,</span><br><span class="line">  <span class="string">'play'</span>,</span><br><span class="line">  <span class="string">'playing'</span>,</span><br><span class="line">  <span class="string">'pointerCancel'</span>,</span><br><span class="line">  <span class="string">'pointerDown'</span>,</span><br><span class="line">  <span class="string">'pointerMove'</span>,</span><br><span class="line">  <span class="string">'pointerOut'</span>,</span><br><span class="line">  <span class="string">'pointerOver'</span>,</span><br><span class="line">  <span class="string">'pointerUp'</span>,</span><br><span class="line">  <span class="string">'progress'</span>,</span><br><span class="line">  <span class="string">'rateChange'</span>,</span><br><span class="line">  <span class="string">'reset'</span>,</span><br><span class="line">  <span class="string">'resize'</span>,</span><br><span class="line">  <span class="string">'seeked'</span>,</span><br><span class="line">  <span class="string">'seeking'</span>,</span><br><span class="line">  <span class="string">'stalled'</span>,</span><br><span class="line">  <span class="string">'submit'</span>,</span><br><span class="line">  <span class="string">'suspend'</span>,</span><br><span class="line">  <span class="string">'timeUpdate'</span>,</span><br><span class="line">  <span class="string">'touchCancel'</span>,</span><br><span class="line">  <span class="string">'touchEnd'</span>,</span><br><span class="line">  <span class="string">'touchStart'</span>,</span><br><span class="line">  <span class="string">'volumeChange'</span>,</span><br><span class="line">  <span class="string">'scroll'</span>,</span><br><span class="line">  <span class="string">'scrollEnd'</span>,</span><br><span class="line">  <span class="string">'toggle'</span>,</span><br><span class="line">  <span class="string">'touchMove'</span>,</span><br><span class="line">  <span class="string">'waiting'</span>,</span><br><span class="line">  <span class="string">'wheel'</span>,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">registerSimpleEvent</span>(<span class="params">domEventName: DOMEventName, reactName: string</span>) </span>&#123;</span><br><span class="line">  topLevelEventsToReactNames.set(domEventName, reactName);</span><br><span class="line">  registerTwoPhaseEvent(reactName, [domEventName]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">registerSimpleEvents</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; simpleEventPluginEvents.length; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> eventName = ((simpleEventPluginEvents[i]: any): string);</span><br><span class="line">    <span class="keyword">const</span> domEventName = ((eventName.toLowerCase(): any): DOMEventName);</span><br><span class="line">    <span class="keyword">const</span> capitalizedEvent = eventName[<span class="number">0</span>].toUpperCase() + eventName.slice(<span class="number">1</span>);</span><br><span class="line">    registerSimpleEvent(domEventName, <span class="string">'on'</span> + capitalizedEvent);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Special cases where event names don't match.</span></span><br><span class="line">  registerSimpleEvent(ANIMATION_END, <span class="string">'onAnimationEnd'</span>);</span><br><span class="line">  registerSimpleEvent(ANIMATION_ITERATION, <span class="string">'onAnimationIteration'</span>);</span><br><span class="line">  registerSimpleEvent(ANIMATION_START, <span class="string">'onAnimationStart'</span>);</span><br><span class="line">  registerSimpleEvent(<span class="string">'dblclick'</span>, <span class="string">'onDoubleClick'</span>);</span><br><span class="line">  registerSimpleEvent(<span class="string">'focusin'</span>, <span class="string">'onFocus'</span>);</span><br><span class="line">  registerSimpleEvent(<span class="string">'focusout'</span>, <span class="string">'onBlur'</span>);</span><br><span class="line">  registerSimpleEvent(TRANSITION_END, <span class="string">'onTransitionEnd'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="EnterLeaveEventPlugin"><a href="#EnterLeaveEventPlugin" class="headerlink" title="EnterLeaveEventPlugin"></a>EnterLeaveEventPlugin</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// \react-dom-bindings\src\events\plugins\EnterLeaveEventPlugin.js</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">registerEvents</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  registerDirectEvent(<span class="string">'onMouseEnter'</span>, [<span class="string">'mouseout'</span>, <span class="string">'mouseover'</span>]);</span><br><span class="line">  registerDirectEvent(<span class="string">'onMouseLeave'</span>, [<span class="string">'mouseout'</span>, <span class="string">'mouseover'</span>]);</span><br><span class="line">  registerDirectEvent(<span class="string">'onPointerEnter'</span>, [<span class="string">'pointerout'</span>, <span class="string">'pointerover'</span>]);</span><br><span class="line">  registerDirectEvent(<span class="string">'onPointerLeave'</span>, [<span class="string">'pointerout'</span>, <span class="string">'pointerover'</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ChangeEventPlugin"><a href="#ChangeEventPlugin" class="headerlink" title="ChangeEventPlugin"></a>ChangeEventPlugin</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// \react-dom-bindings\src\events\plugins\ChangeEventPlugin.js</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">registerEvents</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  registerTwoPhaseEvent(<span class="string">'onChange'</span>, [</span><br><span class="line">    <span class="string">'change'</span>,</span><br><span class="line">    <span class="string">'click'</span>,</span><br><span class="line">    <span class="string">'focusin'</span>,</span><br><span class="line">    <span class="string">'focusout'</span>,</span><br><span class="line">    <span class="string">'input'</span>,</span><br><span class="line">    <span class="string">'keydown'</span>,</span><br><span class="line">    <span class="string">'keyup'</span>,</span><br><span class="line">    <span class="string">'selectionchange'</span>,</span><br><span class="line">  ]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="SelectEventPlugin"><a href="#SelectEventPlugin" class="headerlink" title="SelectEventPlugin"></a>SelectEventPlugin</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// \react-dom-bindings\src\events\plugins\SelectEventPlugin.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">registerEvents</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  registerTwoPhaseEvent(<span class="string">'onSelect'</span>, [</span><br><span class="line">    <span class="string">'focusout'</span>,</span><br><span class="line">    <span class="string">'contextmenu'</span>,</span><br><span class="line">    <span class="string">'dragend'</span>,</span><br><span class="line">    <span class="string">'focusin'</span>,</span><br><span class="line">    <span class="string">'keydown'</span>,</span><br><span class="line">    <span class="string">'keyup'</span>,</span><br><span class="line">    <span class="string">'mousedown'</span>,</span><br><span class="line">    <span class="string">'mouseup'</span>,</span><br><span class="line">    <span class="string">'selectionchange'</span>,</span><br><span class="line">  ]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="BeforeInputEventPlugin"><a href="#BeforeInputEventPlugin" class="headerlink" title="BeforeInputEventPlugin"></a>BeforeInputEventPlugin</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// \react-dom-bindings\src\events\plugins\BeforeInputEventPlugin.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">registerEvents</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  registerTwoPhaseEvent(<span class="string">'onBeforeInput'</span>, [</span><br><span class="line">    <span class="string">'compositionend'</span>,</span><br><span class="line">    <span class="string">'keypress'</span>,</span><br><span class="line">    <span class="string">'textInput'</span>,</span><br><span class="line">    <span class="string">'paste'</span>,</span><br><span class="line">  ]);</span><br><span class="line">  registerTwoPhaseEvent(<span class="string">'onCompositionEnd'</span>, [</span><br><span class="line">    <span class="string">'compositionend'</span>,</span><br><span class="line">    <span class="string">'focusout'</span>,</span><br><span class="line">    <span class="string">'keydown'</span>,</span><br><span class="line">    <span class="string">'keypress'</span>,</span><br><span class="line">    <span class="string">'keyup'</span>,</span><br><span class="line">    <span class="string">'mousedown'</span>,</span><br><span class="line">  ]);</span><br><span class="line">  registerTwoPhaseEvent(<span class="string">'onCompositionStart'</span>, [</span><br><span class="line">    <span class="string">'compositionstart'</span>,</span><br><span class="line">    <span class="string">'focusout'</span>,</span><br><span class="line">    <span class="string">'keydown'</span>,</span><br><span class="line">    <span class="string">'keypress'</span>,</span><br><span class="line">    <span class="string">'keyup'</span>,</span><br><span class="line">    <span class="string">'mousedown'</span>,</span><br><span class="line">  ]);</span><br><span class="line">  registerTwoPhaseEvent(<span class="string">'onCompositionUpdate'</span>, [</span><br><span class="line">    <span class="string">'compositionupdate'</span>,</span><br><span class="line">    <span class="string">'focusout'</span>,</span><br><span class="line">    <span class="string">'keydown'</span>,</span><br><span class="line">    <span class="string">'keypress'</span>,</span><br><span class="line">    <span class="string">'keyup'</span>,</span><br><span class="line">    <span class="string">'mousedown'</span>,</span><br><span class="line">  ]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="事件绑定-listenToAllSupportedEvents"><a href="#事件绑定-listenToAllSupportedEvents" class="headerlink" title="事件绑定 - listenToAllSupportedEvents"></a>事件绑定 - listenToAllSupportedEvents</h3><p>在 <code>React</code> 初始化渲染的时候，会调⽤函数 <code>listenToAllSupportedEvents</code> 来绑定事件。<code>listenAllSupportedEvents</code> 将事件注册在页面的根节点，也就是 <code>div#root</code>。</p>
<p>主要做了两件事情：</p>
<ul>
<li>为避免重复注册事件，在 <code>DOM</code> 上设置一个属性，如果有这个属性说明事件已经被注册了</li>
<li>遍历 <code>allNativeEvents</code>，调用 <code>listenToNativeEvent</code> 进行事件注册</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createRoot</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  container: Element | Document | DocumentFragment,</span></span></span><br><span class="line"><span class="function"><span class="params">  options?: CreateRootOptions,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">RootType</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// comment nodes 已弃用，这里是为了兼容FB老代码 https://github.com/facebook/react/pull/24110</span></span><br><span class="line">  <span class="keyword">const</span> rootContainerElement: Document | Element | DocumentFragment =</span><br><span class="line">    container.nodeType === COMMENT_NODE</span><br><span class="line">      ? (container.parentNode: any)</span><br><span class="line">      : container;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 事件绑定</span></span><br><span class="line">  listenToAllSupportedEvents(rootContainerElement);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> ReactDOMRoot(root);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// \react-dom-bindings\src\events\DOMPluginEventSystem.js</span></span><br><span class="line"><span class="comment">// 事件绑定</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">listenToAllSupportedEvents</span>(<span class="params">rootContainerElement: EventTarget</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!(rootContainerElement: any)[listeningMarker]) &#123;</span><br><span class="line">    <span class="comment">// sy 防止重复绑定</span></span><br><span class="line">    (rootContainerElement: any)[listeningMarker] = <span class="literal">true</span>;</span><br><span class="line">    allNativeEvents.forEach(<span class="function"><span class="params">domEventName</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// We handle selectionchange separately because it</span></span><br><span class="line">      <span class="comment">// doesn't bubble and needs to be on the document.</span></span><br><span class="line">      <span class="comment">// 单独处理selectionchange事件，因为它不会冒泡，需要在文档上处理。</span></span><br><span class="line">      <span class="keyword">if</span> (domEventName !== <span class="string">'selectionchange'</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!nonDelegatedEvents.has(domEventName)) &#123;</span><br><span class="line">          <span class="comment">// ! 这些事件都是委托在rootContainerElement上的</span></span><br><span class="line">          <span class="comment">// nonDelegatedEvents中都是不需要委托的事件，也就是不需要冒泡的，如cancel、close、invalid、load、scroll、scrollend、toggle等</span></span><br><span class="line">          listenToNativeEvent(domEventName, <span class="literal">false</span>, rootContainerElement);</span><br><span class="line">        &#125;</span><br><span class="line">        listenToNativeEvent(domEventName, <span class="literal">true</span>, rootContainerElement);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 单独处理selectionchange事件</span></span><br><span class="line">    <span class="keyword">const</span> ownerDocument =</span><br><span class="line">      (rootContainerElement: any).nodeType === DOCUMENT_NODE</span><br><span class="line">        ? rootContainerElement</span><br><span class="line">        : (rootContainerElement: any).ownerDocument;</span><br><span class="line">    <span class="keyword">if</span> (ownerDocument !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// The selectionchange event also needs deduplication</span></span><br><span class="line">      <span class="comment">// but it is attached to the document.</span></span><br><span class="line">      <span class="comment">// selectionchange事件也需要去重，但它附加在document上。</span></span><br><span class="line">      <span class="keyword">if</span> (!(ownerDocument: any)[listeningMarker]) &#123;</span><br><span class="line">        (ownerDocument: any)[listeningMarker] = <span class="literal">true</span>;</span><br><span class="line">        listenToNativeEvent(<span class="string">'selectionchange'</span>, <span class="literal">false</span>, ownerDocument);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// \react-dom-bindings\src\events\DOMPluginEventSystem.js</span></span><br><span class="line"><span class="comment">// We should not delegate these events to the container, but rather</span></span><br><span class="line"><span class="comment">// set them on the actual target element itself. This is primarily</span></span><br><span class="line"><span class="comment">// because these events do not consistently bubble in the DOM.</span></span><br><span class="line"><span class="comment">// 我们不应该将这些事件委托给容器，而是应该直接在实际的目标元素上设置它们。这主要是因为这些事件在DOM中的冒泡行为并不一致。</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> nonDelegatedEvents: <span class="built_in">Set</span>&lt;DOMEventName&gt; = <span class="keyword">new</span> <span class="built_in">Set</span>([</span><br><span class="line">  <span class="string">'cancel'</span>,</span><br><span class="line">  <span class="string">'close'</span>,</span><br><span class="line">  <span class="string">'invalid'</span>,</span><br><span class="line">  <span class="string">'load'</span>,</span><br><span class="line">  <span class="string">'scroll'</span>,</span><br><span class="line">  <span class="string">'scrollend'</span>,</span><br><span class="line">  <span class="string">'toggle'</span>,</span><br><span class="line">  <span class="comment">// In order to reduce bytes, we insert the above array of media events</span></span><br><span class="line">  <span class="comment">// into this Set. Note: the "error" event isn't an exclusive media event,</span></span><br><span class="line">  <span class="comment">// and can occur on other elements too. Rather than duplicate that event,</span></span><br><span class="line">  <span class="comment">// we just take it from the media events array.</span></span><br><span class="line">  <span class="comment">// 为了减少字节数，我们将上述媒体事件数组插入到这个 Set 中。</span></span><br><span class="line">  <span class="comment">// 注意："error" 事件并不是一个独占的媒体事件，也可能发生在其他元素上。我们不会重复这个事件，而是直接从媒体事件数组中取出。</span></span><br><span class="line">  ...mediaEventTypes,</span><br><span class="line">]);</span><br><span class="line"><span class="comment">// List of events that need to be individually attached to media elements.</span></span><br><span class="line"><span class="comment">// 需要分别附加到媒体元素的事件列表。</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> mediaEventTypes: <span class="built_in">Array</span>&lt;DOMEventName&gt; = [</span><br><span class="line">  <span class="string">'abort'</span>,</span><br><span class="line">  <span class="string">'canplay'</span>,</span><br><span class="line">  <span class="string">'canplaythrough'</span>,</span><br><span class="line">  <span class="string">'durationchange'</span>,</span><br><span class="line">  <span class="string">'emptied'</span>,</span><br><span class="line">  <span class="string">'encrypted'</span>,</span><br><span class="line">  <span class="string">'ended'</span>,</span><br><span class="line">  <span class="string">'error'</span>,</span><br><span class="line">  <span class="string">'loadeddata'</span>,</span><br><span class="line">  <span class="string">'loadedmetadata'</span>,</span><br><span class="line">  <span class="string">'loadstart'</span>,</span><br><span class="line">  <span class="string">'pause'</span>,</span><br><span class="line">  <span class="string">'play'</span>,</span><br><span class="line">  <span class="string">'playing'</span>,</span><br><span class="line">  <span class="string">'progress'</span>,</span><br><span class="line">  <span class="string">'ratechange'</span>,</span><br><span class="line">  <span class="string">'resize'</span>,</span><br><span class="line">  <span class="string">'seeked'</span>,</span><br><span class="line">  <span class="string">'seeking'</span>,</span><br><span class="line">  <span class="string">'stalled'</span>,</span><br><span class="line">  <span class="string">'suspend'</span>,</span><br><span class="line">  <span class="string">'timeupdate'</span>,</span><br><span class="line">  <span class="string">'volumechange'</span>,</span><br><span class="line">  <span class="string">'waiting'</span>,</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<h4 id="listenToNativeEvent"><a href="#listenToNativeEvent" class="headerlink" title="listenToNativeEvent"></a>listenToNativeEvent</h4><p>这个函数只做一件事情：定义一个 <code>flags</code> 变量表示当前是冒泡还是捕获，然后调用 <code>addTrappedEventListener</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// \packages\react-dom-bindings\src\events\DOMPluginEventSystem.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">listenToNativeEvent</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  domEventName: DOMEventName, <span class="regexp">//</span> 原生事件名</span></span></span><br><span class="line"><span class="function"><span class="params">  isCapturePhaseListener: boolean, <span class="regexp">//</span> 是否是捕获阶段</span></span></span><br><span class="line"><span class="function"><span class="params">  target: EventTarget, <span class="regexp">//</span> 事件绑定的目标节点，也就是 div#root</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 冒泡用 0 表示，捕获用 4 表示</span></span><br><span class="line">  <span class="keyword">let</span> eventSystemFlags = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (isCapturePhaseListener) &#123;</span><br><span class="line">    eventSystemFlags |= IS_CAPTURE_PHASE;</span><br><span class="line">  &#125;</span><br><span class="line">  addTrappedEventListener(</span><br><span class="line">    target,</span><br><span class="line">    domEventName,</span><br><span class="line">    eventSystemFlags,</span><br><span class="line">    isCapturePhaseListener,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="addTrappedEventListener"><a href="#addTrappedEventListener" class="headerlink" title="addTrappedEventListener"></a>addTrappedEventListener</h4><p>这个函数主要做了两件事：</p>
<ol>
<li>创建一个监听器，用于事件挂载，具体查看 <code>createEventListenerWrapperWithPriority</code></li>
<li>事件挂载，将事件挂载到目标节点上，也就是将事件绑定到 <code>div#root</code> 上</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// \packages\react-dom-bindings\src\events\DOMPluginEventSystem.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addTrappedEventListener</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  targetContainer: EventTarget, <span class="regexp">//</span> 事件挂载节点，也就是 div#root</span></span></span><br><span class="line"><span class="function"><span class="params">  domEventName: DOMEventName, <span class="regexp">//</span> 原生事件名，比如 click</span></span></span><br><span class="line"><span class="function"><span class="params">  eventSystemFlags: EventSystemFlags, <span class="regexp">//</span> <span class="number">4</span> 表示捕获，<span class="number">0</span> 表示冒泡</span></span></span><br><span class="line"><span class="function"><span class="params">  isCapturePhaseListener: boolean, <span class="regexp">//</span> true 表示捕获阶段，false 表示冒泡阶段</span></span></span><br><span class="line"><span class="function"><span class="params">  isDeferredListenerForLegacyFBSupport?: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 获取对应事件，事件定义在ReactDOMEventListener.js中</span></span><br><span class="line">  <span class="comment">// 如DiscreteEventPriority对应dispatchDiscreteEvent，ContinuousEventPriority对应dispatchContinuousEvent</span></span><br><span class="line">  <span class="comment">// 创建一个事件监听器</span></span><br><span class="line">  <span class="keyword">let</span> listener = createEventListenerWrapperWithPriority(</span><br><span class="line">    targetContainer,</span><br><span class="line">    domEventName,</span><br><span class="line">    eventSystemFlags,</span><br><span class="line">  );</span><br><span class="line">  <span class="comment">// If passive option is not supported, then the event will be</span></span><br><span class="line">  <span class="comment">// active and not passive.</span></span><br><span class="line">  <span class="keyword">let</span> isPassiveListener: <span class="keyword">void</span> | boolean = <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">if</span> (passiveBrowserEventsSupported) &#123;</span><br><span class="line">    <span class="comment">// sy</span></span><br><span class="line">    <span class="comment">// Browsers introduced an intervention, making these events</span></span><br><span class="line">    <span class="comment">// passive by default on document. React doesn't bind them</span></span><br><span class="line">    <span class="comment">// to document anymore, but changing this now would undo</span></span><br><span class="line">    <span class="comment">// the performance wins from the change. So we emulate</span></span><br><span class="line">    <span class="comment">// the existing behavior manually on the roots now.</span></span><br><span class="line">    <span class="comment">// 浏览器引入了一种干预措施，使这些事件在document上默认为passive状态。</span></span><br><span class="line">    <span class="comment">// React不再将它们绑定到document上，但是现在改变这一点将会撤销之前的性能优势。</span></span><br><span class="line">    <span class="comment">// 因此，我们现在在根节点上手动模拟现有的行为。</span></span><br><span class="line">    <span class="comment">// https://github.com/facebook/react/issues/19651</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      domEventName === <span class="string">'touchstart'</span> ||</span><br><span class="line">      domEventName === <span class="string">'touchmove'</span> ||</span><br><span class="line">      domEventName === <span class="string">'wheel'</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      isPassiveListener = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// React17之后，事件委托在targetContainer，但是兼容之前的版本委托在document</span></span><br><span class="line">  targetContainer =</span><br><span class="line">    enableLegacyFBSupport &amp;&amp; isDeferredListenerForLegacyFBSupport</span><br><span class="line">      ? (targetContainer: any).ownerDocument</span><br><span class="line">      : targetContainer;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> unsubscribeListener;</span><br><span class="line">  <span class="comment">// When legacyFBSupport is enabled, it's for when we</span></span><br><span class="line">  <span class="comment">// want to add a one time event listener to a container.</span></span><br><span class="line">  <span class="comment">// This should only be used with enableLegacyFBSupport</span></span><br><span class="line">  <span class="comment">// due to requirement to provide compatibility with</span></span><br><span class="line">  <span class="comment">// internal FB www event tooling. This works by removing</span></span><br><span class="line">  <span class="comment">// the event listener as soon as it is invoked. We could</span></span><br><span class="line">  <span class="comment">// also attempt to use the &#123;once: true&#125; param on</span></span><br><span class="line">  <span class="comment">// addEventListener, but that requires support and some</span></span><br><span class="line">  <span class="comment">// browsers do not support this today, and given this is</span></span><br><span class="line">  <span class="comment">// to support legacy code patterns, it's likely they'll</span></span><br><span class="line">  <span class="comment">// need support for such browsers.</span></span><br><span class="line">  <span class="comment">// 当启用legacyFBSupport时，是为了当我们想要向container添加一次性事件监听器时使用。</span></span><br><span class="line">  <span class="comment">// 这应该只与enableLegacyFBSupport一起使用，因为需要与内部FB www事件工具提供的兼容性。</span></span><br><span class="line">  <span class="comment">// 这通过在调用后立即移除事件监听器来实现。我们也可以尝试在addEventListener上使用&#123;once: true&#125;参数，但这需要支持，</span></span><br><span class="line">  <span class="comment">// 一些浏览器今天不支持这一点，考虑到这是为了支持传统代码模式，它们可能需要支持这些浏览器。</span></span><br><span class="line">  <span class="keyword">if</span> (enableLegacyFBSupport &amp;&amp; isDeferredListenerForLegacyFBSupport) &#123;</span><br><span class="line">    <span class="keyword">const</span> originalListener = listener;</span><br><span class="line">    listener = <span class="function"><span class="keyword">function</span> (<span class="params">...p</span>) </span>&#123;</span><br><span class="line">      removeEventListener(</span><br><span class="line">        targetContainer,</span><br><span class="line">        domEventName,</span><br><span class="line">        unsubscribeListener,</span><br><span class="line">        isCapturePhaseListener,</span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">return</span> originalListener.apply(<span class="keyword">this</span>, p);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> There are too many combinations here. Consolidate them.</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isCapturePhaseListener) &#123;</span><br><span class="line">    <span class="comment">// ! 捕获阶段</span></span><br><span class="line">    <span class="comment">// sy</span></span><br><span class="line">    <span class="keyword">if</span> (isPassiveListener !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      <span class="comment">// touchstart、touchmove、wheel</span></span><br><span class="line">      unsubscribeListener = addEventCaptureListenerWithPassiveFlag(</span><br><span class="line">        targetContainer,</span><br><span class="line">        domEventName,</span><br><span class="line">        listener,</span><br><span class="line">        isPassiveListener,</span><br><span class="line">      );</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// sy</span></span><br><span class="line">      <span class="comment">// click、contextmenu、drag、drop、input、mousedown、change等事件</span></span><br><span class="line">      unsubscribeListener = addEventCaptureListener(</span><br><span class="line">        targetContainer,</span><br><span class="line">        domEventName,</span><br><span class="line">        listener,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// ! 冒泡阶段</span></span><br><span class="line">    <span class="keyword">if</span> (isPassiveListener !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      <span class="comment">// touchstart、touchmove、wheel</span></span><br><span class="line">      unsubscribeListener = addEventBubbleListenerWithPassiveFlag(</span><br><span class="line">        targetContainer,</span><br><span class="line">        domEventName,</span><br><span class="line">        listener,</span><br><span class="line">        isPassiveListener,</span><br><span class="line">      );</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// click、contextmenu、drag、drop、input、mousedown、change等事件</span></span><br><span class="line">      <span class="comment">// sy</span></span><br><span class="line">      unsubscribeListener = addEventBubbleListener(</span><br><span class="line">        targetContainer,</span><br><span class="line">        domEventName,</span><br><span class="line">        listener,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="createEventListenerWrapperWithPriority"><a href="#createEventListenerWrapperWithPriority" class="headerlink" title="createEventListenerWrapperWithPriority"></a>createEventListenerWrapperWithPriority</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// \packages\react-dom-bindings\src\events\ReactDOMEventListener.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createEventListenerWrapperWithPriority</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  targetContainer: EventTarget,</span></span></span><br><span class="line"><span class="function"><span class="params">  domEventName: DOMEventName,</span></span></span><br><span class="line"><span class="function"><span class="params">  eventSystemFlags: EventSystemFlags,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Function</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 根据事件名称，获取优先级。比如click、input、drop等对应DiscreteEventPriority，drag、scroll等对应ContinuousEventPriority，</span></span><br><span class="line">  <span class="comment">// message也许处于Scheduler中，根据getCurrentSchedulerPriorityLevel()获取优先级。其它是DefaultEventPriority。</span></span><br><span class="line">  <span class="keyword">const</span> eventPriority = getEventPriority(domEventName);</span><br><span class="line">  <span class="keyword">let</span> listenerWrapper;</span><br><span class="line">  <span class="keyword">switch</span> (eventPriority) &#123;</span><br><span class="line">    <span class="keyword">case</span> DiscreteEventPriority:</span><br><span class="line">      listenerWrapper = dispatchDiscreteEvent;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ContinuousEventPriority:</span><br><span class="line">      listenerWrapper = dispatchContinuousEvent;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> DefaultEventPriority:</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      listenerWrapper = dispatchEvent;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> listenerWrapper.bind(</span><br><span class="line">    <span class="literal">null</span>,</span><br><span class="line">    domEventName,</span><br><span class="line">    eventSystemFlags,</span><br><span class="line">    targetContainer,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="getEventPriority"><a href="#getEventPriority" class="headerlink" title="getEventPriority"></a>getEventPriority</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">getEventPriority</span>(<span class="params">domEventName: DOMEventName</span>): <span class="title">EventPriority</span> </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (domEventName) &#123;</span><br><span class="line">    <span class="comment">// Used by SimpleEventPlugin:</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">'cancel'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'click'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'close'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'contextmenu'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'copy'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'cut'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'auxclick'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'dblclick'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'dragend'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'dragstart'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'drop'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'focusin'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'focusout'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'input'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'invalid'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'keydown'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'keypress'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'keyup'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'mousedown'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'mouseup'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'paste'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'pause'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'play'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'pointercancel'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'pointerdown'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'pointerup'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'ratechange'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'reset'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'resize'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'seeked'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'submit'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'touchcancel'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'touchend'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'touchstart'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'volumechange'</span>:</span><br><span class="line">    <span class="comment">// Used by polyfills: (fall through)</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">'change'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'selectionchange'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'textInput'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'compositionstart'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'compositionend'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'compositionupdate'</span>:</span><br><span class="line">    <span class="comment">// Only enableCreateEventHandleAPI: (fall through)</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">'beforeblur'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'afterblur'</span>:</span><br><span class="line">    <span class="comment">// Not used by React but could be by user code: (fall through)</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">'beforeinput'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'blur'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'fullscreenchange'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'focus'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'hashchange'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'popstate'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'select'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'selectstart'</span>:</span><br><span class="line">      <span class="keyword">return</span> DiscreteEventPriority;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'drag'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'dragenter'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'dragexit'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'dragleave'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'dragover'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'mousemove'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'mouseout'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'mouseover'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'pointermove'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'pointerout'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'pointerover'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'scroll'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'toggle'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'touchmove'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'wheel'</span>:</span><br><span class="line">    <span class="comment">// Not used by React but could be by user code: (fall through)</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">'mouseenter'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'mouseleave'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'pointerenter'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'pointerleave'</span>:</span><br><span class="line">      <span class="keyword">return</span> ContinuousEventPriority;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'message'</span>: &#123;</span><br><span class="line">      <span class="comment">// We might be in the Scheduler callback.</span></span><br><span class="line">      <span class="comment">// Eventually this mechanism will be replaced by a check</span></span><br><span class="line">      <span class="comment">// of the current priority on the native scheduler.</span></span><br><span class="line">      <span class="keyword">const</span> schedulerPriority = getCurrentSchedulerPriorityLevel();</span><br><span class="line">      <span class="keyword">switch</span> (schedulerPriority) &#123;</span><br><span class="line">        <span class="keyword">case</span> ImmediateSchedulerPriority:</span><br><span class="line">          <span class="keyword">return</span> DiscreteEventPriority;</span><br><span class="line">        <span class="keyword">case</span> UserBlockingSchedulerPriority:</span><br><span class="line">          <span class="keyword">return</span> ContinuousEventPriority;</span><br><span class="line">        <span class="keyword">case</span> NormalSchedulerPriority:</span><br><span class="line">        <span class="keyword">case</span> LowSchedulerPriority:</span><br><span class="line">          <span class="comment">// <span class="doctag">TODO:</span> Handle LowSchedulerPriority, somehow. Maybe the same lane as hydration.</span></span><br><span class="line">          <span class="keyword">return</span> DefaultEventPriority;</span><br><span class="line">        <span class="keyword">case</span> IdleSchedulerPriority:</span><br><span class="line">          <span class="keyword">return</span> IdleEventPriority;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">          <span class="keyword">return</span> DefaultEventPriority;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> DefaultEventPriority;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="事件挂载-捕获阶段"><a href="#事件挂载-捕获阶段" class="headerlink" title="事件挂载 - 捕获阶段"></a>事件挂载 - 捕获阶段</h4><h5 id="支持passive-addEventCaptureListenerWithPassiveFlag"><a href="#支持passive-addEventCaptureListenerWithPassiveFlag" class="headerlink" title="支持passive - addEventCaptureListenerWithPassiveFlag"></a>支持passive - addEventCaptureListenerWithPassiveFlag</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// \packages\react-dom-bindings\src\events\EventListener.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">addEventCaptureListenerWithPassiveFlag</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  target: EventTarget,</span></span></span><br><span class="line"><span class="function"><span class="params">  eventType: string,</span></span></span><br><span class="line"><span class="function"><span class="params">  listener: Function,</span></span></span><br><span class="line"><span class="function"><span class="params">  passive: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Function</span> </span>&#123;</span><br><span class="line">  target.addEventListener(eventType, listener, &#123;</span><br><span class="line">    capture: <span class="literal">true</span>,</span><br><span class="line">    passive,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> listener;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="addEventCaptureListener"><a href="#addEventCaptureListener" class="headerlink" title="addEventCaptureListener"></a>addEventCaptureListener</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// \packages\react-dom-bindings\src\events\EventListener.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">addEventCaptureListener</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  target: EventTarget,</span></span></span><br><span class="line"><span class="function"><span class="params">  eventType: string,</span></span></span><br><span class="line"><span class="function"><span class="params">  listener: Function,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Function</span> </span>&#123;</span><br><span class="line">  target.addEventListener(eventType, listener, <span class="literal">true</span>);</span><br><span class="line">  <span class="keyword">return</span> listener;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="事件挂载-冒泡阶段"><a href="#事件挂载-冒泡阶段" class="headerlink" title="事件挂载 - 冒泡阶段"></a>事件挂载 - 冒泡阶段</h4><h5 id="支持passive-addEventBubbleListenerWithPassiveFlag"><a href="#支持passive-addEventBubbleListenerWithPassiveFlag" class="headerlink" title="支持passive - addEventBubbleListenerWithPassiveFlag"></a>支持passive - addEventBubbleListenerWithPassiveFlag</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// \packages\react-dom-bindings\src\events\EventListener.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">addEventCaptureListenerWithPassiveFlag</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  target: EventTarget,</span></span></span><br><span class="line"><span class="function"><span class="params">  eventType: string,</span></span></span><br><span class="line"><span class="function"><span class="params">  listener: Function,</span></span></span><br><span class="line"><span class="function"><span class="params">  passive: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Function</span> </span>&#123;</span><br><span class="line">  target.addEventListener(eventType, listener, &#123;</span><br><span class="line">    capture: <span class="literal">true</span>,</span><br><span class="line">    passive,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> listener;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="addEventBubbleListener"><a href="#addEventBubbleListener" class="headerlink" title="addEventBubbleListener"></a>addEventBubbleListener</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// \packages\react-dom-bindings\src\events\EventListener.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">addEventBubbleListener</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  target: EventTarget,</span></span></span><br><span class="line"><span class="function"><span class="params">  eventType: string,</span></span></span><br><span class="line"><span class="function"><span class="params">  listener: Function,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Function</span> </span>&#123;</span><br><span class="line">  target.addEventListener(eventType, listener, <span class="literal">false</span>);</span><br><span class="line">  <span class="keyword">return</span> listener;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="事件派发"><a href="#事件派发" class="headerlink" title="事件派发"></a>事件派发</h2><h3 id="dispatchDiscreteEvent"><a href="#dispatchDiscreteEvent" class="headerlink" title="dispatchDiscreteEvent"></a>dispatchDiscreteEvent</h3><p>适用事件：click、drop、input、drop 等</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dispatchDiscreteEvent</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  domEventName: DOMEventName,</span></span></span><br><span class="line"><span class="function"><span class="params">  eventSystemFlags: EventSystemFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">  container: EventTarget,</span></span></span><br><span class="line"><span class="function"><span class="params">  nativeEvent: AnyNativeEvent,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ! 1. 记录上一次的事件优先级</span></span><br><span class="line">  <span class="keyword">const</span> previousPriority = getCurrentUpdatePriority();</span><br><span class="line">  <span class="comment">// ! 2. 记录上一次的transition</span></span><br><span class="line">  <span class="keyword">const</span> prevTransition = ReactCurrentBatchConfig.transition;</span><br><span class="line">  <span class="comment">// !3. 清空transition，transition为非紧急更新，这里不处理</span></span><br><span class="line">  ReactCurrentBatchConfig.transition = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// !4. 设置当前事件优先级为DiscreteEventPriority</span></span><br><span class="line">    setCurrentUpdatePriority(DiscreteEventPriority);</span><br><span class="line">    <span class="comment">// !5. 调用dispatchEvent，执行事件</span></span><br><span class="line">    dispatchEvent(domEventName, eventSystemFlags, container, nativeEvent);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="comment">// !6. 恢复</span></span><br><span class="line">    setCurrentUpdatePriority(previousPriority);</span><br><span class="line">    ReactCurrentBatchConfig.transition = prevTransition;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="事件优先级记录"><a href="#事件优先级记录" class="headerlink" title="事件优先级记录"></a>事件优先级记录</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// \react-reconciler\src\ReactEventPriorities.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> opaque type EventPriority = Lane;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 优先级从上往下，越来越小</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> DiscreteEventPriority: EventPriority = SyncLane; <span class="comment">// 2</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> ContinuousEventPriority: EventPriority = InputContinuousLane; <span class="comment">// 8</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> DefaultEventPriority: EventPriority = DefaultLane; <span class="comment">// 页面初次渲染的lane 32, transition</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> IdleEventPriority: EventPriority = IdleLane;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> currentUpdatePriority: EventPriority = NoLane;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">getCurrentUpdatePriority</span>(<span class="params"></span>): <span class="title">EventPriority</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> currentUpdatePriority;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">setCurrentUpdatePriority</span>(<span class="params">newPriority: EventPriority</span>) </span>&#123;</span><br><span class="line">  currentUpdatePriority = newPriority;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="dispatchContinuousEvent"><a href="#dispatchContinuousEvent" class="headerlink" title="dispatchContinuousEvent"></a>dispatchContinuousEvent</h3><p>适用事件：drag、mouse的各种事件等</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dispatchContinuousEvent</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  domEventName: DOMEventName,</span></span></span><br><span class="line"><span class="function"><span class="params">  eventSystemFlags: EventSystemFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">  container: EventTarget,</span></span></span><br><span class="line"><span class="function"><span class="params">  nativeEvent: AnyNativeEvent,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> previousPriority = getCurrentUpdatePriority();</span><br><span class="line">  <span class="keyword">const</span> prevTransition = ReactCurrentBatchConfig.transition;</span><br><span class="line">  ReactCurrentBatchConfig.transition = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    setCurrentUpdatePriority(ContinuousEventPriority);</span><br><span class="line">    dispatchEvent(domEventName, eventSystemFlags, container, nativeEvent);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    setCurrentUpdatePriority(previousPriority);</span><br><span class="line">    ReactCurrentBatchConfig.transition = prevTransition;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="dispatchEvent"><a href="#dispatchEvent" class="headerlink" title="dispatchEvent"></a>dispatchEvent</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// \react-dom-bindings\src\events\ReactDOMEventListener.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 派发事件</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">dispatchEvent</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  domEventName: DOMEventName,</span></span></span><br><span class="line"><span class="function"><span class="params">  eventSystemFlags: EventSystemFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">  targetContainer: EventTarget,</span></span></span><br><span class="line"><span class="function"><span class="params">  nativeEvent: AnyNativeEvent,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 有些场景下是禁止事件的，比如在commit阶段</span></span><br><span class="line">  <span class="keyword">if</span> (!_enabled) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> blockedOn = findInstanceBlockingEvent(nativeEvent);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (blockedOn === <span class="literal">null</span>) &#123;</span><br><span class="line">    dispatchEventForPluginEventSystem(</span><br><span class="line">      domEventName,</span><br><span class="line">      eventSystemFlags,</span><br><span class="line">      nativeEvent,</span><br><span class="line">      return_targetInst,</span><br><span class="line">      targetContainer,</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    clearIfContinuousEvent(domEventName, nativeEvent);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    queueIfContinuousEvent(</span><br><span class="line">      blockedOn,</span><br><span class="line">      domEventName,</span><br><span class="line">      eventSystemFlags,</span><br><span class="line">      targetContainer,</span><br><span class="line">      nativeEvent,</span><br><span class="line">    )</span><br><span class="line">  ) &#123;</span><br><span class="line">    nativeEvent.stopPropagation();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// We need to clear only if we didn't queue because</span></span><br><span class="line">  <span class="comment">// queueing is accumulative.</span></span><br><span class="line">  clearIfContinuousEvent(domEventName, nativeEvent);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    eventSystemFlags &amp; IS_CAPTURE_PHASE &amp;&amp;</span><br><span class="line">    isDiscreteEventThatRequiresHydration(domEventName)</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">while</span> (blockedOn !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> fiber = getInstanceFromNode(blockedOn);</span><br><span class="line">      <span class="keyword">if</span> (fiber !== <span class="literal">null</span>) &#123;</span><br><span class="line">        attemptSynchronousHydration(fiber);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> nextBlockedOn = findInstanceBlockingEvent(nativeEvent);</span><br><span class="line">      <span class="keyword">if</span> (nextBlockedOn === <span class="literal">null</span>) &#123;</span><br><span class="line">        dispatchEventForPluginEventSystem(</span><br><span class="line">          domEventName,</span><br><span class="line">          eventSystemFlags,</span><br><span class="line">          nativeEvent,</span><br><span class="line">          return_targetInst,</span><br><span class="line">          targetContainer,</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (nextBlockedOn === blockedOn) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      blockedOn = nextBlockedOn;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (blockedOn !== <span class="literal">null</span>) &#123;</span><br><span class="line">      nativeEvent.stopPropagation();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// This is not replayable so we'll invoke it but without a target,</span></span><br><span class="line">  <span class="comment">// in case the event system needs to trace it.</span></span><br><span class="line">  dispatchEventForPluginEventSystem(</span><br><span class="line">    domEventName,</span><br><span class="line">    eventSystemFlags,</span><br><span class="line">    nativeEvent,</span><br><span class="line">    <span class="literal">null</span>,</span><br><span class="line">    targetContainer,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="findInstanceBlockingEvent"><a href="#findInstanceBlockingEvent" class="headerlink" title="findInstanceBlockingEvent"></a>findInstanceBlockingEvent</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// \react-dom-bindings\src\events\ReactDOMEventListener.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">findInstanceBlockingEvent</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  nativeEvent: AnyNativeEvent,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">null</span> | <span class="title">Container</span> | <span class="title">SuspenseInstance</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> nativeEventTarget = getEventTarget(nativeEvent);</span><br><span class="line">  <span class="keyword">return</span> findInstanceBlockingTarget(nativeEventTarget);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">let</span> return_targetInst: <span class="literal">null</span> | Fiber = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Returns a SuspenseInstance or Container if it's blocked.</span></span><br><span class="line"><span class="comment">// The return_targetInst field above is conceptually part of the return value.</span></span><br><span class="line"><span class="comment">// 如果被阻塞，返回一个 SuspenseInstance 或 Container。</span></span><br><span class="line"><span class="comment">// 上面的 return_targetInst 字段在概念上是返回值的一部分。</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">findInstanceBlockingTarget</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  targetNode: Node,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">null</span> | <span class="title">Container</span> | <span class="title">SuspenseInstance</span> </span>&#123;</span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Warn if _enabled is false.</span></span><br><span class="line"></span><br><span class="line">  return_targetInst = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 通过 targetNode 获取最近的 Fiber 实例</span></span><br><span class="line">  <span class="keyword">let</span> targetInst = getClosestInstanceFromNode(targetNode);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (targetInst !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 寻找最近的已挂载的 Fiber 实例</span></span><br><span class="line">    <span class="keyword">const</span> nearestMounted = getNearestMountedFiber(targetInst);</span><br><span class="line">    <span class="keyword">if</span> (nearestMounted === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// This tree has been unmounted already. Dispatch without a target.</span></span><br><span class="line">      <span class="comment">// 这棵树已经被卸载了。在没有目标的情况下进行派发。</span></span><br><span class="line">      targetInst = <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> tag = nearestMounted.tag;</span><br><span class="line">      <span class="keyword">if</span> (tag === SuspenseComponent) &#123;</span><br><span class="line">        <span class="comment">// 寻找最近的已挂载的 Suspense 实例</span></span><br><span class="line">        <span class="keyword">const</span> instance = getSuspenseInstanceFromFiber(nearestMounted);</span><br><span class="line">        <span class="keyword">if</span> (instance !== <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="comment">// Queue the event to be replayed later. Abort dispatching since we</span></span><br><span class="line">          <span class="comment">// don't want this event dispatched twice through the event system.</span></span><br><span class="line">          <span class="comment">// <span class="doctag">TODO:</span> If this is the first discrete event in the queue. Schedule an increased</span></span><br><span class="line">          <span class="comment">// priority for this boundary.</span></span><br><span class="line">          <span class="comment">// 将事件排队以便稍后重播。中止事件分发，因为我们不希望通过事件系统将此事件分发两次。</span></span><br><span class="line">          <span class="keyword">return</span> instance;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// This shouldn't happen, something went wrong but to avoid blocking</span></span><br><span class="line">        <span class="comment">// the whole system, dispatch the event without a target.</span></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Warn.</span></span><br><span class="line">        <span class="comment">// 这不应该发生，出了点问题，但为了避免阻塞整个系统，以没有目标的方式分发事件。</span></span><br><span class="line">        targetInst = <span class="literal">null</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tag === HostRoot) &#123;</span><br><span class="line">        <span class="keyword">const</span> root: FiberRoot = nearestMounted.stateNode;</span><br><span class="line">        <span class="keyword">if</span> (isRootDehydrated(root)) &#123;</span><br><span class="line">          <span class="comment">// If this happens during a replay something went wrong and it might block</span></span><br><span class="line">          <span class="comment">// the whole system.</span></span><br><span class="line">          <span class="keyword">return</span> getContainerFromFiber(nearestMounted);</span><br><span class="line">        &#125;</span><br><span class="line">        targetInst = <span class="literal">null</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nearestMounted !== targetInst) &#123;</span><br><span class="line">        <span class="comment">// If we get an event (ex: img onload) before committing that</span></span><br><span class="line">        <span class="comment">// component's mount, ignore it for now (that is, treat it as if it was an</span></span><br><span class="line">        <span class="comment">// event on a non-React tree). We might also consider queueing events and</span></span><br><span class="line">        <span class="comment">// dispatching them after the mount.</span></span><br><span class="line">        <span class="comment">// 如果在提交该组件的挂载之前收到事件（例如：图片加载完成），暂时忽略它（也就是，将其视为在非React树上的事件）。</span></span><br><span class="line">        <span class="comment">// 我们也可以考虑将事件排队，并在挂载后分发它们。</span></span><br><span class="line">        targetInst = <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return_targetInst = targetInst;</span><br><span class="line">  <span class="comment">// We're not blocked on anything.</span></span><br><span class="line">   <span class="comment">// 没有阻塞</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="dispatchEventForPluginEventSystem"><a href="#dispatchEventForPluginEventSystem" class="headerlink" title="dispatchEventForPluginEventSystem"></a>dispatchEventForPluginEventSystem</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// \react-dom-bindings\src\events\DOMPluginEventSystem.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">dispatchEventForPluginEventSystem</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  domEventName: DOMEventName,</span></span></span><br><span class="line"><span class="function"><span class="params">  eventSystemFlags: EventSystemFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">  nativeEvent: AnyNativeEvent,</span></span></span><br><span class="line"><span class="function"><span class="params">  targetInst: null | Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  targetContainer: EventTarget,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> ancestorInst = targetInst;</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    (eventSystemFlags &amp; IS_EVENT_HANDLE_NON_MANAGED_NODE) === <span class="number">0</span> &amp;&amp;</span><br><span class="line">    (eventSystemFlags &amp; IS_NON_DELEGATED) === <span class="number">0</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">const</span> targetContainerNode = ((targetContainer: any): Node);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If we are using the legacy FB support flag, we</span></span><br><span class="line">    <span class="comment">// defer the event to the null with a one</span></span><br><span class="line">    <span class="comment">// time event listener so we can defer the event.</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      enableLegacyFBSupport &amp;&amp;</span><br><span class="line">      <span class="comment">// If our event flags match the required flags for entering</span></span><br><span class="line">      <span class="comment">// FB legacy mode and we are processing the "click" event,</span></span><br><span class="line">      <span class="comment">// then we can defer the event to the "document", to allow</span></span><br><span class="line">      <span class="comment">// for legacy FB support, where the expected behavior was to</span></span><br><span class="line">      <span class="comment">// match React &lt; 16 behavior of delegated clicks to the doc.</span></span><br><span class="line">      domEventName === <span class="string">'click'</span> &amp;&amp;</span><br><span class="line">      (eventSystemFlags &amp; SHOULD_NOT_DEFER_CLICK_FOR_FB_SUPPORT_MODE) === <span class="number">0</span> &amp;&amp;</span><br><span class="line">      !isReplayingEvent(nativeEvent)</span><br><span class="line">    ) &#123;</span><br><span class="line">      deferClickToDocumentForLegacyFBSupport(domEventName, targetContainer);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (targetInst !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// The below logic attempts to work out if we need to change</span></span><br><span class="line">      <span class="comment">// the target fiber to a different ancestor. We had similar logic</span></span><br><span class="line">      <span class="comment">// in the legacy event system, except the big difference between</span></span><br><span class="line">      <span class="comment">// systems is that the modern event system now has an event listener</span></span><br><span class="line">      <span class="comment">// attached to each React Root and React Portal Root. Together,</span></span><br><span class="line">      <span class="comment">// the DOM nodes representing these roots are the "rootContainer".</span></span><br><span class="line">      <span class="comment">// To figure out which ancestor instance we should use, we traverse</span></span><br><span class="line">      <span class="comment">// up the fiber tree from the target instance and attempt to find</span></span><br><span class="line">      <span class="comment">// root boundaries that match that of our current "rootContainer".</span></span><br><span class="line">      <span class="comment">// If we find that "rootContainer", we find the parent fiber</span></span><br><span class="line">      <span class="comment">// sub-tree for that root and make that our ancestor instance.</span></span><br><span class="line">      <span class="keyword">let</span> node: <span class="literal">null</span> | Fiber = targetInst;</span><br><span class="line"></span><br><span class="line">      mainLoop: <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (node === <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="comment">// 事件没有对应的fiber，没法执行事件，退出</span></span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> nodeTag = node.tag;</span><br><span class="line">        <span class="keyword">if</span> (nodeTag === HostRoot || nodeTag === HostPortal) &#123;</span><br><span class="line">          <span class="keyword">let</span> container = node.stateNode.containerInfo;</span><br><span class="line">          <span class="keyword">if</span> (isMatchingRootContainer(container, targetContainerNode)) &#123;</span><br><span class="line">            <span class="comment">// container和targetContainerNode相等，说明找到了对应的rootContainer</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (nodeTag === HostPortal) &#123;</span><br><span class="line">            <span class="comment">// The target is a portal, but it's not the rootContainer we're looking for.</span></span><br><span class="line">            <span class="comment">// Normally portals handle their own events all the way down to the root.</span></span><br><span class="line">            <span class="comment">// So we should be able to stop now. However, we don't know if this portal</span></span><br><span class="line">            <span class="comment">// was part of *our* root.</span></span><br><span class="line">            <span class="keyword">let</span> grandNode = node.return;</span><br><span class="line">            <span class="keyword">while</span> (grandNode !== <span class="literal">null</span>) &#123;</span><br><span class="line">              <span class="keyword">const</span> grandTag = grandNode.tag;</span><br><span class="line">              <span class="keyword">if</span> (grandTag === HostRoot || grandTag === HostPortal) &#123;</span><br><span class="line">                <span class="keyword">const</span> grandContainer = grandNode.stateNode.containerInfo;</span><br><span class="line">                <span class="keyword">if</span> (</span><br><span class="line">                  isMatchingRootContainer(grandContainer, targetContainerNode)</span><br><span class="line">                ) &#123;</span><br><span class="line">                  <span class="comment">// This is the rootContainer we're looking for and we found it as</span></span><br><span class="line">                  <span class="comment">// a parent of the Portal. That means we can ignore it because the</span></span><br><span class="line">                  <span class="comment">// Portal will bubble through to us.</span></span><br><span class="line">                  <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">              grandNode = grandNode.return;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// Now we need to find it's corresponding host fiber in the other</span></span><br><span class="line">          <span class="comment">// tree. To do this we can use getClosestInstanceFromNode, but we</span></span><br><span class="line">          <span class="comment">// need to validate that the fiber is a host instance, otherwise</span></span><br><span class="line">          <span class="comment">// we need to traverse up through the DOM till we find the correct</span></span><br><span class="line">          <span class="comment">// node that is from the other tree.</span></span><br><span class="line">          <span class="keyword">while</span> (container !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> parentNode = getClosestInstanceFromNode(container);</span><br><span class="line">            <span class="keyword">if</span> (parentNode === <span class="literal">null</span>) &#123;</span><br><span class="line">              <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">const</span> parentTag = parentNode.tag;</span><br><span class="line">            <span class="keyword">if</span> (</span><br><span class="line">              parentTag === HostComponent ||</span><br><span class="line">              parentTag === HostText ||</span><br><span class="line">              (enableFloat ? parentTag === HostHoistable : <span class="literal">false</span>) ||</span><br><span class="line">              parentTag === HostSingleton</span><br><span class="line">            ) &#123;</span><br><span class="line">              node = ancestorInst = parentNode;</span><br><span class="line">              <span class="keyword">continue</span> mainLoop;</span><br><span class="line">            &#125;</span><br><span class="line">            container = container.parentNode;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        node = node.return;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 批量更新</span></span><br><span class="line">  batchedUpdates(<span class="function"><span class="params">()</span> =&gt;</span></span><br><span class="line">    dispatchEventsForPlugins(</span><br><span class="line">      domEventName,</span><br><span class="line">      eventSystemFlags,</span><br><span class="line">      nativeEvent,</span><br><span class="line">      ancestorInst,</span><br><span class="line">      targetContainer,</span><br><span class="line">    )</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="batchedUpdates"><a href="#batchedUpdates" class="headerlink" title="batchedUpdates"></a>batchedUpdates</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// \react-dom-bindings\src\events\ReactDOMUpdateBatching.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">batchedUpdates</span>(<span class="params">fn, a, b</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (isInsideEventHandler) &#123;</span><br><span class="line">    <span class="comment">// If we are currently inside another batch, we need to wait until it</span></span><br><span class="line">    <span class="comment">// fully completes before restoring state.</span></span><br><span class="line">    <span class="comment">// 如果我们当前正在另一个批处理中，需要等待其完全完成后再恢复状态。</span></span><br><span class="line">    <span class="keyword">return</span> fn(a, b);</span><br><span class="line">  &#125;</span><br><span class="line">  isInsideEventHandler = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> batchedUpdatesImpl(fn, a, b);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    isInsideEventHandler = <span class="literal">false</span>;</span><br><span class="line">    finishEventHandler();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// \packages\react-reconciler\src\ReactFiberWorkLoop.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">batchedUpdates</span>&lt;<span class="title">A</span>, <span class="title">R</span>&gt;(<span class="params">fn: A =&gt; R, a: A</span>): <span class="title">R</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> prevExecutionContext = executionContext;</span><br><span class="line">  executionContext |= BatchedContext;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> fn(a);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    executionContext = prevExecutionContext;</span><br><span class="line">    <span class="comment">// If there were legacy sync updates, flush them at the end of the outer</span></span><br><span class="line">    <span class="comment">// most batchedUpdates-like method.</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      executionContext === NoContext &amp;&amp;</span><br><span class="line">      <span class="comment">// Treat `act` as if it's inside `batchedUpdates`, even in legacy mode.</span></span><br><span class="line">      !(__DEV__ &amp;&amp; ReactCurrentActQueue.isBatchingLegacy)</span><br><span class="line">    ) &#123;</span><br><span class="line">      resetRenderTimer();</span><br><span class="line">      flushSyncWorkOnLegacyRootsOnly();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="dispatchEventsForPlugins"><a href="#dispatchEventsForPlugins" class="headerlink" title="dispatchEventsForPlugins"></a>dispatchEventsForPlugins</h3><p>这个函数主要做了两件事：</p>
<ol>
<li><code>extractEvents</code> - 提取事件，将事件函数放到 <code>dispatchQueue</code> 队列中</li>
<li><code>processDispatchQueue</code> - 执行事件，将 <code>dispatchQueue</code> 队列中的事件函数依次执行</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dispatchEventsForPlugins</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  domEventName: DOMEventName,</span></span></span><br><span class="line"><span class="function"><span class="params">  eventSystemFlags: EventSystemFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">  nativeEvent: AnyNativeEvent,</span></span></span><br><span class="line"><span class="function"><span class="params">  targetInst: null | Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  targetContainer: EventTarget,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="comment">// nativeEvent.target</span></span><br><span class="line">  <span class="keyword">const</span> nativeEventTarget = getEventTarget(nativeEvent);</span><br><span class="line">  <span class="keyword">const</span> dispatchQueue: DispatchQueue = [];</span><br><span class="line">  extractEvents(</span><br><span class="line">    dispatchQueue,</span><br><span class="line">    domEventName,</span><br><span class="line">    targetInst,</span><br><span class="line">    nativeEvent,</span><br><span class="line">    nativeEventTarget,</span><br><span class="line">    eventSystemFlags,</span><br><span class="line">    targetContainer,</span><br><span class="line">  );</span><br><span class="line">  processDispatchQueue(dispatchQueue, eventSystemFlags);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="extractEvents"><a href="#extractEvents" class="headerlink" title="extractEvents"></a>extractEvents</h3><p>在一开始事件注册时，不同类型的事件由不同的事件插件进行注册，它们的特征可能不一样，但是不同类型的事件底层处理的逻辑是相同的，所以 <code>extractEvents</code> 函数调用了 <code>SimpleEventPlugin.extractEvents</code> 函数，用来提取事件。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">extractEvents</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  dispatchQueue: DispatchQueue,</span></span></span><br><span class="line"><span class="function"><span class="params">  domEventName: DOMEventName,</span></span></span><br><span class="line"><span class="function"><span class="params">  targetInst: null | Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  nativeEvent: AnyNativeEvent,</span></span></span><br><span class="line"><span class="function"><span class="params">  nativeEventTarget: null | EventTarget,</span></span></span><br><span class="line"><span class="function"><span class="params">  eventSystemFlags: EventSystemFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">  targetContainer: EventTarget,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 调用插件的 extractEvents 函数，用来提取事件函数</span></span><br><span class="line">  SimpleEventPlugin.extractEvents(</span><br><span class="line">    dispatchQueue,</span><br><span class="line">    domEventName,</span><br><span class="line">    targetInst,</span><br><span class="line">    nativeEvent,</span><br><span class="line">    nativeEventTarget,</span><br><span class="line">    eventSystemFlags,</span><br><span class="line">    targetContainer,</span><br><span class="line">  );</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// \react-dom-bindings\src\events\plugins\SimpleEventPlugin.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">extractEvents</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  dispatchQueue: DispatchQueue,</span></span></span><br><span class="line"><span class="function"><span class="params">  domEventName: DOMEventName,</span></span></span><br><span class="line"><span class="function"><span class="params">  targetInst: null | Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  nativeEvent: AnyNativeEvent,</span></span></span><br><span class="line"><span class="function"><span class="params">  nativeEventTarget: null | EventTarget,</span></span></span><br><span class="line"><span class="function"><span class="params">  eventSystemFlags: EventSystemFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">  targetContainer: EventTarget,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 1.根据原生事件名拿到 react 事件名</span></span><br><span class="line">  <span class="keyword">const</span> reactName = topLevelEventsToReactNames.get(domEventName);</span><br><span class="line">  <span class="keyword">if</span> (reactName === <span class="literal">undefined</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 2.定义一个合成事件</span></span><br><span class="line">  <span class="keyword">let</span> SyntheticEventCtor = SyntheticEvent;</span><br><span class="line">  <span class="keyword">let</span> reactEventType: string = domEventName;</span><br><span class="line">  <span class="comment">// 3.根据原生事件名调用不同的合成事件</span></span><br><span class="line">  <span class="keyword">switch</span> (domEventName) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'keypress'</span>:</span><br><span class="line">      <span class="comment">// Firefox creates a keypress event for function keys too. This removes</span></span><br><span class="line">      <span class="comment">// the unwanted keypress events. Enter is however both printable and</span></span><br><span class="line">      <span class="comment">// non-printable. One would expect Tab to be as well (but it isn't).</span></span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> Fixed in https://bugzilla.mozilla.org/show_bug.cgi?id=968056. Can</span></span><br><span class="line">      <span class="comment">// probably remove.</span></span><br><span class="line">      <span class="keyword">if</span> (getEventCharCode(((nativeEvent: any): KeyboardEvent)) === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="comment">/* falls through */</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">'keydown'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'keyup'</span>:</span><br><span class="line">      SyntheticEventCtor = SyntheticKeyboardEvent;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'focusin'</span>:</span><br><span class="line">      reactEventType = <span class="string">'focus'</span>;</span><br><span class="line">      SyntheticEventCtor = SyntheticFocusEvent;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'focusout'</span>:</span><br><span class="line">      reactEventType = <span class="string">'blur'</span>;</span><br><span class="line">      SyntheticEventCtor = SyntheticFocusEvent;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'beforeblur'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'afterblur'</span>:</span><br><span class="line">      SyntheticEventCtor = SyntheticFocusEvent;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'click'</span>:</span><br><span class="line">      <span class="comment">// Firefox creates a click event on right mouse clicks. This removes the</span></span><br><span class="line">      <span class="comment">// unwanted click events.</span></span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> Fixed in https://phabricator.services.mozilla.com/D26793. Can</span></span><br><span class="line">      <span class="comment">// probably remove.</span></span><br><span class="line">      <span class="keyword">if</span> (nativeEvent.button === <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="comment">/* falls through */</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">'auxclick'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'dblclick'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'mousedown'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'mousemove'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'mouseup'</span>:</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Disabled elements should not respond to mouse events</span></span><br><span class="line">    <span class="comment">/* falls through */</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">'mouseout'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'mouseover'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'contextmenu'</span>:</span><br><span class="line">      SyntheticEventCtor = SyntheticMouseEvent;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'drag'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'dragend'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'dragenter'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'dragexit'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'dragleave'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'dragover'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'dragstart'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'drop'</span>:</span><br><span class="line">      SyntheticEventCtor = SyntheticDragEvent;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'touchcancel'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'touchend'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'touchmove'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'touchstart'</span>:</span><br><span class="line">      SyntheticEventCtor = SyntheticTouchEvent;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ANIMATION_END:</span><br><span class="line">    <span class="keyword">case</span> ANIMATION_ITERATION:</span><br><span class="line">    <span class="keyword">case</span> ANIMATION_START:</span><br><span class="line">      SyntheticEventCtor = SyntheticAnimationEvent;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> TRANSITION_END:</span><br><span class="line">      SyntheticEventCtor = SyntheticTransitionEvent;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'scroll'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'scrollend'</span>:</span><br><span class="line">      SyntheticEventCtor = SyntheticUIEvent;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'wheel'</span>:</span><br><span class="line">      SyntheticEventCtor = SyntheticWheelEvent;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'copy'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'cut'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'paste'</span>:</span><br><span class="line">      SyntheticEventCtor = SyntheticClipboardEvent;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'gotpointercapture'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'lostpointercapture'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'pointercancel'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'pointerdown'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'pointermove'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'pointerout'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'pointerover'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'pointerup'</span>:</span><br><span class="line">      SyntheticEventCtor = SyntheticPointerEvent;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="comment">// Unknown event. This is used by createEventHandle.</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 是否是捕获阶段</span></span><br><span class="line">  <span class="keyword">const</span> inCapturePhase = (eventSystemFlags &amp; IS_CAPTURE_PHASE) !== <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> accumulateTargetOnly =</span><br><span class="line">    !inCapturePhase &amp;&amp;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> ideally, we'd eventually add all events from</span></span><br><span class="line">    <span class="comment">// nonDelegatedEvents list in DOMPluginEventSystem.</span></span><br><span class="line">    <span class="comment">// Then we can remove this special list.</span></span><br><span class="line">    <span class="comment">// This is a breaking change that can wait until React 18.</span></span><br><span class="line">    <span class="comment">// TODO：理想情况下，我们最终会将nonDelegatedEvents列表中的所有事件添加到DOMPluginEventSystem中。</span></span><br><span class="line">    <span class="comment">// 然后我们可以移除这个特殊列表。这是一个破坏性的变更，可以等到React 18再处理。</span></span><br><span class="line">    (domEventName === <span class="string">'scroll'</span> || domEventName === <span class="string">'scrollend'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 4.收集从事件源到事件绑定的地方所有的事件函数</span></span><br><span class="line">  <span class="keyword">const</span> listeners = accumulateSinglePhaseListeners(</span><br><span class="line">    targetInst,</span><br><span class="line">    reactName,</span><br><span class="line">    nativeEvent.type,</span><br><span class="line">    inCapturePhase,</span><br><span class="line">    accumulateTargetOnly,</span><br><span class="line">    nativeEvent,</span><br><span class="line">  );</span><br><span class="line">  <span class="comment">// 5.将事件函数保存到事件函数队列中</span></span><br><span class="line">  <span class="keyword">if</span> (listeners.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// Intentionally create event lazily.</span></span><br><span class="line">    <span class="keyword">const</span> event: ReactSyntheticEvent = <span class="keyword">new</span> SyntheticEventCtor(</span><br><span class="line">    reactName,</span><br><span class="line">    reactEventType,</span><br><span class="line">    <span class="literal">null</span>,</span><br><span class="line">    nativeEvent,</span><br><span class="line">    nativeEventTarget,</span><br><span class="line">    );</span><br><span class="line">    dispatchQueue.push(&#123;event, listeners&#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="processDispatchQueue"><a href="#processDispatchQueue" class="headerlink" title="processDispatchQueue"></a>processDispatchQueue</h3><p><code>processDispatchQueue</code> 函数主要功能是执行事件函数队列中的事件函数</p>
<p><code>dispatchQueue</code> 队列的数据结构如下:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    event, <span class="comment">// 合成事件对象</span></span><br><span class="line">    listeners: [事件源对应的事件函数, 事件源父节点对应的事件函数, ..., div#root 对应的事件函数], // 事件函数队列</span><br><span class="line">  &#125;,</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">processDispatchQueue</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  dispatchQueue: DispatchQueue,</span></span></span><br><span class="line"><span class="function"><span class="params">  eventSystemFlags: EventSystemFlags,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> inCapturePhase = (eventSystemFlags &amp; IS_CAPTURE_PHASE) !== <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; dispatchQueue.length; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;event, listeners&#125; = dispatchQueue[i];</span><br><span class="line">    processDispatchQueueItemsInOrder(event, listeners, inCapturePhase);</span><br><span class="line">    <span class="comment">//  event system doesn't use pooling.</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// This would be a good time to rethrow if any of the event handlers threw.</span></span><br><span class="line">  rethrowCaughtError();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>具体执行是由 <code>processDispatchQueueItemsInOrder</code> 执行</p>
<ol>
<li>判断是不是捕获阶段<ol>
<li>如果是捕获阶段，就从后往前执行</li>
<li>如果是冒泡阶段，就从前往后执行</li>
<li>在执行事件函数之前，如果事件被阻止了，则不在继续执行事件函数</li>
</ol>
</li>
<li>事件函数执行由 <code>executeDispatch</code> 函数完成</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">processDispatchQueueItemsInOrder</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  event: ReactSyntheticEvent,</span></span></span><br><span class="line"><span class="function"><span class="params">  dispatchListeners: Array&lt;DispatchListener&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  inCapturePhase: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> previousInstance;</span><br><span class="line">  <span class="keyword">if</span> (inCapturePhase) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = dispatchListeners.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123;instance, currentTarget, listener&#125; = dispatchListeners[i];</span><br><span class="line">      <span class="keyword">if</span> (instance !== previousInstance &amp;&amp; event.isPropagationStopped()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      executeDispatch(event, listener, currentTarget);</span><br><span class="line">      previousInstance = instance;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; dispatchListeners.length; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123;instance, currentTarget, listener&#125; = dispatchListeners[i];</span><br><span class="line">      <span class="keyword">if</span> (instance !== previousInstance &amp;&amp; event.isPropagationStopped()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      executeDispatch(event, listener, currentTarget);</span><br><span class="line">      previousInstance = instance;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="执行事件-executeDispatch"><a href="#执行事件-executeDispatch" class="headerlink" title="执行事件 - executeDispatch"></a>执行事件 - executeDispatch</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">executeDispatch</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  event: ReactSyntheticEvent,</span></span></span><br><span class="line"><span class="function"><span class="params">  listener: Function,</span></span></span><br><span class="line"><span class="function"><span class="params">  currentTarget: EventTarget,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> type = event.type || <span class="string">'unknown-event'</span>;</span><br><span class="line">  event.currentTarget = currentTarget;</span><br><span class="line">  invokeGuardedCallbackAndCatchFirstError(type, listener, <span class="literal">undefined</span>, event);</span><br><span class="line">  event.currentTarget = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="invokeGuardedCallbackAndCatchFirstError"><a href="#invokeGuardedCallbackAndCatchFirstError" class="headerlink" title="invokeGuardedCallbackAndCatchFirstError"></a>invokeGuardedCallbackAndCatchFirstError</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">invokeGuardedCallbackAndCatchFirstError</span>&lt;</span></span><br><span class="line"><span class="function">  <span class="title">A</span>,</span></span><br><span class="line"><span class="function">  <span class="title">B</span>,</span></span><br><span class="line"><span class="function">  <span class="title">C</span>,</span></span><br><span class="line"><span class="function">  <span class="title">D</span>,</span></span><br><span class="line"><span class="function">  <span class="title">E</span>,</span></span><br><span class="line"><span class="function">  <span class="title">F</span>,</span></span><br><span class="line"><span class="function">  <span class="title">Context</span>,</span></span><br><span class="line"><span class="function">&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  this: mixed,</span></span></span><br><span class="line"><span class="function"><span class="params">  name: string | null,</span></span></span><br><span class="line"><span class="function"><span class="params">  func: (a: A, b: B, c: C, d: D, e: E, f: F</span>) =&gt; <span class="title">void</span>,</span></span><br><span class="line"><span class="function">  <span class="title">context</span>: <span class="title">Context</span>,</span></span><br><span class="line"><span class="function">  <span class="title">a</span>: <span class="title">A</span>,</span></span><br><span class="line"><span class="function">  <span class="title">b</span>: <span class="title">B</span>,</span></span><br><span class="line"><span class="function">  <span class="title">c</span>: <span class="title">C</span>,</span></span><br><span class="line"><span class="function">  <span class="title">d</span>: <span class="title">D</span>,</span></span><br><span class="line"><span class="function">  <span class="title">e</span>: <span class="title">E</span>,</span></span><br><span class="line"><span class="function">  <span class="title">f</span>: <span class="title">F</span>,</span></span><br><span class="line"><span class="function">): <span class="title">void</span> </span>&#123;</span><br><span class="line">  invokeGuardedCallback.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">  <span class="keyword">if</span> (hasError) &#123;</span><br><span class="line">    <span class="keyword">const</span> error = clearCaughtError();</span><br><span class="line">    <span class="keyword">if</span> (!hasRethrowError) &#123;</span><br><span class="line">      hasRethrowError = <span class="literal">true</span>;</span><br><span class="line">      rethrowError = error;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">invokeGuardedCallback</span>&lt;<span class="title">A</span>, <span class="title">B</span>, <span class="title">C</span>, <span class="title">D</span>, <span class="title">E</span>, <span class="title">F</span>, <span class="title">Context</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  name: string | null,</span></span></span><br><span class="line"><span class="function"><span class="params">  func: (a: A, b: B, c: C, d: D, e: E, f: F</span>) =&gt; <span class="title">mixed</span>,</span></span><br><span class="line"><span class="function">  <span class="title">context</span>: <span class="title">Context</span>,</span></span><br><span class="line"><span class="function">  <span class="title">a</span>: <span class="title">A</span>,</span></span><br><span class="line"><span class="function">  <span class="title">b</span>: <span class="title">B</span>,</span></span><br><span class="line"><span class="function">  <span class="title">c</span>: <span class="title">C</span>,</span></span><br><span class="line"><span class="function">  <span class="title">d</span>: <span class="title">D</span>,</span></span><br><span class="line"><span class="function">  <span class="title">e</span>: <span class="title">E</span>,</span></span><br><span class="line"><span class="function">  <span class="title">f</span>: <span class="title">F</span>,</span></span><br><span class="line"><span class="function">): <span class="title">void</span> </span>&#123;</span><br><span class="line">  hasError = <span class="literal">false</span>;</span><br><span class="line">  caughtError = <span class="literal">null</span>;</span><br><span class="line">  invokeGuardedCallbackImpl.apply(reporter, <span class="built_in">arguments</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">invokeGuardedCallbackImpl</span>&lt;<span class="title">Args</span>: <span class="title">Array</span>&lt;<span class="title">mixed</span>&gt;, <span class="title">Context</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  this: &#123;onError: (error: mixed</span>) =&gt; <span class="title">void</span>&#125;,</span></span><br><span class="line"><span class="function">  <span class="title">name</span>: <span class="title">string</span> | <span class="title">null</span>,</span></span><br><span class="line"><span class="function">  <span class="title">func</span>: (<span class="params">...Args</span>) =&gt; <span class="title">mixed</span>,</span></span><br><span class="line"><span class="function">  <span class="title">context</span>: <span class="title">Context</span>,</span></span><br><span class="line"><span class="function">): <span class="title">void</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> funcArgs = <span class="built_in">Array</span>.prototype.slice.call(<span class="built_in">arguments</span>, <span class="number">3</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      func.apply(context, funcArgs);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="keyword">this</span>.onError(error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>事件系统核心原理比较简单，主要的作用是抹平各浏览器之间的差异。</p>
<p>通过 react 合成事件的学习，学习 react 对于事件系统的分层设计，它将不同类型的事件做成了插件，每个插件提供注册事件和提取事件两个接口，插件自身去实现事件的注册和事件提取。</p>
<p>这样做的好处是，当我们需要扩展新的事件时，只需要实现这两个接口就可以了，不需要修改原有的代码。</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/react18-2/" rel="tag"># react18.2</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/zh-CN/react18.2%E4%BB%A3%E7%A0%81%E6%89%93%E5%8D%B0%E9%A1%BA%E5%BA%8F%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90.html" rel="prev" title="react18.2代码打印顺序和流程分析">
      <i class="fa fa-chevron-left"></i> react18.2代码打印顺序和流程分析
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#事件注册"><span class="nav-number">1.</span> <span class="nav-text">事件注册</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#注册事件名"><span class="nav-number">1.1.</span> <span class="nav-text">注册事件名</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#不同类型的事件注册"><span class="nav-number">1.2.</span> <span class="nav-text">不同类型的事件注册</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#SimpleEventPlugin"><span class="nav-number">1.2.1.</span> <span class="nav-text">SimpleEventPlugin</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#EnterLeaveEventPlugin"><span class="nav-number">1.2.2.</span> <span class="nav-text">EnterLeaveEventPlugin</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ChangeEventPlugin"><span class="nav-number">1.2.3.</span> <span class="nav-text">ChangeEventPlugin</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SelectEventPlugin"><span class="nav-number">1.2.4.</span> <span class="nav-text">SelectEventPlugin</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#BeforeInputEventPlugin"><span class="nav-number">1.2.5.</span> <span class="nav-text">BeforeInputEventPlugin</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#事件绑定-listenToAllSupportedEvents"><span class="nav-number">1.3.</span> <span class="nav-text">事件绑定 - listenToAllSupportedEvents</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#listenToNativeEvent"><span class="nav-number">1.3.1.</span> <span class="nav-text">listenToNativeEvent</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#addTrappedEventListener"><span class="nav-number">1.3.2.</span> <span class="nav-text">addTrappedEventListener</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#createEventListenerWrapperWithPriority"><span class="nav-number">1.3.3.</span> <span class="nav-text">createEventListenerWrapperWithPriority</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#getEventPriority"><span class="nav-number">1.3.4.</span> <span class="nav-text">getEventPriority</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#事件挂载-捕获阶段"><span class="nav-number">1.3.5.</span> <span class="nav-text">事件挂载 - 捕获阶段</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#支持passive-addEventCaptureListenerWithPassiveFlag"><span class="nav-number">1.3.5.1.</span> <span class="nav-text">支持passive - addEventCaptureListenerWithPassiveFlag</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#addEventCaptureListener"><span class="nav-number">1.3.5.2.</span> <span class="nav-text">addEventCaptureListener</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#事件挂载-冒泡阶段"><span class="nav-number">1.3.6.</span> <span class="nav-text">事件挂载 - 冒泡阶段</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#支持passive-addEventBubbleListenerWithPassiveFlag"><span class="nav-number">1.3.6.1.</span> <span class="nav-text">支持passive - addEventBubbleListenerWithPassiveFlag</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#addEventBubbleListener"><span class="nav-number">1.3.6.2.</span> <span class="nav-text">addEventBubbleListener</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#事件派发"><span class="nav-number">2.</span> <span class="nav-text">事件派发</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#dispatchDiscreteEvent"><span class="nav-number">2.1.</span> <span class="nav-text">dispatchDiscreteEvent</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#事件优先级记录"><span class="nav-number">2.1.1.</span> <span class="nav-text">事件优先级记录</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dispatchContinuousEvent"><span class="nav-number">2.2.</span> <span class="nav-text">dispatchContinuousEvent</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dispatchEvent"><span class="nav-number">2.3.</span> <span class="nav-text">dispatchEvent</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#findInstanceBlockingEvent"><span class="nav-number">2.3.1.</span> <span class="nav-text">findInstanceBlockingEvent</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dispatchEventForPluginEventSystem"><span class="nav-number">2.3.2.</span> <span class="nav-text">dispatchEventForPluginEventSystem</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#batchedUpdates"><span class="nav-number">2.3.3.</span> <span class="nav-text">batchedUpdates</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dispatchEventsForPlugins"><span class="nav-number">2.4.</span> <span class="nav-text">dispatchEventsForPlugins</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#extractEvents"><span class="nav-number">2.5.</span> <span class="nav-text">extractEvents</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#processDispatchQueue"><span class="nav-number">2.6.</span> <span class="nav-text">processDispatchQueue</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#执行事件-executeDispatch"><span class="nav-number">2.7.</span> <span class="nav-text">执行事件 - executeDispatch</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#invokeGuardedCallbackAndCatchFirstError"><span class="nav-number">2.7.1.</span> <span class="nav-text">invokeGuardedCallbackAndCatchFirstError</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">3.</span> <span class="nav-text">总结</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="rile"
      src="/images/Trevor.jpeg">
  <p class="site-author-name" itemprop="name">rile</p>
  <div class="site-description" itemprop="description">FE</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">42</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Rile14929" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Rile14929" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:rile14929@163.com" title="E-Mail → mailto:rile14929@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2020 – 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-rocket"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">rile</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
