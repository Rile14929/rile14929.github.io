<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"rile14929.github.io","root":"/","scheme":"Pisces","version":"7.7.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="1. 入口 - createRoot APIcreateRoot 允许在浏览器的 DOM 节点创建根节点以显示 React 组件。 1234import &amp;#123; createRoot &amp;#125; from &quot;react-dom&#x2F;client&quot;;import jsx from &quot;.&#x2F;pages&#x2F;ExamplePage&quot;;const root &#x3D; createRoot(document.get">
<meta property="og:type" content="article">
<meta property="og:title" content="react18.2源码分析（一） 应用加载">
<meta property="og:url" content="https://rile14929.github.io/zh-CN/react%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%88%E4%B8%80%EF%BC%89%20%E5%BA%94%E7%94%A8%E5%8A%A0%E8%BD%BD.html">
<meta property="og:site_name" content="右耳听风">
<meta property="og:description" content="1. 入口 - createRoot APIcreateRoot 允许在浏览器的 DOM 节点创建根节点以显示 React 组件。 1234import &amp;#123; createRoot &amp;#125; from &quot;react-dom&#x2F;client&quot;;import jsx from &quot;.&#x2F;pages&#x2F;ExamplePage&quot;;const root &#x3D; createRoot(document.get">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2024-04-30T16:00:00.000Z">
<meta property="article:modified_time" content="2024-04-30T16:00:00.000Z">
<meta property="article:author" content="rile">
<meta property="article:tag" content="react18.2">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://rile14929.github.io/zh-CN/react%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%88%E4%B8%80%EF%BC%89%20%E5%BA%94%E7%94%A8%E5%8A%A0%E8%BD%BD.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>react18.2源码分析（一） 应用加载 | 右耳听风</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">右耳听风</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tag"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://rile14929.github.io/zh-CN/react%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%88%E4%B8%80%EF%BC%89%20%E5%BA%94%E7%94%A8%E5%8A%A0%E8%BD%BD.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/Trevor.jpeg">
      <meta itemprop="name" content="rile">
      <meta itemprop="description" content="FE">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="右耳听风">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          react18.2源码分析（一） 应用加载
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-05-01 00:00:00" itemprop="dateCreated datePublished" datetime="2024-05-01T00:00:00+08:00">2024-05-01</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="1-入口-createRoot-API"><a href="#1-入口-createRoot-API" class="headerlink" title="1. 入口 - createRoot API"></a>1. 入口 - createRoot API</h2><p><code>createRoot</code> 允许在浏览器的 DOM 节点创建根节点以显示 React 组件。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createRoot &#125; <span class="keyword">from</span> <span class="string">"react-dom/client"</span>;</span><br><span class="line"><span class="keyword">import</span> jsx <span class="keyword">from</span> <span class="string">"./pages/ExamplePage"</span>;</span><br><span class="line"><span class="keyword">const</span> root = createRoot(<span class="built_in">document</span>.getElementById(<span class="string">"root"</span>));</span><br><span class="line">root.render(jsx);</span><br></pre></td></tr></table></figure>

<p><code>createRoot</code> 接收两个参数 <code>container</code> 和 <code>options</code>，返回一个 <code>RootType</code> 类型，即 <code>ReactDOMRoot</code> 的实例。</p>
<p><font color=gray><em>packages\react-dom\src\client\ReactDOMRoot.js</em></font></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">export type RootType &#x3D; &#123;</span><br><span class="line">  render(children: ReactNodeList): void,</span><br><span class="line">  unmount(): void,</span><br><span class="line">  _internalRoot: FiberRoot | null,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">export type CreateRootOptions &#x3D; &#123;</span><br><span class="line">  unstable_strictMode?: boolean,</span><br><span class="line">  unstable_concurrentUpdatesByDefault?: boolean,</span><br><span class="line">  unstable_transitionCallbacks?: TransitionTracingCallbacks,</span><br><span class="line">  identifierPrefix?: string,</span><br><span class="line">  onRecoverableError?: (error: mixed) &#x3D;&gt; void,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">export function createRoot(</span><br><span class="line">  container: Element | Document | DocumentFragment,</span><br><span class="line">  options?: CreateRootOptions, &#x2F;&#x2F; 有两个参数可用，其余的属于非稳定值，不要使用</span><br><span class="line">): RootType &#123;</span><br><span class="line">  &#x2F;&#x2F; 1. 检查container是否是DOM</span><br><span class="line">  if (!isValidContainer(container)) &#123;</span><br><span class="line">    throw new Error(&#39;createRoot(...): Target container is not a DOM element.&#39;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  warnIfReactDOMContainerInDEV(container);</span><br><span class="line"></span><br><span class="line">  let isStrictMode &#x3D; false;</span><br><span class="line">  let concurrentUpdatesByDefaultOverride &#x3D; false;</span><br><span class="line">  let identifierPrefix &#x3D; &#39;&#39;;</span><br><span class="line">  let onRecoverableError &#x3D; defaultOnRecoverableError;</span><br><span class="line">  let transitionCallbacks &#x3D; null;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; 2. 检查options</span><br><span class="line">  if (options !&#x3D;&#x3D; null &amp;&amp; options !&#x3D;&#x3D; undefined) &#123;</span><br><span class="line">    if (options.unstable_strictMode &#x3D;&#x3D;&#x3D; true) &#123;</span><br><span class="line">      isStrictMode &#x3D; true;</span><br><span class="line">    &#125;</span><br><span class="line">    if (</span><br><span class="line">      allowConcurrentByDefault &amp;&amp;</span><br><span class="line">      options.unstable_concurrentUpdatesByDefault &#x3D;&#x3D;&#x3D; true</span><br><span class="line">    ) &#123;</span><br><span class="line">      concurrentUpdatesByDefaultOverride &#x3D; true;</span><br><span class="line">    &#125;</span><br><span class="line">    if (options.identifierPrefix !&#x3D;&#x3D; undefined) &#123;</span><br><span class="line">      identifierPrefix &#x3D; options.identifierPrefix;</span><br><span class="line">    &#125;</span><br><span class="line">    if (options.onRecoverableError !&#x3D;&#x3D; undefined) &#123;</span><br><span class="line">      onRecoverableError &#x3D; options.onRecoverableError;</span><br><span class="line">    &#125;</span><br><span class="line">    if (options.unstable_transitionCallbacks !&#x3D;&#x3D; undefined) &#123;</span><br><span class="line">      transitionCallbacks &#x3D; options.unstable_transitionCallbacks;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; 3. 创建FiberRoot</span><br><span class="line">  const root: FiberRoot &#x3D; createContainer(</span><br><span class="line">    container,</span><br><span class="line">    ConcurrentRoot,</span><br><span class="line">    null,</span><br><span class="line">    isStrictMode,</span><br><span class="line">    concurrentUpdatesByDefaultOverride,</span><br><span class="line">    identifierPrefix,</span><br><span class="line">    onRecoverableError,</span><br><span class="line">    transitionCallbacks,</span><br><span class="line">  );</span><br><span class="line">  &#x2F;&#x2F; 4. 标记Container是根Fiber</span><br><span class="line">  markContainerAsRoot(root.current, container);</span><br><span class="line">  Dispatcher.current &#x3D; ReactDOMClientDispatcher;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; comment nodes 已弃用，这里是为了兼容FB老代码 https:&#x2F;&#x2F;github.com&#x2F;facebook&#x2F;react&#x2F;pull&#x2F;24110</span><br><span class="line">  const rootContainerElement: Document | Element | DocumentFragment &#x3D;</span><br><span class="line">    container.nodeType &#x3D;&#x3D;&#x3D; COMMENT_NODE</span><br><span class="line">      ? (container.parentNode: any)</span><br><span class="line">      : container;</span><br><span class="line">  &#x2F;&#x2F; 5. 从Container层监听listenToAllSupportedEvents</span><br><span class="line">  listenToAllSupportedEvents(rootContainerElement);</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; 6. 返回ReactDOMRoot实例</span><br><span class="line">  return new ReactDOMRoot(root);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-检查container是否是DOM"><a href="#1-检查container是否是DOM" class="headerlink" title="1. 检查container是否是DOM"></a>1. 检查container是否是DOM</h3><p>如果不是，则抛出错误提示。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!isValidContainer(container)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'createRoot(...): Target container is not a DOM element.'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-检查options"><a href="#2-检查options" class="headerlink" title="2. 检查options"></a>2. 检查options</h3><p>⽬前⽂档中有两个参数可⽤： onRecoverableError 与 identifierPrefix 。</p>
<p>但是源码中实际上还有⼀些 unstable 值，属于⾮稳定值，不要使⽤.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> CreateRootOptions = &#123;</span><br><span class="line">  unstable_strictMode?: <span class="built_in">boolean</span>,</span><br><span class="line">  unstable_concurrentUpdatesByDefault?: <span class="built_in">boolean</span>,</span><br><span class="line">  unstable_transitionCallbacks?: TransitionTracingCallbacks,</span><br><span class="line">  identifierPrefix?: <span class="built_in">string</span>,</span><br><span class="line">  onRecoverableError?: <span class="function">(<span class="params">error: mixed</span>) =&gt;</span> <span class="built_in">void</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="3-createContainer-创建-FiberRoot，-即root"><a href="#3-createContainer-创建-FiberRoot，-即root" class="headerlink" title="3. createContainer 创建 FiberRoot， 即root"></a>3. createContainer 创建 FiberRoot， 即root</h3><p>这⾥的 <code>containerInfo</code> 就是根 <code>dom</code> 节点。(就是那个 id 为 root 的div)。这个变量在 <code>createRoot</code> ⾥叫 <code>container</code> ，到这⾥换名成了 <code>containerInfo</code> 。</p>
<p><font color=gray><em>packages\react-reconciler\src\ReactFiberReconciler.js</em></font></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createContainer</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  containerInfo: Container,</span></span></span><br><span class="line"><span class="function"><span class="params">  tag: RootTag,</span></span></span><br><span class="line"><span class="function"><span class="params">  hydrationCallbacks: null | SuspenseHydrationCallbacks,</span></span></span><br><span class="line"><span class="function"><span class="params">  isStrictMode: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params">  concurrentUpdatesByDefaultOverride: null | boolean,</span></span></span><br><span class="line"><span class="function"><span class="params">  identifierPrefix: string,</span></span></span><br><span class="line"><span class="function"><span class="params">  onRecoverableError: (error: mixed</span>) =&gt; <span class="title">void</span>,</span></span><br><span class="line"><span class="function">  <span class="title">transitionCallbacks</span>: <span class="title">null</span> | <span class="title">TransitionTracingCallbacks</span>,</span></span><br><span class="line"><span class="function">): <span class="title">OpaqueRoot</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> hydrate = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">const</span> initialChildren = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">return</span> createFiberRoot(</span><br><span class="line">    containerInfo,</span><br><span class="line">    tag,</span><br><span class="line">    hydrate,</span><br><span class="line">    initialChildren,</span><br><span class="line">    hydrationCallbacks,</span><br><span class="line">    isStrictMode,</span><br><span class="line">    concurrentUpdatesByDefaultOverride,</span><br><span class="line">    identifierPrefix,</span><br><span class="line">    onRecoverableError,</span><br><span class="line">    transitionCallbacks,</span><br><span class="line">    <span class="literal">null</span>,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>createFiberRoot</code> 创建并返回 <code>FiberRoot</code></p>
<p><font color=gray><em>packages\react-reconciler\src\ReactFiberRoot.js</em></font></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createFiberRoot</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  containerInfo: Container,</span></span></span><br><span class="line"><span class="function"><span class="params">  tag: RootTag,</span></span></span><br><span class="line"><span class="function"><span class="params">  hydrate: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  initialChildren: ReactNodeList,</span></span></span><br><span class="line"><span class="function"><span class="params">  hydrationCallbacks: <span class="literal">null</span> | SuspenseHydrationCallbacks,</span></span></span><br><span class="line"><span class="function"><span class="params">  isStrictMode: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  concurrentUpdatesByDefaultOverride: <span class="literal">null</span> | <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="comment">// <span class="doctag">TODO:</span> We have several of these arguments that are conceptually part of the</span></span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="comment">// host config, but because they are passed in at runtime, we have to thread</span></span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="comment">// them through the root constructor. Perhaps we should put them all into a</span></span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="comment">// single type, like a DynamicHostConfig that is defined by the renderer.</span></span></span></span><br><span class="line"><span class="function"><span class="params">  identifierPrefix: <span class="built_in">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  onRecoverableError: <span class="literal">null</span> | ((error: mixed) =&gt; <span class="built_in">void</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">  transitionCallbacks: <span class="literal">null</span> | TransitionTracingCallbacks,</span></span></span><br><span class="line"><span class="function"><span class="params">  formState: ReactFormState&lt;<span class="built_in">any</span>, <span class="built_in">any</span>&gt; | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">FiberRoot</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 1. fiberRoot 表示Fiber数据结构对象， 是Fiber数据结构中的最外层对象。</span></span><br><span class="line">  <span class="keyword">const</span> root: FiberRoot = (<span class="keyword">new</span> FiberRootNode(</span><br><span class="line">    containerInfo,</span><br><span class="line">    tag,</span><br><span class="line">    hydrate,</span><br><span class="line">    identifierPrefix,</span><br><span class="line">    onRecoverableError,</span><br><span class="line">    formState,</span><br><span class="line">  ): <span class="built_in">any</span>);</span><br><span class="line">  <span class="comment">// 2. rootFiber表示组件挂载点对应的Fiber对象，比如React应用中默认的组件挂载点就是id为root的div。</span></span><br><span class="line">  <span class="keyword">const</span> uninitializedFiber: Fiber = createHostRootFiber(</span><br><span class="line">    tag,</span><br><span class="line">    isStrictMode,</span><br><span class="line">    concurrentUpdatesByDefaultOverride,</span><br><span class="line">  );</span><br><span class="line">  <span class="comment">// 3. 循环构造root 和 uninitializedFiber</span></span><br><span class="line">  <span class="comment">// fiberRoot包含rootFiber，在fiberRoot对象中有一个current属性，存储rootFiber。</span></span><br><span class="line">  root.current = uninitializedFiber;</span><br><span class="line">  <span class="comment">// rootFiber指向fiberRoot，在rootFiber对象中有一个stateNode属性，指向fiberRoot。</span></span><br><span class="line">  uninitializedFiber.stateNode = root;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 在React应用中，可支持多个根节点fiberRoot，每一个 fiberRoot 下可以有多个 rootFiber ，因为 render 方法是可以调用多次的。</span></span><br><span class="line">  <span class="comment">// FiberRoot 会记录应用的更新信息，比如协调器在完成工作后，会将工作成果存储在fiberRoot中。</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableCache) &#123;</span><br><span class="line">    <span class="comment">// sy</span></span><br><span class="line">    <span class="keyword">const</span> initialCache = createCache();</span><br><span class="line">    retainCache(initialCache);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The pooledCache is a fresh cache instance that is used temporarily</span></span><br><span class="line">    <span class="comment">// for newly mounted boundaries during a render. In general, the</span></span><br><span class="line">    <span class="comment">// pooledCache is always cleared from the root at the end of a render:</span></span><br><span class="line">    <span class="comment">// it is either released when render commits, or moved to an Offscreen</span></span><br><span class="line">    <span class="comment">// component if rendering suspends. Because the lifetime of the pooled</span></span><br><span class="line">    <span class="comment">// cache is distinct from the main memoizedState.cache, it must be</span></span><br><span class="line">    <span class="comment">// retained separately.</span></span><br><span class="line">    root.pooledCache = initialCache;</span><br><span class="line">    retainCache(initialCache);</span><br><span class="line">    <span class="keyword">const</span> initialState: RootState = &#123;</span><br><span class="line">      element: initialChildren,</span><br><span class="line">      isDehydrated: hydrate,</span><br><span class="line">      cache: initialCache,</span><br><span class="line">    &#125;;</span><br><span class="line">    uninitializedFiber.memoizedState = initialState;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> initialState: RootState = &#123;</span><br><span class="line">      element: initialChildren,</span><br><span class="line">      isDehydrated: hydrate,</span><br><span class="line">      cache: (<span class="literal">null</span>: <span class="built_in">any</span>), <span class="comment">// not enabled yet</span></span><br><span class="line">    &#125;;</span><br><span class="line">    uninitializedFiber.memoizedState = initialState;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 4. 初始化 initializeUpdateQueue</span></span><br><span class="line">  initializeUpdateQueue(uninitializedFiber);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> root;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-1-实例化-FiberRootNode，创建-FiberRoot"><a href="#3-1-实例化-FiberRootNode，创建-FiberRoot" class="headerlink" title="3.1 实例化 FiberRootNode，创建 FiberRoot"></a>3.1 实例化 FiberRootNode，创建 FiberRoot</h4><p><font color=gray><em>packages\react-reconciler\src\ReactFiberRoot.js</em></font></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">FiberRootNode</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  this: $FlowFixMe,</span></span></span><br><span class="line"><span class="function"><span class="params">  containerInfo: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  tag,</span></span></span><br><span class="line"><span class="function"><span class="params">  hydrate: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  identifierPrefix: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  onRecoverableError: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  formState: ReactFormState&lt;any, any&gt; | null,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.tag = tag;</span><br><span class="line">  <span class="keyword">this</span>.containerInfo = containerInfo;</span><br><span class="line">  <span class="keyword">this</span>.pendingChildren = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.current = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.pingCache = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.finishedWork = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.timeoutHandle = noTimeout;</span><br><span class="line">  <span class="keyword">this</span>.cancelPendingCommit = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.context = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.pendingContext = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.next = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.callbackNode = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.callbackPriority = NoLane;</span><br><span class="line">  <span class="keyword">this</span>.expirationTimes = createLaneMap(NoTimestamp);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.pendingLanes = NoLanes;</span><br><span class="line">  <span class="keyword">this</span>.suspendedLanes = NoLanes;</span><br><span class="line">  <span class="keyword">this</span>.pingedLanes = NoLanes;</span><br><span class="line">  <span class="keyword">this</span>.expiredLanes = NoLanes;</span><br><span class="line">  <span class="keyword">this</span>.finishedLanes = NoLanes;</span><br><span class="line">  <span class="keyword">this</span>.errorRecoveryDisabledLanes = NoLanes;</span><br><span class="line">  <span class="keyword">this</span>.shellSuspendCounter = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 记录当前更新与其他更新之间的关联性，即它们之间存在依赖或相关性。</span></span><br><span class="line">  <span class="comment">// 当一个更新被触发时，React 会根据其依赖关系计算出 entangledLanes，这些 entangledLanes 表示与当前更新相关联的其他更新的 Lanes。</span></span><br><span class="line">  <span class="keyword">this</span>.entangledLanes = NoLanes;</span><br><span class="line">  <span class="keyword">this</span>.entanglements = createLaneMap(NoLanes);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.hiddenUpdates = createLaneMap(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.identifierPrefix = identifierPrefix;</span><br><span class="line">  <span class="keyword">this</span>.onRecoverableError = onRecoverableError;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableCache) &#123;</span><br><span class="line">    <span class="keyword">this</span>.pooledCache = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">this</span>.pooledCacheLanes = NoLanes;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableSuspenseCallback) &#123;</span><br><span class="line">    <span class="keyword">this</span>.hydrationCallbacks = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.formState = formState;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.incompleteTransitions = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line">  <span class="keyword">if</span> (enableTransitionTracing) &#123;</span><br><span class="line">    <span class="keyword">this</span>.transitionCallbacks = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">const</span> transitionLanesMap = (<span class="keyword">this</span>.transitionLanes = []);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; TotalLanes; i++) &#123;</span><br><span class="line">      transitionLanesMap.push(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; enableProfilerCommitHooks) &#123;</span><br><span class="line">    <span class="keyword">this</span>.effectDuration = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">this</span>.passiveEffectDuration = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableUpdaterTracking) &#123;</span><br><span class="line">    <span class="keyword">this</span>.memoizedUpdaters = <span class="keyword">new</span> <span class="built_in">Set</span>();</span><br><span class="line">    <span class="keyword">const</span> pendingUpdatersLaneMap = (<span class="keyword">this</span>.pendingUpdatersLaneMap = []);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; TotalLanes; i++) &#123;</span><br><span class="line">      pendingUpdatersLaneMap.push(<span class="keyword">new</span> <span class="built_in">Set</span>());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-2-createHostRootFiber-创建原生标签的根-Fiber"><a href="#3-2-createHostRootFiber-创建原生标签的根-Fiber" class="headerlink" title="3.2 createHostRootFiber 创建原生标签的根 Fiber"></a>3.2 createHostRootFiber 创建原生标签的根 Fiber</h4><p>注意这⾥创建的是 <code>Fiber</code> 只是属于根部的 <code>Fiber</code> 。和 3.1 的 <code>FiberRoot</code> 不同，<code>FiberRoot</code> 与 <code>Fiber</code> 是两个类型。</p>
<p><font color=gray><em>packages\react-reconciler\src\ReactFiber.js</em></font></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createHostRootFiber</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  tag: RootTag,</span></span></span><br><span class="line"><span class="function"><span class="params">  isStrictMode: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params">  concurrentUpdatesByDefaultOverride: null | boolean,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> mode;</span><br><span class="line">  <span class="keyword">if</span> (tag === ConcurrentRoot) &#123;</span><br><span class="line">    mode = ConcurrentMode;</span><br><span class="line">    <span class="keyword">if</span> (isStrictMode === <span class="literal">true</span>) &#123;</span><br><span class="line">      mode |= StrictLegacyMode | StrictEffectsMode;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      <span class="comment">// We only use this flag for our repo tests to check both behaviors.</span></span><br><span class="line">      forceConcurrentByDefaultForTesting</span><br><span class="line">    ) &#123;</span><br><span class="line">      mode |= ConcurrentUpdatesByDefaultMode;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">      <span class="comment">// Only for internal experiments.</span></span><br><span class="line">      allowConcurrentByDefault &amp;&amp;</span><br><span class="line">      concurrentUpdatesByDefaultOverride</span><br><span class="line">    ) &#123;</span><br><span class="line">      mode |= ConcurrentUpdatesByDefaultMode;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    mode = NoMode;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; isDevToolsPresent) &#123;</span><br><span class="line">    <span class="comment">// Always collect profile timings when DevTools are present.</span></span><br><span class="line">    <span class="comment">// This enables DevTools to start capturing timing at any point–</span></span><br><span class="line">    <span class="comment">// Without some nodes in the tree having empty base times.</span></span><br><span class="line">    mode |= ProfileMode;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> createFiber(HostRoot, <span class="literal">null</span>, <span class="literal">null</span>, mode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createFiber</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  tag: WorkTag,</span></span></span><br><span class="line"><span class="function"><span class="params">  pendingProps: mixed,</span></span></span><br><span class="line"><span class="function"><span class="params">  key: null | string,</span></span></span><br><span class="line"><span class="function"><span class="params">  mode: TypeOfMode,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> FiberNode(tag, pendingProps, key, mode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">FiberNode</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  this: $FlowFixMe,</span></span></span><br><span class="line"><span class="function"><span class="params">  tag: WorkTag,</span></span></span><br><span class="line"><span class="function"><span class="params">  pendingProps: mixed,</span></span></span><br><span class="line"><span class="function"><span class="params">  key: null | string,</span></span></span><br><span class="line"><span class="function"><span class="params">  mode: TypeOfMode,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Instance</span></span><br><span class="line">  <span class="keyword">this</span>.tag = tag; <span class="comment">// 组件类型</span></span><br><span class="line">  <span class="keyword">this</span>.key = key; <span class="comment">// 组件props上的key</span></span><br><span class="line">  <span class="keyword">this</span>.elementType = <span class="literal">null</span>; <span class="comment">// ReactElement.type 组件的dom类型， 比如`div, p`</span></span><br><span class="line">  <span class="keyword">this</span>.type = <span class="literal">null</span>; <span class="comment">// 异步组件resolved之后返回的内容</span></span><br><span class="line">  <span class="keyword">this</span>.stateNode = <span class="literal">null</span>; <span class="comment">// 在浏览器环境对应dom节点</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Fiber</span></span><br><span class="line">  <span class="keyword">this</span>.return = <span class="literal">null</span>; <span class="comment">// 指向父节点</span></span><br><span class="line">  <span class="keyword">this</span>.child = <span class="literal">null</span>; <span class="comment">// 孩子节点</span></span><br><span class="line">  <span class="keyword">this</span>.sibling = <span class="literal">null</span>; <span class="comment">// 兄弟节点， 兄弟节点的return指向同一个父节点</span></span><br><span class="line">  <span class="keyword">this</span>.index = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.ref = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.refCleanup = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.pendingProps = pendingProps; <span class="comment">// 新的props</span></span><br><span class="line">  <span class="keyword">this</span>.memoizedProps = <span class="literal">null</span>; <span class="comment">// 上一次渲染完成的props</span></span><br><span class="line">  <span class="keyword">this</span>.updateQueue = <span class="literal">null</span>; <span class="comment">// 组件产生的update信息会放在这个队列</span></span><br><span class="line">  <span class="keyword">this</span>.memoizedState = <span class="literal">null</span>; <span class="comment">// 上一次渲染完成的state</span></span><br><span class="line">  <span class="keyword">this</span>.dependencies = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.mode = mode;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Effects</span></span><br><span class="line">  <span class="keyword">this</span>.flags = NoFlags; <span class="comment">// 相当于之前的effectTag， 记录side effect类型</span></span><br><span class="line">  <span class="keyword">this</span>.subtreeFlags = NoFlags;</span><br><span class="line">  <span class="keyword">this</span>.deletions = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.lanes = NoLanes;     <span class="comment">// 优先级相关</span></span><br><span class="line">  <span class="keyword">this</span>.childLanes = NoLanes;  <span class="comment">// 优先级相关</span></span><br><span class="line">  <span class="keyword">this</span>.alternate = <span class="literal">null</span>;    <span class="comment">// 对应的是current fiber</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-3-循环构造-root-和-uninitializedFiber"><a href="#3-3-循环构造-root-和-uninitializedFiber" class="headerlink" title="3.3 循环构造 root 和 uninitializedFiber"></a>3.3 循环构造 root 和 uninitializedFiber</h4><p><code>root.current</code> 是 <code>Fiber</code><br><code>uninitializedFiber.stateNode</code> 是根 <code>FiberRoot</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root.current = uninitializedFiber; <span class="comment">// Fiber</span></span><br><span class="line">uninitializedFiber.stateNode = root; <span class="comment">// FiberRoot</span></span><br></pre></td></tr></table></figure>

<h4 id="3-4-初始化-initializeUpdateQueue"><a href="#3-4-初始化-initializeUpdateQueue" class="headerlink" title="3.4 初始化 initializeUpdateQueue"></a>3.4 初始化 initializeUpdateQueue</h4><p>类似fiber，update queues也是成对出现的，一个已经完成的即对应目前页面，一个正在工作中的。</p>
<p><font color=gray><em>packages\react-reconciler\src\ReactFiberClassUpdateQueue.js</em></font></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> type Update&lt;State&gt; = &#123;</span><br><span class="line">  lane: Lane,</span><br><span class="line"></span><br><span class="line">  tag: <span class="number">0</span> | <span class="number">1</span> | <span class="number">2</span> | <span class="number">3</span>,</span><br><span class="line">  payload: any,</span><br><span class="line">  callback: <span class="function">(<span class="params">(</span>) =&gt;</span> mixed) | <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">  next: Update&lt;State&gt; | <span class="literal">null</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> type SharedQueue&lt;State&gt; = &#123;</span><br><span class="line">  pending: Update&lt;State&gt; | <span class="literal">null</span>, <span class="comment">// 单向循环链表</span></span><br><span class="line">  lanes: Lanes,</span><br><span class="line">  <span class="comment">// 如果类组件是Activity(以前叫OffScreen)的后代组件，需要延迟执行的其setState的callback。这里是先暂时收集，commit阶段提交</span></span><br><span class="line">  <span class="comment">// Activity目前还是unstable，了解即可~</span></span><br><span class="line">  hiddenCallbacks: <span class="built_in">Array</span>&lt;<span class="function"><span class="params">()</span> =&gt;</span> mixed&gt; | <span class="literal">null</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> type UpdateQueue&lt;State&gt; = &#123;</span><br><span class="line">  baseState: State,</span><br><span class="line">  <span class="comment">// 单链表 firstBaseUpdate-&gt;...-&gt;lastBaseUpdate</span></span><br><span class="line">  firstBaseUpdate: Update&lt;State&gt; | <span class="literal">null</span>,</span><br><span class="line">  lastBaseUpdate: Update&lt;State&gt; | <span class="literal">null</span>,</span><br><span class="line">  shared: SharedQueue&lt;State&gt;,</span><br><span class="line">  callbacks: <span class="built_in">Array</span>&lt;<span class="function"><span class="params">()</span> =&gt;</span> mixed&gt; | <span class="literal">null</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这里初始化fiber.updateQueue</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">initializeUpdateQueue</span>&lt;<span class="title">State</span>&gt;(<span class="params">fiber: Fiber</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> queue: UpdateQueue&lt;State&gt; = &#123;</span><br><span class="line">    baseState: fiber.memoizedState,</span><br><span class="line">    firstBaseUpdate: <span class="literal">null</span>,</span><br><span class="line">    lastBaseUpdate: <span class="literal">null</span>,</span><br><span class="line">    shared: &#123;</span><br><span class="line">      pending: <span class="literal">null</span>,</span><br><span class="line">      lanes: NoLanes,</span><br><span class="line">      hiddenCallbacks: <span class="literal">null</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    callbacks: <span class="literal">null</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">  fiber.updateQueue = queue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-markContainerAsRoot-标记-Container-是根-Fiber"><a href="#4-markContainerAsRoot-标记-Container-是根-Fiber" class="headerlink" title="4. markContainerAsRoot 标记 Container 是根 Fiber"></a>4. markContainerAsRoot 标记 Container 是根 Fiber</h3><p>这个函数给container根DOM节点赋值根Fiber</p>
<p><font color=gray><em>packages\react-dom-bindings\src\client\ReactDOMComponentTree.js</em></font></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> randomKey = <span class="built_in">Math</span>.random().toString(<span class="number">36</span>).slice(<span class="number">2</span>);</span><br><span class="line"><span class="keyword">const</span> internalContainerInstanceKey = <span class="string">'__reactContainer$'</span> + randomKey;</span><br><span class="line"><span class="comment">// 标记根节点</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">markContainerAsRoot</span>(<span class="params">hostRoot: Fiber, node: Container</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  node[internalContainerInstanceKey] = hostRoot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个属性值在函数中用于 getClosestInstanceFromNode 和 getInstanceFromNode 中会用于根据根DOM去Fiber值。</p>
<p>对应的还有两个函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 取消标记，在ReactDOMRoot.prototype.unmount函数里调用</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">unmarkContainerAsRoot</span>(<span class="params">node: Container</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  node[internalContainerInstanceKey] = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 检查是否被标记为根节点</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">isContainerMarkedAsRoot</span>(<span class="params">node: Container</span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> !!node[internalContainerInstanceKey];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-从Container层监听listenToAllSupportedEvents"><a href="#5-从Container层监听listenToAllSupportedEvents" class="headerlink" title="5. 从Container层监听listenToAllSupportedEvents"></a>5. 从Container层监听listenToAllSupportedEvents</h3><p>react事件比较复杂，后续事件文章展开写。</p>
<h3 id="6-返回ReactDOMRoot实例"><a href="#6-返回ReactDOMRoot实例" class="headerlink" title="6. 返回ReactDOMRoot实例"></a>6. 返回ReactDOMRoot实例</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> ReactDOMRoot(root);</span><br></pre></td></tr></table></figure>
<p>ReactDOMRoot 函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ReactDOMRoot</span>(<span class="params">internalRoot: FiberRoot</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>._internalRoot = internalRoot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-加载-执行-render-函数"><a href="#2-加载-执行-render-函数" class="headerlink" title="2. 加载 - 执行 render 函数"></a>2. 加载 - 执行 render 函数</h2><p><code>createRoot</code> 会返回 <code>RootType</code> 类型，即 <code>ReactDOMRoot</code> 的实例。</p>
<p><font color=gray><em>packages\react-dom\src\client\ReactDOMRoot.js</em></font></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> type RootType = &#123;</span><br><span class="line">  render(children: ReactNodeList): <span class="keyword">void</span>,</span><br><span class="line">  unmount(): <span class="keyword">void</span>,</span><br><span class="line">  _internalRoot: FiberRoot | <span class="literal">null</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ReactDOMRoot</span>(<span class="params">internalRoot: FiberRoot</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>._internalRoot = internalRoot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ReactDOMHydrationRoot.prototype.render = ReactDOMRoot.prototype.render =</span><br><span class="line">  <span class="function"><span class="keyword">function</span> (<span class="params">children: ReactNodeList</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> root = <span class="keyword">this</span>._internalRoot;</span><br><span class="line">    <span class="keyword">if</span> (root === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Cannot update an unmounted root.'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    updateContainer(children, root, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<p>updateContainer 源码：</p>
<p><font color=gray><em>packages\react-reconciler\src\ReactFiberReconciler.js</em></font></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">updateContainer</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  element: ReactNodeList,</span></span></span><br><span class="line"><span class="function"><span class="params">  container: OpaqueRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  parentComponent: ?React$Component&lt;any, any&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  callback: ?Function,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Lane</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ! 1. 获取current和lane</span></span><br><span class="line">  <span class="keyword">const</span> current = container.current;</span><br><span class="line">  <span class="keyword">const</span> lane = requestUpdateLane(current); <span class="comment">// 页面初次渲染，defaultLane 32</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// ! 2. 创建update</span></span><br><span class="line">  <span class="keyword">const</span> update = createUpdate(lane);</span><br><span class="line">  <span class="comment">// Caution: React DevTools currently depends on this property</span></span><br><span class="line">  <span class="comment">// being called "element".</span></span><br><span class="line">  update.payload = &#123;element&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 页面初次渲染，React18中已取消callback，只有老版本有效</span></span><br><span class="line">  callback = callback === <span class="literal">undefined</span> ? <span class="literal">null</span> : callback;</span><br><span class="line">  <span class="keyword">if</span> (callback !== <span class="literal">null</span>) &#123;</span><br><span class="line">    update.callback = callback;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ! 3. 将update入队管理</span></span><br><span class="line">  <span class="keyword">const</span> root = enqueueUpdate(current, update, lane);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (root !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// ! 4. 调度更新</span></span><br><span class="line">    scheduleUpdateOnFiber(root, current, lane);</span><br><span class="line">    <span class="comment">// ! 5. 处理transitions，非紧急更新</span></span><br><span class="line">    entangleTransitions(root, current, lane);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> lane;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-1-获取-current-和-lane"><a href="#2-1-获取-current-和-lane" class="headerlink" title="2.1 获取 current 和 lane"></a>2.1 获取 current 和 lane</h4><p><code>lane</code> 是用于标识 <code>update</code> 优先级，一种标识 <code>update</code> 优先级的机制。每个 <code>update</code> 都会被分配一个或者多个 <code>lane</code>，以确定其在更新队列中的优先级顺序。</p>
<p><font color=gray><em>packages\react-reconciler\src\ReactFiberWorkLoop.js</em></font></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">requestUpdateLane</span>(<span class="params">fiber: Fiber</span>): <span class="title">Lane</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Special cases</span></span><br><span class="line">  <span class="keyword">const</span> mode = fiber.mode;</span><br><span class="line">  <span class="comment">// 1. 非ConcurrentMode模式 2. 目前不支持</span></span><br><span class="line">  <span class="keyword">if</span> ((mode &amp; ConcurrentMode) === NoMode) &#123;</span><br><span class="line">    <span class="keyword">return</span> (SyncLane: Lane);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">    (executionContext &amp; RenderContext) !== NoContext &amp;&amp;</span><br><span class="line">    workInProgressRootRenderLanes !== NoLanes</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">// This is a render phase update. These are not officially supported. The</span></span><br><span class="line">    <span class="comment">// old behavior is to give this the same "thread" (lanes) as</span></span><br><span class="line">    <span class="comment">// whatever is currently rendering. So if you call `setState` on a component</span></span><br><span class="line">    <span class="comment">// that happens later in the same render, it will flush. Ideally, we want to</span></span><br><span class="line">    <span class="comment">// remove the special case and treat them as if they came from an</span></span><br><span class="line">    <span class="comment">// interleaved event. Regardless, this pattern is not officially supported.</span></span><br><span class="line">    <span class="comment">// This behavior is only a fallback. The flag only exists until we can roll</span></span><br><span class="line">    <span class="comment">// out the setState warning, since existing code might accidentally rely on</span></span><br><span class="line">    <span class="comment">// the current behavior.</span></span><br><span class="line">    <span class="keyword">return</span> pickArbitraryLane(workInProgressRootRenderLanes);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 普通更新与非紧急更新(18)</span></span><br><span class="line">  <span class="keyword">const</span> transition = requestCurrentTransition();</span><br><span class="line">  <span class="comment">// 如果有transition</span></span><br><span class="line">  <span class="keyword">if</span> (transition !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> actionScopeLane = peekEntangledActionLane();</span><br><span class="line">    <span class="keyword">return</span> actionScopeLane !== NoLane</span><br><span class="line">      ? <span class="comment">// We're inside an async action scope. Reuse the same lane.</span></span><br><span class="line">        actionScopeLane</span><br><span class="line">      : <span class="comment">// We may or may not be inside an async action scope. If we are, this</span></span><br><span class="line">        <span class="comment">// is the first update in that scope. Either way, we need to get a</span></span><br><span class="line">        <span class="comment">// fresh transition lane.</span></span><br><span class="line">        requestTransitionLane(transition);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Move this type conversion to the event priority module.</span></span><br><span class="line">  <span class="comment">// React内部的一些update，比如flushSync，会通过上下文变量来跟踪其优先级</span></span><br><span class="line">  <span class="keyword">const</span> updateLane: Lane = (getCurrentUpdatePriority(): any);</span><br><span class="line">  <span class="keyword">if</span> (updateLane !== NoLane) &#123;</span><br><span class="line">    <span class="comment">// ? sy setState click 2</span></span><br><span class="line">    <span class="keyword">return</span> updateLane;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Move this type conversion to the event priority module.</span></span><br><span class="line">  <span class="comment">// React外部的update，根据事件类型，向当前环境获取对应的优先级。</span></span><br><span class="line">  <span class="keyword">const</span> eventLane: Lane = (getCurrentEventPriority(): any);</span><br><span class="line">  <span class="keyword">return</span> eventLane;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="1-1-1-getCurrentEventPriority"><a href="#1-1-1-getCurrentEventPriority" class="headerlink" title="1.1.1 getCurrentEventPriority"></a>1.1.1 getCurrentEventPriority</h5><p><font color=gray><em>packages\react-dom-bindings\src\client\ReactFiberConfigDOM.js</em></font></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">getCurrentEventPriority</span>(<span class="params"></span>): <span class="title">EventPriority</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> currentEvent = <span class="built_in">window</span>.event;</span><br><span class="line">  <span class="keyword">if</span> (currentEvent === <span class="literal">undefined</span>) &#123;</span><br><span class="line">    <span class="comment">// ? sy 页面初次渲染</span></span><br><span class="line">    <span class="keyword">return</span> DefaultEventPriority;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> getEventPriority(currentEvent.type);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="1-1-2-DefaultEventPriority、getCurrentUpdatePriority"><a href="#1-1-2-DefaultEventPriority、getCurrentUpdatePriority" class="headerlink" title="1.1.2 DefaultEventPriority、getCurrentUpdatePriority"></a>1.1.2 DefaultEventPriority、getCurrentUpdatePriority</h5><p><font color=gray><em>packages\react-reconciler\src\ReactEventPriorities.js</em></font></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> opaque type EventPriority = Lane;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 优先级从上往下，越来越低</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> DiscreteEventPriority: EventPriority = SyncLane; <span class="comment">// 2</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> ContinuousEventPriority: EventPriority = InputContinuousLane; <span class="comment">// 8</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> DefaultEventPriority: EventPriority = DefaultLane; <span class="comment">// 页面初次渲染的lane 32, transition</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> IdleEventPriority: EventPriority = IdleLane;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> currentUpdatePriority: EventPriority = NoLane;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">getCurrentUpdatePriority</span>(<span class="params"></span>): <span class="title">EventPriority</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> currentUpdatePriority;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">setCurrentUpdatePriority</span>(<span class="params">newPriority: EventPriority</span>) </span>&#123;</span><br><span class="line">  currentUpdatePriority = newPriority;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-2-创建update-createUpdate"><a href="#2-2-创建update-createUpdate" class="headerlink" title="2.2 创建update(createUpdate)"></a>2.2 创建update(createUpdate)</h4><p><font color=gray><em>packages\react-reconciler\src\ReactFiberClassUpdateQueue.js</em></font></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> type Update&lt;State&gt; = &#123;</span><br><span class="line">  lane: Lane,</span><br><span class="line"></span><br><span class="line">  tag: <span class="number">0</span> | <span class="number">1</span> | <span class="number">2</span> | <span class="number">3</span>,</span><br><span class="line">  payload: any,</span><br><span class="line">  callback: <span class="function">(<span class="params">(</span>) =&gt;</span> mixed) | <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">  next: Update&lt;State&gt; | <span class="literal">null</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createUpdate</span>(<span class="params">lane: Lane</span>): <span class="title">Update</span>&lt;<span class="title">mixed</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> update: Update&lt;mixed&gt; = &#123;</span><br><span class="line">    lane,</span><br><span class="line"></span><br><span class="line">    tag: UpdateState,</span><br><span class="line">    payload: <span class="literal">null</span>,</span><br><span class="line">    callback: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">    next: <span class="literal">null</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> update;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-3-update入队"><a href="#2-3-update入队" class="headerlink" title="2.3 update入队"></a>2.3 update入队</h4><p><code>createRoot(root).render()</code> 阶段与类组件的 <code>setState</code> 、<code>forceUpdate</code> 阶段最开始调⽤的是 <code>ReactFiberClassUpdateQueue.js</code> 中的 <code>enqueueUpdate</code>。</p>
<p><font color=gray><em>packages\react-reconciler\src\ReactFiberClassUpdateQueue.js</em></font></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">enqueueUpdate</span>&lt;<span class="title">State</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  fiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  update: Update&lt;State&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  lane: Lane,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">FiberRoot</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> updateQueue = fiber.updateQueue;</span><br><span class="line">  <span class="keyword">if</span> (updateQueue === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// Only occurs if the fiber has been unmounted.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> sharedQueue: SharedQueue&lt;State&gt; = (updateQueue: any).shared;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 类组件旧的生命周期相关的update</span></span><br><span class="line">  <span class="keyword">if</span> (isUnsafeClassRenderPhaseUpdate(fiber)) &#123;</span><br><span class="line">    <span class="comment">// This is an unsafe render phase update. Add directly to the update</span></span><br><span class="line">    <span class="comment">// queue so we can process it immediately during the current render.</span></span><br><span class="line">    <span class="keyword">const</span> pending = sharedQueue.pending;</span><br><span class="line">    <span class="keyword">if</span> (pending === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// This is the first update. Create a circular list.</span></span><br><span class="line">      update.next = update;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      update.next = pending.next;</span><br><span class="line">      pending.next = update;</span><br><span class="line">    &#125;</span><br><span class="line">    sharedQueue.pending = update;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update the childLanes even though we're most likely already rendering</span></span><br><span class="line">    <span class="comment">// this fiber. This is for backwards compatibility in the case where you</span></span><br><span class="line">    <span class="comment">// update a different component during render phase than the one that is</span></span><br><span class="line">    <span class="comment">// currently renderings (a pattern that is accompanied by a warning).</span></span><br><span class="line">    <span class="keyword">return</span> unsafe_markUpdateLaneFromFiberToRoot(fiber, lane);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// sy</span></span><br><span class="line">    <span class="keyword">return</span> enqueueConcurrentClassUpdate(fiber, sharedQueue, update, lane);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="1-3-1-enqueueConcurrentClassUpdate"><a href="#1-3-1-enqueueConcurrentClassUpdate" class="headerlink" title="1.3.1 enqueueConcurrentClassUpdate"></a>1.3.1 enqueueConcurrentClassUpdate</h5><p><font color=gray><em>packages\react-reconciler\src\ReactFiberConcurrentUpdates.js</em></font></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ClassUpdate | HookUpdate;</span></span><br><span class="line"><span class="keyword">export</span> type ConcurrentUpdate = &#123;</span><br><span class="line">  next: ConcurrentUpdate,</span><br><span class="line">  lane: Lane,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// ClassQueue | HookQueue;</span></span><br><span class="line">type ConcurrentQueue = &#123;</span><br><span class="line">  pending: ConcurrentUpdate | <span class="literal">null</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 如果渲染正在进行中，并且收到来自并发事件的更新,我们会等到当前的渲染结束（无论是完成还是被中断）之后再将其添加到 fiber 队列中。</span></span><br><span class="line"><span class="comment">// 将其推送到这个数组中，这样我们以后就可以访问queue、fiber、update等。</span></span><br><span class="line"><span class="keyword">const</span> concurrentQueues: <span class="built_in">Array</span>&lt;any&gt; = [];</span><br><span class="line"><span class="keyword">let</span> concurrentQueuesIndex = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> concurrentlyUpdatedLanes: Lanes = NoLanes;</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">enqueueConcurrentClassUpdate</span>&lt;<span class="title">State</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  fiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  queue: ClassQueue&lt;State&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  update: ClassUpdate&lt;State&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  lane: Lane,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">FiberRoot</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> concurrentQueue: ConcurrentQueue = (queue: any);</span><br><span class="line">  <span class="keyword">const</span> concurrentUpdate: ConcurrentUpdate = (update: any);</span><br><span class="line">  <span class="comment">// ! 1. update入队</span></span><br><span class="line">  enqueueUpdate(fiber, concurrentQueue, concurrentUpdate, lane);</span><br><span class="line">  <span class="comment">// ! 2. 返回FiberRoot</span></span><br><span class="line">  <span class="keyword">return</span> getRootForUpdatedFiber(fiber);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="1-3-1-1-enqueueUpdate"><a href="#1-3-1-1-enqueueUpdate" class="headerlink" title="1.3.1.1 enqueueUpdate"></a>1.3.1.1 enqueueUpdate</h5><p>把 <code>update</code> 存储到 <code>concurrentQueues</code> 中，虽然这个函数也叫 <code>enqueueUpdate</code> 。</p>
<p>这⾥的 <code>enqueueUpdate</code> 是数字式存储，并且是依次存储 <code>fiber</code>、<code>queue</code>、<code>update</code>、<code>lane</code>，下次依然这个顺序，最后执⾏处理的时候也要按照这个规律取值。</p>
<p>React 源码中其它地⽅这种结构都是对象式写法，这⾥⽐较罕⻅地写了这个结构。</p>
<p><font color=gray><em>packages\react-reconciler\src\ReactFiberConcurrentUpdates.js</em></font></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">enqueueUpdate</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  fiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  queue: ConcurrentQueue | null,</span></span></span><br><span class="line"><span class="function"><span class="params">  update: ConcurrentUpdate | null,</span></span></span><br><span class="line"><span class="function"><span class="params">  lane: Lane,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Don't update the `childLanes` on the return path yet. If we already in</span></span><br><span class="line">  <span class="comment">// the middle of rendering, wait until after it has completed.</span></span><br><span class="line">  concurrentQueues[concurrentQueuesIndex++] = fiber;</span><br><span class="line">  concurrentQueues[concurrentQueuesIndex++] = queue;</span><br><span class="line">  concurrentQueues[concurrentQueuesIndex++] = update;</span><br><span class="line">  concurrentQueues[concurrentQueuesIndex++] = lane;</span><br><span class="line"></span><br><span class="line">  concurrentlyUpdatedLanes = mergeLanes(concurrentlyUpdatedLanes, lane);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The fiber's `lane` field is used in some places to check if any work is</span></span><br><span class="line">  <span class="comment">// scheduled, to perform an eager bailout, so we need to update it immediately.</span></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> We should probably move this to the "shared" queue instead.</span></span><br><span class="line">  fiber.lanes = mergeLanes(fiber.lanes, lane);</span><br><span class="line">  <span class="keyword">const</span> alternate = fiber.alternate;</span><br><span class="line">  <span class="keyword">if</span> (alternate !== <span class="literal">null</span>) &#123;</span><br><span class="line">    alternate.lanes = mergeLanes(alternate.lanes, lane);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="1-3-1-2-getRootForUpdatedFiber-找到-FiberRoot"><a href="#1-3-1-2-getRootForUpdatedFiber-找到-FiberRoot" class="headerlink" title="1.3.1.2 getRootForUpdatedFiber 找到 FiberRoot"></a>1.3.1.2 getRootForUpdatedFiber 找到 FiberRoot</h5><p>从 sourceFiber 开始，找到根 Fiber，返回其 stateNode，即 FiberRoot。</p>
<p><font color=gray><em>packages\react-reconciler\src\ReactFiberConcurrentUpdates.js</em></font></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRootForUpdatedFiber</span>(<span class="params">sourceFiber: Fiber</span>): <span class="title">FiberRoot</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 如果循环超过限制次数(50次)，抛出错误。比如在类组件的render函数里执行setState</span></span><br><span class="line">  throwIfInfiniteUpdateLoopDetected();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// When a setState happens, we must ensure the root is scheduled. Because</span></span><br><span class="line">  <span class="comment">// update queues do not have a backpointer to the root, the only way to do</span></span><br><span class="line">  <span class="comment">// this currently is to walk up the return path. This used to not be a big</span></span><br><span class="line">  <span class="comment">// deal because we would have to walk up the return path to set</span></span><br><span class="line">  <span class="comment">// the `childLanes`, anyway, but now those two traversals happen at</span></span><br><span class="line">  <span class="comment">// different times.</span></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Consider adding a `root` backpointer on the update queue.</span></span><br><span class="line">  <span class="comment">// __DEV__，检查是否有未挂载的Fiber，如Can't perform a React state update on a component that hasn't mounted yet.</span></span><br><span class="line">  detectUpdateOnUnmountedFiber(sourceFiber, sourceFiber);</span><br><span class="line">  <span class="keyword">let</span> node = sourceFiber;</span><br><span class="line">  <span class="keyword">let</span> parent = node.return;</span><br><span class="line">  <span class="comment">// 循环往上查找，找到根节点</span></span><br><span class="line">  <span class="keyword">while</span> (parent !== <span class="literal">null</span>) &#123;</span><br><span class="line">    detectUpdateOnUnmountedFiber(sourceFiber, node);</span><br><span class="line">    node = parent;</span><br><span class="line">    parent = node.return;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 根节点一定是HostRoot，返回根节点的stateNode，即FiberRoot</span></span><br><span class="line">  <span class="keyword">return</span> node.tag === HostRoot ? (node.stateNode: FiberRoot) : <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-4-scheduleUpdateOnFiber-调度更新"><a href="#2-4-scheduleUpdateOnFiber-调度更新" class="headerlink" title="2.4 scheduleUpdateOnFiber 调度更新"></a>2.4 scheduleUpdateOnFiber 调度更新</h4><p>调度 update。</p>
<p>具体查看 scheduleUpdateOnFiber调度更新 文章。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">scheduleUpdateOnFiber</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  root: FiberRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  fiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  lane: Lane,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-5-entangleTransitions-非紧急更新"><a href="#2-5-entangleTransitions-非紧急更新" class="headerlink" title="2.5 entangleTransitions 非紧急更新"></a>2.5 entangleTransitions 非紧急更新</h4><p>处理非紧急更新 Transitions。查看后续文章。</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/react18-2/" rel="tag"># react18.2</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/zh-CN/vue3%E7%BB%84%E4%BB%B6%E5%BC%82%E6%AD%A5%E6%9B%B4%E6%96%B0%E5%92%8CNextTick%E7%9A%84%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6.html" rel="prev" title="vue3组件异步更新和NextTick的运行机制">
      <i class="fa fa-chevron-left"></i> vue3组件异步更新和NextTick的运行机制
    </a></div>
      <div class="post-nav-item">
    <a href="/zh-CN/react%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%88%E4%BA%8C%EF%BC%89scheduleUpdateOnFiber%E8%B0%83%E5%BA%A6%E6%9B%B4%E6%96%B0.html" rel="next" title="react18.2源码分析（二）scheduleUpdateOnFiber调度更新">
      react18.2源码分析（二）scheduleUpdateOnFiber调度更新 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-入口-createRoot-API"><span class="nav-number">1.</span> <span class="nav-text">1. 入口 - createRoot API</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-检查container是否是DOM"><span class="nav-number">1.1.</span> <span class="nav-text">1. 检查container是否是DOM</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-检查options"><span class="nav-number">1.2.</span> <span class="nav-text">2. 检查options</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-createContainer-创建-FiberRoot，-即root"><span class="nav-number">1.3.</span> <span class="nav-text">3. createContainer 创建 FiberRoot， 即root</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-实例化-FiberRootNode，创建-FiberRoot"><span class="nav-number">1.3.1.</span> <span class="nav-text">3.1 实例化 FiberRootNode，创建 FiberRoot</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-createHostRootFiber-创建原生标签的根-Fiber"><span class="nav-number">1.3.2.</span> <span class="nav-text">3.2 createHostRootFiber 创建原生标签的根 Fiber</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-循环构造-root-和-uninitializedFiber"><span class="nav-number">1.3.3.</span> <span class="nav-text">3.3 循环构造 root 和 uninitializedFiber</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-4-初始化-initializeUpdateQueue"><span class="nav-number">1.3.4.</span> <span class="nav-text">3.4 初始化 initializeUpdateQueue</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-markContainerAsRoot-标记-Container-是根-Fiber"><span class="nav-number">1.4.</span> <span class="nav-text">4. markContainerAsRoot 标记 Container 是根 Fiber</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-从Container层监听listenToAllSupportedEvents"><span class="nav-number">1.5.</span> <span class="nav-text">5. 从Container层监听listenToAllSupportedEvents</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-返回ReactDOMRoot实例"><span class="nav-number">1.6.</span> <span class="nav-text">6. 返回ReactDOMRoot实例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-加载-执行-render-函数"><span class="nav-number">2.</span> <span class="nav-text">2. 加载 - 执行 render 函数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-获取-current-和-lane"><span class="nav-number">2.0.1.</span> <span class="nav-text">2.1 获取 current 和 lane</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-1-1-getCurrentEventPriority"><span class="nav-number">2.0.1.1.</span> <span class="nav-text">1.1.1 getCurrentEventPriority</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#1-1-2-DefaultEventPriority、getCurrentUpdatePriority"><span class="nav-number">2.0.1.2.</span> <span class="nav-text">1.1.2 DefaultEventPriority、getCurrentUpdatePriority</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-创建update-createUpdate"><span class="nav-number">2.0.2.</span> <span class="nav-text">2.2 创建update(createUpdate)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-update入队"><span class="nav-number">2.0.3.</span> <span class="nav-text">2.3 update入队</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-3-1-enqueueConcurrentClassUpdate"><span class="nav-number">2.0.3.1.</span> <span class="nav-text">1.3.1 enqueueConcurrentClassUpdate</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#1-3-1-1-enqueueUpdate"><span class="nav-number">2.0.3.2.</span> <span class="nav-text">1.3.1.1 enqueueUpdate</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#1-3-1-2-getRootForUpdatedFiber-找到-FiberRoot"><span class="nav-number">2.0.3.3.</span> <span class="nav-text">1.3.1.2 getRootForUpdatedFiber 找到 FiberRoot</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-scheduleUpdateOnFiber-调度更新"><span class="nav-number">2.0.4.</span> <span class="nav-text">2.4 scheduleUpdateOnFiber 调度更新</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-5-entangleTransitions-非紧急更新"><span class="nav-number">2.0.5.</span> <span class="nav-text">2.5 entangleTransitions 非紧急更新</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="rile"
      src="/images/Trevor.jpeg">
  <p class="site-author-name" itemprop="name">rile</p>
  <div class="site-description" itemprop="description">FE</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">33</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Rile14929" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Rile14929" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:rile14929@163.com" title="E-Mail → mailto:rile14929@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2020 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-rocket"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">rile</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
