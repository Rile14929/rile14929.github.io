<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"rile14929.github.io","root":"/","scheme":"Pisces","version":"7.7.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="FE">
<meta property="og:type" content="website">
<meta property="og:title" content="右耳听风">
<meta property="og:url" content="https://rile14929.github.io/page/3/index.html">
<meta property="og:site_name" content="右耳听风">
<meta property="og:description" content="FE">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="rile">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://rile14929.github.io/page/3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>右耳听风</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">右耳听风</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tag"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://rile14929.github.io/zh-CN/Gitlab%20CI_CD%20%E5%AE%9E%E8%B7%B5.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/Trevor.jpeg">
      <meta itemprop="name" content="rile">
      <meta itemprop="description" content="FE">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="右耳听风">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/zh-CN/Gitlab%20CI_CD%20%E5%AE%9E%E8%B7%B5.html" class="post-title-link" itemprop="url">Gitlab CI/CD 实践</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-07-20 00:00:00" itemprop="dateCreated datePublished" datetime="2023-07-20T00:00:00+08:00">2023-07-20</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>GitLab CI/CD 是一个内置在 GitLab 中的工具，用于通过持续方法进行软件开发：</p>
<h5 id="Continuous-Integration（持续集成）"><a href="#Continuous-Integration（持续集成）" class="headerlink" title="Continuous Integration（持续集成）"></a>Continuous Integration（持续集成）</h5><p>假设一个应用程序，其代码存储在 GitLab 的 Git 仓库中。开发人员每天都要多次推送代码更改。对于每次向仓库的推送，你都可以创建一组脚本来自动构建和测试你的应用程序，从而减少了向应用程序引入错误的机会。这种做法称为持续集成，对于提交给应用程序（甚至是开发分支）的每项更改，它都会自动连续进行构建和测试，以确保所引入的更改通过你为应用程序建立的所有测试，准则和代码合规性标准。</p>
<h5 id="Continuous-Delivery（持续交付）"><a href="#Continuous-Delivery（持续交付）" class="headerlink" title="Continuous Delivery（持续交付）"></a>Continuous Delivery（持续交付）</h5><p>持续交付是超越持续集成的更进一步的操作。应用程序不仅会在推送到代码库的每次代码更改时进行构建和测试，而且，尽管部署是手动触发的，但作为一个附加步骤，它也可以连续部署。此方法可确保自动检查代码，但需要人工干预才能从策略上手动触发以必输此次变更。</p>
<h5 id="Continuous-Deployment（持续部署）"><a href="#Continuous-Deployment（持续部署）" class="headerlink" title="Continuous Deployment（持续部署）"></a>Continuous Deployment（持续部署）</h5><p>与持续交付类似，但不同之处在于，你无需将其手动部署，而是将其设置为自动部署。完全不需要人工干预即可部署你的应用程序。</p>
<h2 id="工作流程"><a href="#工作流程" class="headerlink" title="工作流程"></a>工作流程</h2><p>为了使用 GitLab CI/CD，你需要一个托管在 GitLab 上的应用程序代码库，并且在根目录中的.gitlab-ci.yml 文件中指定构建、测试和部署的脚本。</p>
<p>在这个文件中，你可以定义要运行的脚本，定义包含的依赖项，选择要按顺序运行的命令和要并行运行的命令，定义要在何处部署应用程序，以及指定是否 要自动运行脚本或手动触发脚本。</p>
<p>为了可视化处理过程，假设添加到配置文件中的所有脚本与在计算机的终端上运行的命令相同。</p>
<p>一旦你已经添加了.gitlab-ci.yml 到仓库中，GitLab 将检测到该文件，并使用名为 GitLab Runner 的工具运行你的脚本。该工具的操作与终端类似。</p>
<p>这些脚本被分组到 jobs，它们共同组成一个 pipeline。一个最简单的.gitlab-ci.yml 文件可能是这样的：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">before_script:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">apt-get</span> <span class="string">install</span> <span class="string">rubygems</span> <span class="string">ruby-dev</span> <span class="string">-y</span></span><br><span class="line"></span><br><span class="line"><span class="attr">run-test:</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ruby</span> <span class="string">--version</span> <span class="number">6</span></span><br></pre></td></tr></table></figure>

<p>before_script 属性将在运行任何内容之前为你的应用安装依赖，一个名为 run-test 的 job（作业）将打印当前系统的 Ruby 版本。二者共同构成了在每次推送到仓库的任何分支时都会被触发的 pipeline（管道）。</p>
<p>GitLab CI/CD 不仅可以执行你设置的 job，还可以显示执行期间发生的情况，正如你在终端看到的那样：<br><img src="/images/GitlabCI_CD.resources/2551D6FD-98FB-42FB-B217-232C6028B2AC.png" alt="74b8f022354a48a2a663a996ae2c1dd8"></p>
<h4 id="通过-GitLab-UI-所有的步骤都是可视化的"><a href="#通过-GitLab-UI-所有的步骤都是可视化的" class="headerlink" title="通过 GitLab UI 所有的步骤都是可视化的"></a>通过 GitLab UI 所有的步骤都是可视化的</h4><p><img src="/images/GitlabCI_CD.resources/E239A99B-76CC-4F14-9DA2-4286A51588B9.png" alt="aae548d462b9c6b5e8bab016b96c5512"></p>
<h2 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h2><h4 id="创建一个-gitlab-ci-yml-文件"><a href="#创建一个-gitlab-ci-yml-文件" class="headerlink" title="创建一个.gitlab-ci.yml 文件"></a>创建一个.gitlab-ci.yml 文件</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">stages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">lint</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">release</span></span><br><span class="line"><span class="attr">commitlint:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">lint</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">if:</span> <span class="string">'$CI_COMMIT_TITLE =~ /^chore\(release\)/'</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">never</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">if:</span> <span class="string">'$CI_COMMIT_TITLE =~ /^Merge branch/'</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">never</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">if:</span> <span class="string">$CI_COMMIT_BRANCH</span> <span class="string">==</span> <span class="string">$CI_DEFAULT_BRANCH</span> <span class="comment"># 一般当分支master有 push 或 merge 时才会执行该工作</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sh</span> <span class="string">bin/commitlint-gitlab-ci.sh</span></span><br><span class="line"><span class="attr">release:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">release</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">if:</span> <span class="string">$CI_COMMIT_BRANCH</span> <span class="string">==</span> <span class="string">$CI_DEFAULT_BRANCH</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">semantic-release</span></span><br></pre></td></tr></table></figure>

<h4 id="配置一个-Runner"><a href="#配置一个-Runner" class="headerlink" title="配置一个 Runner"></a>配置一个 Runner</h4><p>在 GitLab 中，Runner 运行你定义在.gitlab-ci.yml 中的作业（job）<br>一个 Runner 可以是一个虚拟机、物理机、docker 容器，或者一个容器集群 GitLab 与 Runner 之间通过 API 进行通信，因此只需要 Runner 所在的机器有网络并且可以访问 GitLab 服务器即可<br>你可以去  <strong>Settings ➔ CI/CD</strong>  看是否已经有 Runner 关联到你的项目，设置 Runner 简单又直接<br><img src="/images/GitlabCI_CD.resources/A9EF490C-2A96-495A-AEBC-135E32A9FAE1.png" alt="7b99f010133b6b0689a1dc90c2893831"></p>
<h4 id="查看-pipeline-和-jobs-状态"><a href="#查看-pipeline-和-jobs-状态" class="headerlink" title="查看 pipeline 和 jobs 状态"></a>查看 pipeline 和 jobs 状态</h4><p><img src="/images/GitlabCI_CD.resources/159D77C9-7C89-4B37-8A6A-9DB90473D0ED.png" alt="e57d2652f09e520231cae9358ac69e10"></p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>团队计划使用 semantic-release 自动管理发布版本，结合 Gitlab CI/CD 是一个很不错的选择，具体的实践过程和心得会在后面分享。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://rile14929.github.io/zh-CN/chrome%20performance%E9%9D%A2%E6%9D%BF.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/Trevor.jpeg">
      <meta itemprop="name" content="rile">
      <meta itemprop="description" content="FE">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="右耳听风">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/zh-CN/chrome%20performance%E9%9D%A2%E6%9D%BF.html" class="post-title-link" itemprop="url">chrome performance 面板解析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-06-15 00:00:00" itemprop="dateCreated datePublished" datetime="2023-06-15T00:00:00+08:00">2023-06-15</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="概况图"><a href="#概况图" class="headerlink" title="概况图"></a>概况图</h2><p><img src="/images/chromeperformance%E9%9D%A2%E6%9D%BF.resources/B31D1703-5E66-4F19-8D12-448E4D283BC9.png" alt="71d6a82a01519413ca2a1be4b957c544"></p>
<h4 id="无痕模式"><a href="#无痕模式" class="headerlink" title="无痕模式"></a>无痕模式</h4><p>无痕模式可以保证 Chrome 在一个相对干净的环境下运行，避免 chrome 上安装的插件影响性能分析结果。<br>文件—&gt;打开新的无痕式窗口，或使用快捷键 ctrl + shift + N 打开无痕模式下的 chrome 新标签页</p>
<h4 id="性能记录"><a href="#性能记录" class="headerlink" title="性能记录"></a>性能记录</h4><p>点击面板里的 ○，可以记录运行时的性能记录，如下图：<br><img src="/images/chromeperformance%E9%9D%A2%E6%9D%BF.resources/8B1B5662-14CE-47BA-A799-07447D14021C.png" alt="0b82ba7820c6d3ec5b21fe563191a08d"></p>
<p>再次点击 Record 或者点击 Stop 停止记录。</p>
<h4 id="加载时性能记录录制"><a href="#加载时性能记录录制" class="headerlink" title="加载时性能记录录制"></a>加载时性能记录录制</h4><p>若要分析页面记载时性能需要录制加载时性能。</p>
<ol>
<li>打开待分析性能的页面。</li>
<li>打开 Devtools 中 Performance 窗口。</li>
<li>点击左上角重新加载按钮。DevTools 会自动记录页面加载是各项性能指标，加载完成几秒后自动停止记录。<br>Devtools 记录会自动增加<br><img src="/images/chromeperformance%E9%9D%A2%E6%9D%BF.resources/8BE55FF4-23D8-4373-9700-6FC306487719.png" alt="bcc3faa215dab1b20aefba15f42fa29d"></li>
</ol>
<p>页面加载时记录<br><img src="/images/chromeperformance%E9%9D%A2%E6%9D%BF.resources/2E1306AE-F26B-4DE5-8E02-96106AA7CA11.png" alt="8faf902b1637f885df323e7791713c33"></p>
<h4 id="清除记录"><a href="#清除记录" class="headerlink" title="清除记录"></a>清除记录</h4><p>清除 Performance 窗口中的记录数据。</p>
<h4 id="抓取运行时屏幕快照"><a href="#抓取运行时屏幕快照" class="headerlink" title="抓取运行时屏幕快照"></a>抓取运行时屏幕快照</h4><p>点选 Screenshots 选项开启为每一帧记录屏幕快照功能。</p>
<h4 id="查看内存度量值"><a href="#查看内存度量值" class="headerlink" title="查看内存度量值"></a>查看内存度量值</h4><p>点选 Memory 选项打开内存度量功能。<br>DevTools 在 Summary 面板上侧显示一个新的 Memory 图表。在 NET 图表下边也显示一个 HEAP 图表。HEAP 图表提供的信息同 Memory 面板中 JS Heap 提供的信息相同。</p>
<h4 id="开启加速渲染工具"><a href="#开启加速渲染工具" class="headerlink" title="开启加速渲染工具"></a>开启加速渲染工具</h4><p>点选 Enable advanced paint instrumentation 选项（会带来大量的性能开销）</p>
<h4 id="控制录制过程中-CPU-工作频率"><a href="#控制录制过程中-CPU-工作频率" class="headerlink" title="控制录制过程中 CPU 工作频率"></a>控制录制过程中 CPU 工作频率</h4><p>将 CPU 设置为需要的运算速度模式。<br><img src="/images/chromeperformance%E9%9D%A2%E6%9D%BF.resources/9DD1F5C8-9131-4F02-BDA0-8D5DCB6095A3.png" alt="886c6b4d80132d8e286af2d6ed89cdb9"></p>
<p>CPU 工作频率的控制结果跟实际使用的机器能力有关。例如，4x slowdown 选项会使你本地 CPU 运算速率比正常情况下降低 4 倍。不同设备由于设计架构不同，Devtools 不能精确模拟移动端设备的 CPU 运算模式。</p>
<h4 id="保存记录"><a href="#保存记录" class="headerlink" title="保存记录"></a>保存记录</h4><p><img src="/images/chromeperformance%E9%9D%A2%E6%9D%BF.resources/F4D6D133-2769-4173-9090-79276AFC56D4.png" alt="da01643afd3f94a7927b96b2ddd7a044"><br>会生成 JSON 文件</p>
<h4 id="加载记录"><a href="#加载记录" class="headerlink" title="加载记录"></a>加载记录</h4><p>单击鼠标右键选择 Load Profile 加载记录</p>
<h2 id="分析性能记录"><a href="#分析性能记录" class="headerlink" title="分析性能记录"></a>分析性能记录</h2><p>运行时或者加载时性能录制结束后，在 Performance 窗口中会显示相关数据，从而对于记录过程中的情况进行分析。</p>
<h4 id="选择记录中的一部分"><a href="#选择记录中的一部分" class="headerlink" title="选择记录中的一部分"></a>选择记录中的一部分</h4><p>在 Overview 窗口中，可以选中记录的某一部分。 Overview 窗口指的是包含 FPS, CPU 和 NET 图表部分。<br><img src="/images/chromeperformance%E9%9D%A2%E6%9D%BF.resources/7D7EC5FB-7086-4767-99DB-4BCB7AE4E430.png" alt="3c66d685cee9f55228ca867b5a07a88e"></p>
<h4 id="查看主线程活动"><a href="#查看主线程活动" class="headerlink" title="查看主线程活动"></a>查看主线程活动</h4><p>利用 Main 区域查看页面主线程加载时的主要活动。<br><img src="/images/chromeperformance%E9%9D%A2%E6%9D%BF.resources/A2BE4509-9F3E-4AAC-90D2-E0F68820471A.png" alt="26247567fd6f9281d4a16d8fcbcba32f"></p>
<p>点击某一函数在 Summary 窗口中查看更多详细信息。如图中所示 DevTools 选中_getRequestData 事件。<br>DevTools 采用随机的颜色标识脚本信息，如上面图中浅绿色标识函数调用，深黄色标识脚本活动。<br>若想隐藏火焰图中的 JavaScript 中调用的详细信息，请查看前面介绍的禁用 JavaScript 样例功能。若禁用 JavaScript 样例功能，你只可以看到初始调用事件。比如，图中标识的 Timer fired 和 Function Call 。</p>
<h4 id="在表格中查看活动"><a href="#在表格中查看活动" class="headerlink" title="在表格中查看活动"></a>在表格中查看活动</h4><p>录制结束后，利用 Main 窗口中信息不是分析数据的唯一方式。DevTools 另外提供了三种表格式分析活动方式，每种方式都是从不同的角度出发:<br>若想分析那些活动占用时间更多时，可以利用 Bottom-Up 窗口。<br>若想分析导致更多活动的根活动时，可以采用 Call Tree。<br>若想按顺序分析记录中发生的活动时，可以利用 Event Log 窗口。</p>
<h4 id="根活动"><a href="#根活动" class="headerlink" title="根活动"></a>根活动</h4><p>根活动指的是浏览器触发的一系列流程。例如，当你点击页面内容，浏览器触发一个 Event 作为根活动，该 Event 可能回调一个事件处理事件。<br>在 Main 面板中的火焰图中，根活动展示在上部，在 Call Tree 和 Event Log 面板中，根活动展示在顶层。</p>
<h4 id="Call-Tree-标签页"><a href="#Call-Tree-标签页" class="headerlink" title="Call Tree 标签页"></a>Call Tree 标签页</h4><p>Call Tree 标签页中展示记录中被选中部分的活动信息。<br><img src="/images/chromeperformance%E9%9D%A2%E6%9D%BF.resources/9E98C9B1-90D8-4D50-A6BC-FDCB4EB51B0F.png" alt="6f4e0500bac02ec6143b950c159c63ae"></p>
<p>图中 Activity 列中显示的 Timer fired、 Paint、Recalculate Style 和 Layout 代表根活动。层级嵌套表示代表回调栈。如图中 Function Call 调用 u，再调用 getImageUrl，继续调用 getLinkUrl 等等。<br>Self Time 表示对应活动消耗的时间，Total Time 表示对应活动以及子活动共同消耗的时间。<br>点击 Self Time，Total Time 或者 Activity 表头区域，可按对应列排序。<br>利用 Filter 输入框区域，输入活动名过滤事件。<br>Grouping 分组菜单默认为 No Grouping，利用该功能可以根据不同的分类将活动进行分组。<br>点击右侧 Show Heaviest Stack，在右侧展示当前选中活动中占用时间最多的子活动信息。</p>
<p><img src="/images/chromeperformance%E9%9D%A2%E6%9D%BF.resources/BBFE6629-C9A4-4901-A79C-3E850194B322.png" alt="6562aca6f7e21ca7a5746f1cff491455"></p>
<h4 id="Bottom-Up-标签页"><a href="#Bottom-Up-标签页" class="headerlink" title="Bottom-Up 标签页"></a>Bottom-Up 标签页</h4><p>利用 Bottom-Up 标签查看占用最多时间的活动。<br>Self Time 表示对应活动消耗的时间。<br>Total Time 表示对应活动以及子活动共同消耗的时间。</p>
<h4 id="Event-Log-标签页"><a href="#Event-Log-标签页" class="headerlink" title="Event Log 标签页"></a>Event Log 标签页</h4><p>Event Log 标签页按顺序展示记录中发生的活动。<br>Start Time 列表示该项活动的开始时间，该时间相对于记录开始时间计算。例如图中选中项开始时间为 1566.2 ms，代表该活动在记录开始之后 1566.2 ms 后开始。<br>Self Time 表示对应活动消耗的时间。<br>Total Time 表示对应活动以及子活动共同消耗的时间。<br>点击 Start Time 、Self Time、Total Time 表头区域，可按对应列排序。<br>利用 Filter 输入框区域，输入活动名过滤事件。<br>利用 Duration 下拉菜单过滤&gt;=1ms 或者&gt;=15ms 的活动。该菜单默认选中 All 选项，展示所有活动。<br>利用 Loading、Experience、Scripting、Rendering、Painting 选项进行分类过滤。<br><img src="/images/chromeperformance%E9%9D%A2%E6%9D%BF.resources/9278865D-99FC-4945-A7DA-55264A743F15.png" alt="58c29a0d627c26c7d9fc1afd80a348ef"></p>
<h4 id="分析每秒传输帧数（FPS）"><a href="#分析每秒传输帧数（FPS）" class="headerlink" title="分析每秒传输帧数（FPS）"></a>分析每秒传输帧数（FPS）</h4><ul>
<li>查看 FPS 图表了解整个记录中 FPS 的概况。</li>
<li>Frames 模块查看每一帧时间消耗。</li>
<li>利用 FPS meter 工具(MoreTools—&gt;Rendering)在页面运行时实时查看 FPS 信息。</li>
</ul>
<h4 id="FPS-图表"><a href="#FPS-图表" class="headerlink" title="FPS 图表"></a>FPS 图表</h4><p>FPS 图表显示了整个记录过程中帧率的概况。图表中绿色折线越高代表帧率越好。<br>FPS 折线图上测出现的红色横线为一条性能警示线，表示帧率低于该值会严重影响用户体验。</p>
<h4 id="Frames-模块"><a href="#Frames-模块" class="headerlink" title="Frames 模块"></a>Frames 模块</h4><p>Frames 模块清晰表明每个帧消耗时间。<br>鼠标在某一帧上悬停可以查看更多详细信息。</p>
<h4 id="查看交互信息"><a href="#查看交互信息" class="headerlink" title="查看交互信息"></a>查看交互信息</h4><p>利用 Interactions 模块查看并分析记录过程中用户的交互操作。</p>
<h4 id="查看-GPU-活动"><a href="#查看-GPU-活动" class="headerlink" title="查看 GPU 活动"></a>查看 GPU 活动</h4><p>在 GPU 模块查看 GPU 活动信息<br><img src="/images/chromeperformance%E9%9D%A2%E6%9D%BF.resources/DCF59BFE-D663-4BF2-B581-1562C15B425E.png" alt="69c660e3d248b30ffc310f2813525e08"></p>
<h4 id="查看栅格活动"><a href="#查看栅格活动" class="headerlink" title="查看栅格活动"></a>查看栅格活动</h4><p>在 Raster 模块查看栅格活动信息</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://rile14929.github.io/zh-CN/%E5%89%8D%E7%AB%AF%E8%84%9A%E6%89%8B%E6%9E%B6%E6%90%AD%E5%BB%BA.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/Trevor.jpeg">
      <meta itemprop="name" content="rile">
      <meta itemprop="description" content="FE">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="右耳听风">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/zh-CN/%E5%89%8D%E7%AB%AF%E8%84%9A%E6%89%8B%E6%9E%B6%E6%90%AD%E5%BB%BA.html" class="post-title-link" itemprop="url">前端脚手架搭建</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-05-04 00:00:00" itemprop="dateCreated datePublished" datetime="2023-05-04T00:00:00+08:00">2023-05-04</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>由于公司标准化产品逐渐成熟，项目越来越多，需要一款脚手架通过业务标准化模板自动生成项目，可以让开发人员专注于业务开发，降低心智成本，提升团队效率。</p>
<p>参考了常用的脚手架，create-react-app、vue-cli、egg-init 的实现，搭建出了一套符合团队实际情况的脚手架工具。</p>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p><strong>脚手架就是在启动的时候询问一些简单的问题，并且通过用户回答的结果去渲染对应的模板文件。</strong><br>基本工作流程如下：</p>
<ol>
<li>通过命令行交互询问用户问题</li>
<li>拉取远端标准化模板</li>
<li>根据用户回答的结果生成文件</li>
<li>自动下载依赖</li>
</ol>
<h4 id="热门脚手架工具库"><a href="#热门脚手架工具库" class="headerlink" title="热门脚手架工具库"></a>热门脚手架工具库</h4><p><img src="/images/%E5%89%8D%E7%AB%AF%E8%84%9A%E6%89%8B%E6%9E%B6%E6%90%AD%E5%BB%BA.resources/81447CFF-3772-41A2-9663-9BFE685C3473.png" alt="116d0e8220abc84e44593738478cbee7"></p>
<h2 id="搭建"><a href="#搭建" class="headerlink" title="搭建"></a>搭建</h2><h4 id="1-判断当前环境是否符合要求"><a href="#1-判断当前环境是否符合要求" class="headerlink" title="1. 判断当前环境是否符合要求"></a>1. 判断当前环境是否符合要求</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env node</span></span><br><span class="line"><span class="meta">'use strict'</span></span><br><span class="line"><span class="keyword">const</span> currentNodeVersion = process.versions.node</span><br><span class="line"><span class="keyword">const</span> semver = currentNodeVersion.split(<span class="string">'.'</span>)</span><br><span class="line"><span class="keyword">const</span> major = semver[<span class="number">0</span>]</span><br><span class="line"><span class="keyword">if</span> (major &lt; <span class="number">14</span>) &#123;</span><br><span class="line">  <span class="built_in">console</span>.error(</span><br><span class="line">    <span class="string">'You are running Node '</span> +</span><br><span class="line">      currentNodeVersion +</span><br><span class="line">      <span class="string">'.\n'</span> +</span><br><span class="line">      <span class="string">'Create React App requires Node 14 or higher. \n'</span> +</span><br><span class="line">      <span class="string">'Please update your version of Node.'</span></span><br><span class="line">  )</span><br><span class="line">  process.exit(<span class="number">1</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-创建脚手架启动命令（使用-commander）"><a href="#2-创建脚手架启动命令（使用-commander）" class="headerlink" title="2. 创建脚手架启动命令（使用 commander）"></a>2. 创建脚手架启动命令（使用 commander）</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> program = <span class="keyword">new</span> commander.Command(packageJson.name)</span><br><span class="line">  .version(packageJson.version)</span><br><span class="line">  .arguments(<span class="string">'&lt;project-directory&gt;'</span>)</span><br><span class="line">  .usage(<span class="string">`<span class="subst">$&#123;chalk.green(<span class="string">'&lt;project-directory&gt;'</span>)&#125;</span> [options]`</span>)</span><br><span class="line">  .action(<span class="function">(<span class="params">name</span>) =&gt;</span> &#123;</span><br><span class="line">    projectName = name</span><br><span class="line">  &#125;)</span><br><span class="line">  .parse(process.argv)</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> projectName === <span class="string">'undefined'</span>) &#123;</span><br><span class="line">  <span class="built_in">console</span>.error(<span class="string">'Please specify the project directory:'</span>)</span><br><span class="line">  <span class="built_in">console</span>.log(</span><br><span class="line">    <span class="string">`  <span class="subst">$&#123;chalk.cyan(program.name())&#125;</span> <span class="subst">$&#123;chalk.green(<span class="string">'&lt;project-directory&gt;'</span>)&#125;</span>`</span></span><br><span class="line">  )</span><br><span class="line">  <span class="built_in">console</span>.log()</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'For example:'</span>)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`  <span class="subst">$&#123;chalk.cyan(program.name())&#125;</span> <span class="subst">$&#123;chalk.green(<span class="string">'my-app'</span>)&#125;</span>`</span>)</span><br><span class="line">  process.exit(<span class="number">1</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-判断当前脚手架版本是否是最新"><a href="#3-判断当前脚手架版本是否是最新" class="headerlink" title="3. 判断当前脚手架版本是否是最新"></a>3. 判断当前脚手架版本是否是最新</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取最新的version</span></span><br><span class="line"><span class="keyword">const</span> checkForLatestVersion = <span class="function">(<span class="params">url</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    http</span><br><span class="line">      .get(url, (res) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (res.statusCode === <span class="number">200</span>) &#123;</span><br><span class="line">          <span class="keyword">let</span> body = <span class="string">''</span></span><br><span class="line">          res.on(<span class="string">'data'</span>, (data) =&gt; (body += data))</span><br><span class="line">          res.on(<span class="string">'end'</span>, () =&gt; &#123;</span><br><span class="line">            resolve(<span class="built_in">JSON</span>.parse(body).version)</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          reject()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">      .on(<span class="string">'error'</span>, () =&gt; &#123;</span><br><span class="line">        reject()</span><br><span class="line">      &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">checkForLatestVersion(<span class="string">`<span class="subst">$&#123;host&#125;</span>create-my-app/latest`</span>)</span><br><span class="line">  .catch(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> execSync(<span class="string">'npm view create-my-app version'</span>).toString().trim()</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  .then(<span class="function">(<span class="params">latest</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (latest &amp;&amp; semver.lt(packageJson.version, latest)) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log()</span><br><span class="line">      <span class="built_in">console</span>.error(</span><br><span class="line">        chalk.yellow(</span><br><span class="line">          <span class="string">`You are running \`create-my-app\` <span class="subst">$&#123;packageJson.version&#125;</span>, which is behind the latest release (<span class="subst">$&#123;latest&#125;</span>).\n\n`</span> +</span><br><span class="line">            <span class="string">'We recommend always using the latest version of create-my-app if possible.'</span></span><br><span class="line">        )</span><br><span class="line">      )</span><br><span class="line">      <span class="built_in">console</span>.log()</span><br><span class="line">      <span class="built_in">console</span>.log(</span><br><span class="line">        <span class="string">'The latest instructions for creating a new app can be found here:\n'</span> +</span><br><span class="line">          <span class="string">`<span class="subst">$&#123;host&#125;</span>-/web/detail/create-my-app`</span></span><br><span class="line">      )</span><br><span class="line">      <span class="built_in">console</span>.log()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      createApp()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>

<h4 id="4-询问用户问题获取创建所需信息（使用-inquirer）"><a href="#4-询问用户问题获取创建所需信息（使用-inquirer）" class="headerlink" title="4. 询问用户问题获取创建所需信息（使用 inquirer）"></a>4. 询问用户问题获取创建所需信息（使用 inquirer）</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> getAnswers = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> inquirer.prompt([</span><br><span class="line">    &#123;</span><br><span class="line">      type: <span class="string">'input'</span>,</span><br><span class="line">      name: <span class="string">'projectZHName'</span>,</span><br><span class="line">      message: <span class="string">'请输入项目中文名'</span>,</span><br><span class="line">      <span class="keyword">default</span>: <span class="string">''</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    ...,</span><br><span class="line">    &#123;</span><br><span class="line">      type: <span class="string">'input'</span>,</span><br><span class="line">      name: <span class="string">'version'</span>,</span><br><span class="line">      message: <span class="string">'请输入版本'</span>,</span><br><span class="line">      <span class="keyword">default</span>: <span class="string">'1.0.0'</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      type: <span class="string">'input'</span>,</span><br><span class="line">      name: <span class="string">'author'</span>,</span><br><span class="line">      message: <span class="string">'请输入创建人(拼音全拼)'</span>,</span><br><span class="line">      <span class="keyword">default</span>: <span class="string">''</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  ])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-下载远程模板（使用-hyperquest-或-download-git-repo）"><a href="#5-下载远程模板（使用-hyperquest-或-download-git-repo）" class="headerlink" title="5. 下载远程模板（使用 hyperquest 或 download-git-repo）"></a>5. 下载远程模板（使用 hyperquest 或 download-git-repo）</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> latest = <span class="keyword">await</span> checkForLatestVersion(</span><br><span class="line">  <span class="string">`<span class="subst">$&#123;host&#125;</span>my-frontend-template/latest`</span></span><br><span class="line">).catch(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> execSync(<span class="string">'npm view my-frontend-template version'</span>).toString().trim()</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">const</span> &#123; tmpdir, cleanup &#125; = <span class="keyword">await</span> getPackageInfo(</span><br><span class="line">  <span class="string">`<span class="subst">$&#123;host&#125;</span>my-frontend-template/-/my-frontend-template-<span class="subst">$&#123;latest&#125;</span>.tgz`</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> extractStream = <span class="function">(<span class="params">stream, dest</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    stream.pipe(</span><br><span class="line">      unpack(dest, (err) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">          reject(err)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          resolve(dest)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    )</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> getTemporaryDirectory = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// Unsafe cleanup lets us recursively delete the directory if it contains</span></span><br><span class="line">    <span class="comment">// contents; by default it only allows removal if it's empty</span></span><br><span class="line">    tmp.dir(&#123; <span class="attr">unsafeCleanup</span>: <span class="literal">true</span> &#125;, (err, tmpdir, callback) =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        reject(err)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        resolve(&#123;</span><br><span class="line">          tmpdir: tmpdir,</span><br><span class="line">          cleanup: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              callback()</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ignored) &#123;</span><br><span class="line">              <span class="comment">// Callback might throw and fail, since it's a temp directory the</span></span><br><span class="line">              <span class="comment">// OS will clean it up eventually...</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> getPackageInfo = <span class="function">(<span class="params">installPackage</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (installPackage.match(<span class="regexp">/^.+\.(tgz|tar\.gz)$/</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> getTemporaryDirectory().then(<span class="function">(<span class="params">obj</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> stream</span><br><span class="line">      <span class="keyword">if</span> (<span class="regexp">/^http/</span>.test(installPackage)) &#123;</span><br><span class="line">        stream = hyperquest(installPackage)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        stream = fsExtra.createReadStream(installPackage)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> extractStream(stream, obj.tmpdir).then(<span class="function"><span class="params">()</span> =&gt;</span> obj)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(&#123; <span class="attr">name</span>: installPackage &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="6-根据需要读取修改文件和复制文件"><a href="#6-根据需要读取修改文件和复制文件" class="headerlink" title="6. 根据需要读取修改文件和复制文件"></a>6. 根据需要读取修改文件和复制文件</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; tmpdir, cleanup &#125; = <span class="keyword">await</span> getPackageInfo(</span><br><span class="line">    <span class="string">`<span class="subst">$&#123;host&#125;</span>my-frontend-template/-/my-frontend-template-<span class="subst">$&#123;latest&#125;</span>.tgz`</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> root = path.resolve(projectName)</span><br><span class="line">fsExtra.mkdirSync(root)</span><br><span class="line">process.chdir(root)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> templates = [</span><br><span class="line">   ...,</span><br><span class="line">    <span class="string">'src/common'</span>,</span><br><span class="line">    ...</span><br><span class="line">  ]</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> item <span class="keyword">of</span> templates) &#123;</span><br><span class="line">    fsExtra.copy(templatePath(tmpdir, item), item)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h4 id="7-自动下载依赖"><a href="#7-自动下载依赖" class="headerlink" title="7. 自动下载依赖"></a>7. 自动下载依赖</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> child = spawn(<span class="string">'pnpm'</span>, [<span class="string">'install'</span>], &#123; <span class="attr">stdio</span>: <span class="string">'inherit'</span> &#125;)</span><br><span class="line">child.on(<span class="string">'close'</span>, (code) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (code !== <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">console</span>.log()</span><br><span class="line">  <span class="built_in">console</span>.log(</span><br><span class="line">    <span class="string">`<span class="subst">$&#123;chalk.cyan(projectName)&#125;</span> is created <span class="subst">$&#123;chalk.green(<span class="string">'successfully'</span>)&#125;</span>`</span></span><br><span class="line">  )</span><br><span class="line">  <span class="built_in">console</span>.log()</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Get Started with the following commands:'</span>)</span><br><span class="line">  <span class="built_in">console</span>.log()</span><br><span class="line">  <span class="built_in">console</span>.log(</span><br><span class="line">    <span class="string">`<span class="subst">$&#123;chalk.gray(<span class="string">'$'</span>)&#125;</span> <span class="subst">$&#123;chalk.green(<span class="string">'cd'</span>)&#125;</span> <span class="subst">$&#123;chalk.green(projectName)&#125;</span>`</span></span><br><span class="line">  )</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;chalk.gray(<span class="string">'$'</span>)&#125;</span> <span class="subst">$&#123;chalk.green(<span class="string">'pnpm run serve'</span>)&#125;</span>`</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="8-发布和使用"><a href="#8-发布和使用" class="headerlink" title="8. 发布和使用"></a>8. 发布和使用</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// package.json</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="string">"bin"</span>: &#123;</span><br><span class="line">        <span class="string">"create-my-app"</span>: <span class="string">"./index.js"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    ...</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>将脚手架发布到公司私库内，在使用中使用一行命令即可完成生成工作。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx create-my-app &lt;project-directory&gt;</span><br></pre></td></tr></table></figure>

<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>文章中贴出来了关键部分的脱敏代码，整体主要参考了<a href="https://github.com/facebook/create-react-app/blob/main/packages/create-react-app/createReactApp.js" target="_blank" rel="noopener">create-react-app</a>的实现，对其代码逻辑之严谨深受启发，其几乎对每一个环节可能出现的问题都做了第二种甚至第三种容错处理，在自己实现过程中，学习到了很多，对日后的开发大有帮助。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://rile14929.github.io/zh-CN/webpack-rollup.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/Trevor.jpeg">
      <meta itemprop="name" content="rile">
      <meta itemprop="description" content="FE">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="右耳听风">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/zh-CN/webpack-rollup.html" class="post-title-link" itemprop="url">webpack 和 rollup 对比</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-04-15 00:00:00" itemprop="dateCreated datePublished" datetime="2023-04-15T00:00:00+08:00">2023-04-15</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="诞生背景"><a href="#诞生背景" class="headerlink" title="诞生背景"></a>诞生背景</h2><p>在打包工具出现之前，在浏览器中运行 Javascript 中有两种写法：</p>
<ul>
<li>第一种方式，引用一些脚本(script 标签)来存放每个功能；此解决方案很难扩展，因为加载太多脚本会导致网络瓶颈。</li>
<li>第二种方式，使用一个包含所有项目代码的大型  .js  文件，但是这会导致作用域、文件大小、可读性和可维护性方面的问题。</li>
</ul>
<p>历史的解决方案：</p>
<ul>
<li>iife</li>
<li>commonjs（最大的问题是浏览器不支持 commonjs，因为 commonjs 是运行时 动态加载的，是同步的，浏览器同步的话，太慢了）</li>
<li>ESM<ul>
<li>未来的官方标准和主流。但是浏览器的版本需要比较高，比如 chorme 都需要 63 版本以上</li>
<li>esm 是静态的，可以在编译的时候就分析出对应的依赖关系，不用像 commonjs 一样，运行时加载</li>
</ul>
</li>
</ul>
<p>背景总结：</p>
<ol>
<li>commonjs 很好，推出 npm 管理 JavaScript 模块包，但浏览器不支持</li>
<li>esm 更好，浏览器也支持，但只有很新的浏览器才支持。 你可以源代码内写 esm 模块，webpack 可以帮忙打包，让不兼容 esm 的浏览器，也能兼容</li>
</ol>
<h2 id="打包原理"><a href="#打包原理" class="headerlink" title="打包原理"></a>打包原理</h2><p>在了解了背景之后，理解打包原理就很简单了。</p>
<h3 id="webpack"><a href="#webpack" class="headerlink" title="webpack"></a>webpack</h3><h4 id="所有内容打包到一个-chunk-包内（单-chunk-包）"><a href="#所有内容打包到一个-chunk-包内（单-chunk-包）" class="headerlink" title="所有内容打包到一个 chunk 包内（单 chunk 包）"></a>所有内容打包到一个 chunk 包内（单 chunk 包）</h4><blockquote>
<p>无额外配置，webpack 一般会把所有 js 打成一个包。实现步骤</p>
</blockquote>
<ul>
<li>读文件，扫描代码，按模块加载顺序，排列模块，分为模块 1，模块 2，…，模块 n 。放到一个作用域内，用 modules 保存，modules 是一个数组，所有模块按加载顺序，索引排序</li>
<li>webpack 自己实现对应的 api（比如自己实现 require），让浏览器支持源代码内的模块化的写法（比如：module.export, require, esm 稍微有些不同 见下方）打包外部依赖也是一样的</li>
</ul>
<h5 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h5><ul>
<li><strong>纯 commonjs</strong><ul>
<li><strong>所有的 js 依赖，打包到一个文件内，然后自己实现一套 require 和 module.exports，让浏览器可以执行源代码</strong></li>
<li>源代码的 require 会被换成  <strong>webpack_require</strong></li>
<li>源代码的 module.exports 不变，会由 webpack 作为函数的参数传给源代码</li>
</ul>
</li>
<li><strong>纯 esm</strong><ul>
<li>webpack 会做 tree shaking，最终的产物，会和 rollup 的产物比较接近，不会有过多的 webpack 注入的兼容代码</li>
<li>实现思路类似 rollup，<strong>通过 esm 的静态特性，可以在编译的时候，就分析出对应的依赖关系</strong></li>
</ul>
</li>
<li><strong>esm + commonjs 混用</strong><ul>
<li>webpack 很强大，他是支持混用的！！</li>
<li>你可以 module.exports 导出， import xx from xx 导入</li>
<li>也可以 exports { } 导出，require 引入</li>
<li>实现的思路和上面的模拟 module.exports 和提供<strong>webpack_require</strong>替代 require 的思路类似，<strong>webpack 会去模拟 esm 的 exports 对象</strong> 让浏览器支持</li>
</ul>
</li>
</ul>
<h4 id="多个-chunk-包"><a href="#多个-chunk-包" class="headerlink" title="多个 chunk 包"></a>多个 chunk 包</h4><h5 id="多个打包入口"><a href="#多个打包入口" class="headerlink" title="多个打包入口"></a>多个打包入口</h5><ul>
<li>多个入口分离多个包，然后生成多个 script 标签（按入口的顺序</li>
<li>分离出来的多个包，都包含同样多的模拟代码（webpack 注入的代码）</li>
</ul>
<h5 id="分离公共依赖"><a href="#分离公共依赖" class="headerlink" title="分离公共依赖"></a>分离公共依赖</h5><ul>
<li>先加载 venders 包（第三方公共依赖），此加载不是解析代码，只是把第三方依赖的模块，以 webpack 能解析的格式，存到全局对象 window[“webpackJsonp”]内，方便后续的代码能访问到</li>
<li>只需要把 window[“webpackJsonp”]内的 venders 内的模块，放到 main 代码作用域内的 modules 里面，后面就和单 chunk 解析是一样的了</li>
</ul>
<h5 id="import-动态加载（懒加载）"><a href="#import-动态加载（懒加载）" class="headerlink" title="import() 动态加载（懒加载）"></a>import() 动态加载（懒加载）</h5><ul>
<li><p>先执行 main 模块的内容，从上到下执行，关注 import(‘xx’).then()行。打包后，import()会被替换成 webpack 的 api（<strong>webpack_require</strong>.e(/_ import() _/ 1).then(<strong>webpack_require</strong>.bind(null, 1)).then()）</p>
</li>
<li><p>替换后的 api 做了几件事</p>
<ul>
<li>生成 script 标签，并 appendChild 到 ducument.head 内</li>
<li>return 一个 Promise 对象，状态是 pending（pending 状态不会往后执行.then(<strong>webpack_require</strong>.bind(null, 1)).then()，但不会阻塞主程序，因为是异步的，不懂的可以了解一下 promise）</li>
<li>（异步）等了一段时间后，需求懒加载的模块通过 script 标签，被下载到浏览器后会直接解析执行，触发 window[“webpackJsonp”].push（此方法被改写了，和生成同步多 chunk 有点不一样，会触发 webpackJsonpCallback 函数</li>
<li>webpackJsonpCallback 函数的作用<ul>
<li>懒加载的模块 内容 会被加入到 main 的 mudules 的模块列表内去（等效 push 的作用）</li>
<li>会把 Promise 的状态从 pending 改成 fulfilled，因为要懒加载的模块，通过 script 标签，已经解析完成了，所以.then()可以往后了</li>
</ul>
</li>
<li>后面就是正常解析包，和单 chunk 解析多模块是一样的了</li>
</ul>
</li>
</ul>
<hr>
<h3 id="rollup"><a href="#rollup" class="headerlink" title="rollup"></a>rollup</h3><p>浏览器环境使用的话：</p>
<ol>
<li>无需考虑浏览器兼容问题的话：<ul>
<li>开发者写 esm 代码 -&gt; rollup 通过入口，递归识别 esm 模块 -&gt; 最终打包成一个或多个 bundle.js -&gt; 浏览器直接可以支持引入<script type="module"></script></li>
</ul>
</li>
<li>需考虑浏览器兼容问题的话<ul>
<li>可能会比较复杂，需要用额外的 polyfill 库，或结合 webpack 使用</li>
</ul>
</li>
</ol>
<p>打包成 npm 包的话：</p>
<ul>
<li>开发者写 esm 代码 -&gt; rollup 通过入口，递归识别 esm 模块 -&gt; （可以支持配置输出多种格式的模块，如 esm、cjs、umd、amd）最终打包成一个或多个 bundle.js<ul>
<li>（开发者要写 cjs 也可以，需要插件@rollup/plugin-commonjs） 初步看来</li>
</ul>
</li>
<li>很明显，rollup 比较适合打包 js 库（react、vue2 等的源代码库都是 rollup 打包的）或 高版本无需往下兼容的浏览器应用程序</li>
<li>这样打包出来的库，可以充分使用上 esm 的 tree shaking，使源库体积最小</li>
</ul>
<h4 id="单-chunk-包"><a href="#单-chunk-包" class="headerlink" title="单 chunk 包"></a>单 chunk 包</h4><p>无额外配置，一般会把所有 js 打成一个包。打包外部依赖（第三方）也是一样的</p>
<h4 id="多-chunk-包"><a href="#多-chunk-包" class="headerlink" title="多 chunk 包"></a>多 chunk 包</h4><ul>
<li>配置多个入口，此法比较简单，可自行测试</li>
<li>代码分离 （动态 import，懒加载， import(xxx).then(module =&gt; {}) ）<ul>
<li><a href="https://rollupjs.org/repl/?version=1.6.0&shareable=JTdCJTIybW9kdWxlcyUyMiUzQSU1QiU3QiUyMm5hbWUlMjIlM0ElMjJtYWluLmpzJTIyJTJDJTIyY29kZSUyMiUzQSUyMiUyRiolMjBEWU5BTUlDJTIwSU1QT1JUUyU1Q24lMjAlMjAlMjBSb2xsdXAlMjBzdXBwb3J0cyUyMGF1dG9tYXRpYyUyMGNodW5raW5nJTIwYW5kJTIwbGF6eS1sb2FkaW5nJTVDbiUyMCUyMCUyMHZpYSUyMGR5bmFtaWMlMjBpbXBvcnRzJTIwdXRpbGl6aW5nJTIwdGhlJTIwaW1wb3J0JTIwbWVjaGFuaXNtJTVDbiUyMCUyMCUyMG9mJTIwdGhlJTIwaG9zdCUyMHN5c3RlbS4lMjAqJTJGJTVDbmlmJTIwKGRpc3BsYXlNYXRoKSUyMCU3QiU1Q24lNUN0aW1wb3J0KCcuJTJGbWF0aHMuanMnKS50aGVuKGZ1bmN0aW9uJTIwKG1hdGhzKSUyMCU3QiU1Q24lNUN0JTVDdGNvbnNvbGUubG9nKG1hdGhzLnNxdWFyZSg1KSklM0IlNUNuJTVDdCU1Q3Rjb25zb2xlLmxvZyhtYXRocy5jdWJlKDUpKSUzQiU1Q24lNUN0JTdEKSUzQiU1Q24lN0QlMjIlMkMlMjJpc0VudHJ5JTIyJTNBdHJ1ZSU3RCUyQyU3QiUyMm5hbWUlMjIlM0ElMjJtYXRocy5qcyUyMiUyQyUyMmNvZGUlMjIlM0ElMjJpbXBvcnQlMjBzcXVhcmUlMjBmcm9tJTIwJy4lMkZzcXVhcmUuanMnJTNCJTVDbiU1Q25leHBvcnQlMjAlN0JkZWZhdWx0JTIwYXMlMjBzcXVhcmUlN0QlMjBmcm9tJTIwJy4lMkZzcXVhcmUuanMnJTNCJTVDbiU1Q25leHBvcnQlMjBmdW5jdGlvbiUyMGN1YmUlMjAoeCUyMCklMjAlN0IlNUNuJTVDdHJldHVybiUyMHNxdWFyZSh4KSUyMColMjB4JTNCJTVDbiU3RCUyMiUyQyUyMmlzRW50cnklMjIlM0FmYWxzZSU3RCUyQyU3QiUyMm5hbWUlMjIlM0ElMjJzcXVhcmUuanMlMjIlMkMlMjJjb2RlJTIyJTNBJTIyZXhwb3J0JTIwZGVmYXVsdCUyMGZ1bmN0aW9uJTIwc3F1YXJlJTIwKCUyMHglMjApJTIwJTdCJTVDbiU1Q3RyZXR1cm4lMjB4JTIwKiUyMHglM0IlNUNuJTdEJTIyJTJDJTIyaXNFbnRyeSUyMiUzQWZhbHNlJTdEJTVEJTJDJTIyb3B0aW9ucyUyMiUzQSU3QiUyMmZvcm1hdCUyMiUzQSUyMmNqcyUyMiUyQyUyMm5hbWUlMjIlM0ElMjJteUJ1bmRsZSUyMiUyQyUyMmFtZCUyMiUzQSU3QiUyMmlkJTIyJTNBJTIyJTIyJTdEJTJDJTIyZ2xvYmFscyUyMiUzQSU3QiU3RCU3RCUyQyUyMmV4YW1wbGUlMjIlM0FudWxsJTdE" target="_blank" rel="noopener">此处有一个官方的例子，再清楚不过了</a></li>
<li>对于代码分割，还有一种方法可以通过  output.manualChunks  选项显式告诉 Rollup 哪些模块要分割成单独的块。</li>
</ul>
</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><h3 id="webpack-1"><a href="#webpack-1" class="headerlink" title="webpack"></a>webpack</h3><blockquote>
<p><code>webpack</code> 诞生在 <code>esm</code> 标准出来前，<code>commonjs</code> 出来后</p>
</blockquote>
<ul>
<li><p>当时的浏览器只能通过 script 标签加载模块</p>
<ul>
<li><strong>script 标签加载代码是没有作用域的，只能在代码内 用 iife 的方式 实现作用域效果</strong><ul>
<li>这就是 webpack 打包出来的代码 大结构都是 iife 的原因</li>
<li>并且<strong>每个模块都要装到 function 里面</strong>，才能保证互相之间作用域不干扰。</li>
<li>这就是为什么 webpack 打包的代码为什么乍看会感觉乱，找不到自己写的代码的真正原因</li>
</ul>
</li>
</ul>
</li>
<li><p>关于 webpack 的代码注入问题，是因为<strong>浏览器不支持 cjs</strong>，所以 webpack 要去<strong>自己实现 require 和 module.exports 方法</strong>（才有很多注入）</p>
<ul>
<li>这么多年了，甚至到现在 2022 年，<strong>浏览器为什么不支持 cjs</strong>？<ul>
<li><strong>cjs 是同步的，运行时的，node 环境用 cjs，node 本身运行在服务器，无需等待网络握手，所以同步处理是很快的</strong></li>
<li><strong>浏览器是 客户端，访问的是服务端资源，中间需要等待网络握手，可能会很慢，所以不能 同步的 卡在那里等服务器返回的，体验太差</strong></li>
</ul>
</li>
</ul>
</li>
<li><p><strong>后续出来 esm 后，webpack 为了兼容以前发在 npm 上的老包</strong>（并且当时心还不够决绝，导致这种“丑结构的包”越来越多，以后就更不可能改这种“丑结构了”），所以保留这个 iife 的结构和代码注入，<strong>导致现在看 webpack 打包的产物，乍看结构比较乱且有很多的代码注入，自己写的代码都找不到</strong></p>
</li>
</ul>
<h3 id="rollup-1"><a href="#rollup-1" class="headerlink" title="rollup"></a>rollup</h3><blockquote>
<p>rollup 诞生在 esm 标准出来后</p>
</blockquote>
<ul>
<li><strong>出发点就是希望开发者去写 esm 模块</strong>，这样适合做代码静态分析，可以做 tree shaking 减少代码体积，也是浏览器除了 script 标签外，真正让 JavaScript 拥有模块化能力。是 js 语言的未来</li>
<li><strong>rollup 完全依赖高版本浏览器原生去支持 esm 模块，所以无额外代码注入，打包后的代码结构也是清晰的</strong>（不用像 webpack 那样 iife）<ul>
<li>目前浏览器支持模块化只有 3 种方法：<ul>
<li>script 标签（缺点没有作用域的概念</li>
<li>script 标签 + iife + window + 函数作用域（可以解决作用域问题。webpack 的打包的产物就这样</li>
<li>esm （什么都好，唯一缺点 需要高版本浏览器）</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="最终使用推荐"><a href="#最终使用推荐" class="headerlink" title="最终使用推荐"></a>最终使用推荐</h2><ol>
<li>打包<strong>开源库</strong>：rollup 会是更好的选择</li>
<li>打包应用程序：看是否需要<strong>兼容老浏览器</strong><br>如果不考虑兼容老浏览器，建议用 <code>vite</code> 开发应用程序，<code>vite</code>打包实际使用的就是<code>rollup</code>，开发体验很棒，打的生产包比用<code>webpack</code>小很多，有不错的性能提升<br>如果需要考虑兼容，则选择<code>webpack</code></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://rile14929.github.io/zh-CN/tsconfig.json%E6%96%87%E4%BB%B6%E5%85%A8%E8%A7%A3%E6%9E%90.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/Trevor.jpeg">
      <meta itemprop="name" content="rile">
      <meta itemprop="description" content="FE">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="右耳听风">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/zh-CN/tsconfig.json%E6%96%87%E4%BB%B6%E5%85%A8%E8%A7%A3%E6%9E%90.html" class="post-title-link" itemprop="url">tsconfig.json文件解析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-03-10 00:00:00" itemprop="dateCreated datePublished" datetime="2023-03-10T00:00:00+08:00">2023-03-10</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><code>TypeScript</code>带来的类型系统以及强大的<code>IDE</code>支持，让前端开发也变得严谨而流畅。但<code>TypeScript</code>不是原生的<code>Javascript</code>代码，需要进行编译才能转换为<code>Javascript</code>代码。</p>
<p><code>tsconfig.json</code>是编译<code>TypeScript</code>的配置文件，对书写<code>TypeScript</code>代码十分重要。接下来会介绍一些常用的编译选项和所有<code>tsconfig.json</code>选项的解释。</p>
<h2 id="常用属性"><a href="#常用属性" class="headerlink" title="常用属性"></a>常用属性</h2><h4 id="1-experimentalDecorators"><a href="#1-experimentalDecorators" class="headerlink" title="1.experimentalDecorators"></a>1.experimentalDecorators</h4><p><code>是否启用实验性的ES装饰器</code>。 默认值：<strong>false</strong>, <a href="https://www.typescriptlang.org/docs/handbook/decorators.html" target="_blank" rel="noopener">官方解释</a></p>
<p>TypeScript 和 ES6 中引入了 Class 的概念，同时在 stage 2 proposal (opens new window)提出了 Java 等服务器端语言早就有的装饰器模式。通过引入装饰器模式，能极大简化书写代码，把一些通用逻辑封装到装饰器中。</p>
<h4 id="2-strictPropertyInitialization"><a href="#2-strictPropertyInitialization" class="headerlink" title="2.strictPropertyInitialization"></a>2.strictPropertyInitialization</h4><p><code>是否类的非undefined属性已经在构造函数里初始化</code>。 默认值：<strong>false</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Home</span> </span>&#123;</span><br><span class="line">  id: string <span class="comment">// 如果开启strictPropertyInitialization，则这里会报错，因为没有赋值默认值</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-noImplicitAny"><a href="#3-noImplicitAny" class="headerlink" title="3.noImplicitAny"></a>3.noImplicitAny</h4><p><code>有隐含的 any类型时是否报错</code>。 默认值：<strong>false</strong></p>
<p>ts 是有默认推导的，同时还有 any 类型，所以不是每个变量或参数定义需要明确告知类型是什么。如果开启该值，当有隐含 any 类型时，会报错。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 当开启noImplicitAny时，需要隐含当any需要明确指出</span></span><br><span class="line">arr.find(<span class="function">(<span class="params">item</span>) =&gt;</span> item.name === name) <span class="comment">// error</span></span><br><span class="line">arr.find(<span class="function">(<span class="params">item: <span class="built_in">any</span></span>) =&gt;</span> item.name === name) <span class="comment">// ok</span></span><br></pre></td></tr></table></figure>

<h4 id="4-target"><a href="#4-target" class="headerlink" title="4.target"></a>4.target</h4><p><code>指定编译的ECMAScript目标版本</code>。默认值: “ES3”<a href="https://www.typescriptlang.org/tsconfig#target" target="_blank" rel="noopener">官方解释</a><br>枚举值：”ES3”， “ES5”， “ES6”/ “ES2015”， “ES2016”， “ES2017”，”ES2018”，”ES2019”，”ES2020”，”ES2021”，”ES2022”，”ESNext”</p>
<blockquote>
<p>target: “ESNext” 是指 tc39 最新的<a href="https://github.com/tc39/proposals" target="_blank" rel="noopener">ECMAScript proposals</a></p>
</blockquote>
<p>当编译 ts 代码时，可以把 ts 转为 ES5 或更早的 js 代码。所以需要选择一个编译的目标版本。</p>
<h4 id="5-module"><a href="#5-module" class="headerlink" title="5.module"></a>5.module</h4><p><code>指定生成哪个模块系统代码</code> <a href="https://www.typescriptlang.org/tsconfig#module" target="_blank" rel="noopener">官方解释</a></p>
<p>枚举值：”None”， “CommonJS”， “AMD”， “System”， “UMD”， “ES6”， “ES2015”，”ES2020”, “ES2022”, “ESNext”, “node16”, “nodenext”,</p>
<p>默认值根据–target 选项不同而不同，当 target 设置为 ES6 时，默认 module 为“ES6”，否则为“commonjs”</p>
<h4 id="6-lib"><a href="#6-lib" class="headerlink" title="6.lib"></a>6.lib</h4><p><code>编译过程中需要引入的库文件的列表</code></p>
<ul>
<li><a href="https://www.typescriptlang.org/tsconfig#lib" target="_blank" rel="noopener">官方解释</a></li>
<li><a href="https://jkchao.github.io/typescript-book-chinese/typings/lib.html#%E4%BD%BF%E7%94%A8%E4%BE%8B%E5%AD%90" target="_blank" rel="noopener">实际场景下的解释</a></li>
</ul>
<p>string[]类型，可选的值有很多，常用的有 ES5，ES6，ESNext，DOM，DOM.Iterable、WebWorker、ScriptHost 等。</p>
<p>该值默认值是根据–target 选项不同而不同。<br>当 target 为 ES5 时，默认值为[‘DOM ‘, ‘ES5’, ‘ScriptHost’];<br>当 target 为 ES6 时，默认值为[‘DOM’, ‘ES6’, ‘DOM.Iterable’, ‘ScriptHost’]</p>
<h4 id="7-moduleResolution"><a href="#7-moduleResolution" class="headerlink" title="7.moduleResolution"></a>7.moduleResolution</h4><p><code>决定如何处理模块</code> <a href="https://www.typescriptlang.org/docs/handbook/module-resolution.html" target="_blank" rel="noopener">官方解释</a></p>
<p>说直白点，也就是遇到 import { AAA } from ‘./aaa’该如何去找对应文件模块解析。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 在源文件&#x2F;root&#x2F;src&#x2F;A.ts中import &#123; b &#125; from &quot;.&#x2F;moduleB&quot;</span><br><span class="line">&#x2F;&#x2F; 两种解析方式查找文件方式不同</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; classic模块解析方式</span><br><span class="line">1. &#x2F;root&#x2F;src&#x2F;moduleB.ts</span><br><span class="line">2. &#x2F;root&#x2F;src&#x2F;moduleB.d.ts</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; node模块解析方式</span><br><span class="line">1. &#x2F;root&#x2F;src&#x2F;moduleB.ts</span><br><span class="line">2. &#x2F;root&#x2F;src&#x2F;moduleB.tsx</span><br><span class="line">3. &#x2F;root&#x2F;src&#x2F;moduleB.d.ts</span><br><span class="line">4. &#x2F;root&#x2F;src&#x2F;moduleB&#x2F;package.json (if it specifies a &quot;types&quot; property)</span><br><span class="line">5. &#x2F;root&#x2F;src&#x2F;moduleB&#x2F;index.ts</span><br><span class="line">6. &#x2F;root&#x2F;src&#x2F;moduleB&#x2F;index.tsx</span><br><span class="line">7. &#x2F;root&#x2F;src&#x2F;moduleB&#x2F;index.d.ts</span><br></pre></td></tr></table></figure>

<h4 id="8-paths"><a href="#8-paths" class="headerlink" title="8.paths"></a>8.paths</h4><p><code>模块名或路径映射的列表</code></p>
<p>这是一个非常有用的选项，比如我们经常使用‘@/util/help’来代替’./src/util/help’，省的每次在不同层级文件 import 模块时,都纠结于是’./‘还是’../‘。该选项告诉编译器遇到匹配的值时，去映射的路径下加载模块。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"baseUrl"</span>: <span class="string">"."</span>, <span class="comment">// 注意：baseUrl不可少</span></span><br><span class="line">    <span class="string">"paths"</span>: &#123;</span><br><span class="line">      <span class="comment">// 映射列表</span></span><br><span class="line">      <span class="string">"@/*"</span>: [</span><br><span class="line">        <span class="string">"src/*"</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="string">"moduleA"</span>: [</span><br><span class="line">        <span class="string">"src/libs/moduleA"</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// in ts code</span></span><br><span class="line"><span class="keyword">import</span> Setting <span class="keyword">from</span> <span class="string">'@/components/Setting.vue'</span> <span class="comment">// 模块实际位置: src/components/Setting.vue</span></span><br><span class="line"><span class="keyword">import</span> TestModule <span class="keyword">from</span> <span class="string">'moduleA/index.js'</span> <span class="comment">// 模块实际位置: src/libs/moduleA/index.js</span></span><br></pre></td></tr></table></figure>

<h4 id="9-strictNullChecks"><a href="#9-strictNullChecks" class="headerlink" title="9.strictNullChecks"></a>9.strictNullChecks</h4><p><code>是否启用严格的 null检查模式</code> 默认值: <strong>false</strong> 建议开启该选项</p>
<p>未处理的 null 和 undefined 经常会导致 BUG 的产生，所以 TypeScript 包含了 strictNullChecks 选项来帮助我们减少对这种情况的担忧。当启用了 strictNullChecks，null 和 undefined 获得了它们自己各自的类型 null 和 undefined。开启该模式有助于发现并处理可能为 undefined 的赋值。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 未开启strictNullChecks，number类型包含了null和undefined类型</span></span><br><span class="line"><span class="keyword">let</span> foo: <span class="built_in">number</span> = <span class="number">123</span></span><br><span class="line">foo = <span class="literal">null</span> <span class="comment">// Okay</span></span><br><span class="line">foo = <span class="literal">undefined</span> <span class="comment">// Okay</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 开启strictNullChecks</span></span><br><span class="line"><span class="keyword">let</span> foo: <span class="built_in">string</span>[] | <span class="literal">undefined</span> = arr.find(<span class="function">(<span class="params">key</span>) =&gt;</span> key === <span class="string">'test'</span>)</span><br><span class="line"><span class="comment">// foo.push('1') // error - 'foo' is possibly 'undefined'</span></span><br><span class="line">foo &amp;&amp; foo.push(<span class="string">'1'</span>) <span class="comment">// okay</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：启用 –strict 相当于启用 –noImplicitAny, –noImplicitThis, –alwaysStrict, –strictNullChecks, –strictFunctionTypes 和–strictPropertyInitialization</p>
</blockquote>
<h4 id="10-noUnusedLocals"><a href="#10-noUnusedLocals" class="headerlink" title="10.noUnusedLocals"></a>10.noUnusedLocals</h4><p><code>有未使用的变量时，是否抛出错误</code> 默认值: <strong>false</strong></p>
<p>当发现变量定义但没有使用时，编译不报错。eslint 的 rule 中也有该条，建议正式项目将该选项开启，设置为 true，使得代码干净整洁</p>
<h4 id="11-noUnusedParameters"><a href="#11-noUnusedParameters" class="headerlink" title="11.noUnusedParameters"></a>11.noUnusedParameters</h4><p><code>有未使用的参数时，是否抛出错误</code> 默认值: <strong>false</strong></p>
<p>建议开启，理由同上。</p>
<h4 id="12-allowJs"><a href="#12-allowJs" class="headerlink" title="12.allowJs"></a>12.allowJs</h4><p><code>是否允许编译javascript文件</code> 默认值: <strong>false</strong></p>
<p>如果设置为 true，js 后缀的文件也会被 typescript 进行编译。</p>
<h4 id="13-typeRoots-和-types"><a href="#13-typeRoots-和-types" class="headerlink" title="13.typeRoots 和 types"></a>13.typeRoots 和 types</h4><p>默认所有可见的”@types”包会在编译过程中被包含进来。如果指定了 typeRoots，只有 typeRoots 下面的包才会被包含进来。如果指定了 types，只有被列出来的 npm 包才会被包含进来。<a href="https://www.tslang.cn/docs/handbook/tsconfig-json.html#types-typeroots-and-types" target="_blank" rel="noopener">详细解释</a></p>
<blockquote>
<p>可以指定”types”: []来禁用自动引入@types 包#14. files、include 和 exclude</p>
</blockquote>
<h4 id="14-files、include-和-exclude"><a href="#14-files、include-和-exclude" class="headerlink" title="14.files、include 和 exclude"></a>14.files、include 和 exclude</h4><p><code>编译文件包含哪些文件以及排除哪些文件</code></p>
<p>未设置 include 时，编译器默认包含当前目录和子目录下所有的 TypeScript 文件（.ts, .d.ts 和 .tsx）。如果 allowJs 被设置成 true，JS 文件（.js 和.jsx）也被包含进来。exclude 排除那些不需要编译的文件或文件夹。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"compilerOptions"</span>: &#123;&#125;,</span><br><span class="line">    <span class="string">"include"</span>: [</span><br><span class="line">        <span class="string">"src/**/*"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"exclude"</span>: [</span><br><span class="line">        <span class="string">"node_modules"</span>,</span><br><span class="line">        <span class="string">"**/*.spec.ts"</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="全解析"><a href="#全解析" class="headerlink" title="全解析"></a>全解析</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"compilerOptions"</span>: &#123;</span><br><span class="line">    <span class="comment">/* 基本选项 */</span></span><br><span class="line">    <span class="string">"target"</span>: <span class="string">"es5"</span>,                       <span class="comment">// 指定 ECMAScript 目标版本: 'ES3' (default), 'ES5', 'ES2015', 'ES2016', 'ES2017', or 'ESNEXT'（"ESNext"表示最新的ES语法，包括还处在stage X阶段）</span></span><br><span class="line">    <span class="string">"module"</span>: <span class="string">"commonjs"</span>,                  <span class="comment">// 指定使用模块: 'commonjs', 'amd', 'system', 'umd' or 'es2015'</span></span><br><span class="line">    <span class="string">"lib"</span>: [],                             <span class="comment">// 指定要包含在编译中的库文件</span></span><br><span class="line">    <span class="string">"allowJs"</span>: <span class="literal">true</span>,                       <span class="comment">// 允许编译 javascript 文件</span></span><br><span class="line">    <span class="string">"checkJs"</span>: <span class="literal">true</span>,                       <span class="comment">// 报告 javascript 文件中的错误</span></span><br><span class="line">    <span class="string">"jsx"</span>: <span class="string">"preserve"</span>,                     <span class="comment">// 指定 jsx 代码的生成: 'preserve', 'react-native', or 'react'</span></span><br><span class="line">    <span class="string">"declaration"</span>: <span class="literal">true</span>,                   <span class="comment">// 生成相应的 '.d.ts' 文件</span></span><br><span class="line">    <span class="string">"sourceMap"</span>: <span class="literal">true</span>,                     <span class="comment">// 生成相应的 '.map' 文件</span></span><br><span class="line">    <span class="string">"outFile"</span>: <span class="string">"./"</span>,                       <span class="comment">// 将输出文件合并为一个文件</span></span><br><span class="line">    <span class="string">"outDir"</span>: <span class="string">"./"</span>,                        <span class="comment">// 指定输出目录</span></span><br><span class="line">    <span class="string">"rootDir"</span>: <span class="string">"./"</span>,                       <span class="comment">// 用来控制输出目录结构 --outDir.</span></span><br><span class="line">    <span class="string">"removeComments"</span>: <span class="literal">true</span>,                <span class="comment">// 删除编译后的所有的注释</span></span><br><span class="line">    <span class="string">"noEmit"</span>: <span class="literal">true</span>,                        <span class="comment">// 不生成输出文件</span></span><br><span class="line">    <span class="string">"importHelpers"</span>: <span class="literal">true</span>,                 <span class="comment">// 从 tslib 导入辅助工具函数</span></span><br><span class="line">    <span class="string">"isolatedModules"</span>: <span class="literal">true</span>,               <span class="comment">// 将每个文件做为单独的模块 （与 'ts.transpileModule' 类似）.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 严格的类型检查选项 */</span></span><br><span class="line">    <span class="string">"strict"</span>: <span class="literal">true</span>,                        <span class="comment">// 启用所有严格类型检查选项</span></span><br><span class="line">    <span class="string">"noImplicitAny"</span>: <span class="literal">true</span>,                 <span class="comment">// 在表达式和声明上有隐含的 any类型时报错</span></span><br><span class="line">    <span class="string">"strictNullChecks"</span>: <span class="literal">true</span>,              <span class="comment">// 启用严格的 null 检查</span></span><br><span class="line">    <span class="string">"noImplicitThis"</span>: <span class="literal">true</span>,                <span class="comment">// 当 this 表达式值为 any 类型的时候，生成一个错误</span></span><br><span class="line">    <span class="string">"alwaysStrict"</span>: <span class="literal">true</span>,                  <span class="comment">// 以严格模式检查每个模块，并在每个文件里加入 'use strict'</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 额外的检查 */</span></span><br><span class="line">    <span class="string">"noUnusedLocals"</span>: <span class="literal">true</span>,                <span class="comment">// 有未使用的变量时，抛出错误</span></span><br><span class="line">    <span class="string">"noUnusedParameters"</span>: <span class="literal">true</span>,            <span class="comment">// 有未使用的参数时，抛出错误</span></span><br><span class="line">    <span class="string">"noImplicitReturns"</span>: <span class="literal">true</span>,             <span class="comment">// 并不是所有函数里的代码都有返回值时，抛出错误</span></span><br><span class="line">    <span class="string">"noFallthroughCasesInSwitch"</span>: <span class="literal">true</span>,    <span class="comment">// 报告 switch 语句的 fallthrough 错误。（即，不允许 switch 的 case 语句贯穿）</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 模块解析选项 */</span></span><br><span class="line">    <span class="string">"moduleResolution"</span>: <span class="string">"node"</span>,            <span class="comment">// 选择模块解析策略： 'node' (Node.js) or 'classic' (TypeScript pre-1.6)。默认是classic</span></span><br><span class="line">    <span class="string">"baseUrl"</span>: <span class="string">"./"</span>,                       <span class="comment">// 用于解析非相对模块名称的基目录</span></span><br><span class="line">    <span class="string">"paths"</span>: &#123;&#125;,                           <span class="comment">// 模块名到基于 baseUrl 的路径映射的列表</span></span><br><span class="line">    <span class="string">"rootDirs"</span>: [],                        <span class="comment">// 根文件夹列表，其组合内容表示项目运行时的结构内容</span></span><br><span class="line">    <span class="string">"typeRoots"</span>: [],                       <span class="comment">// 包含类型声明的文件列表</span></span><br><span class="line">    <span class="string">"types"</span>: [],                           <span class="comment">// 需要包含的类型声明文件名列表</span></span><br><span class="line">    <span class="string">"allowSyntheticDefaultImports"</span>: <span class="literal">true</span>,  <span class="comment">// 允许从没有设置默认导出的模块中默认导入。</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Source Map Options */</span></span><br><span class="line">    <span class="string">"sourceRoot"</span>: <span class="string">"./"</span>,                    <span class="comment">// 指定调试器应该找到 TypeScript 文件而不是源文件的位置</span></span><br><span class="line">    <span class="string">"mapRoot"</span>: <span class="string">"./"</span>,                       <span class="comment">// 指定调试器应该找到映射文件而不是生成文件的位置</span></span><br><span class="line">    <span class="string">"inlineSourceMap"</span>: <span class="literal">true</span>,               <span class="comment">// 生成单个 soucemaps 文件，而不是将 sourcemaps 生成不同的文件</span></span><br><span class="line">    <span class="string">"inlineSources"</span>: <span class="literal">true</span>,                 <span class="comment">// 将代码与 sourcemaps 生成到一个文件中，要求同时设置了 --inlineSourceMap 或 --sourceMap 属性</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 其他选项 */</span></span><br><span class="line">    <span class="string">"experimentalDecorators"</span>: <span class="literal">true</span>,        <span class="comment">// 启用装饰器</span></span><br><span class="line">    <span class="string">"emitDecoratorMetadata"</span>: <span class="literal">true</span>,         <span class="comment">// 为装饰器提供元数据的支持</span></span><br><span class="line">    <span class="string">"strictFunctionTypes"</span>: <span class="literal">false</span>           <span class="comment">// 禁用函数参数双向协变检查。</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">/* 指定编译文件或排除指定编译文件 */</span></span><br><span class="line">  <span class="string">"include"</span>: [</span><br><span class="line">      <span class="string">"src/**/*"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"exclude"</span>: [</span><br><span class="line">      <span class="string">"node_modules"</span>,</span><br><span class="line">      <span class="string">"**/*.spec.ts"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"files"</span>: [</span><br><span class="line">    <span class="string">"core.ts"</span>,</span><br><span class="line">    <span class="string">"sys.ts"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="comment">// 从另一个配置文件里继承配置</span></span><br><span class="line">  <span class="string">"extends"</span>: <span class="string">"./config/base"</span>,</span><br><span class="line">  <span class="comment">// 让IDE在保存文件的时候根据tsconfig.json重新生成文件</span></span><br><span class="line">  <span class="string">"compileOnSave"</span>: <span class="literal">true</span> <span class="comment">// 支持这个特性需要Visual Studio 2015， TypeScript1.8.4以上并且安装atom-typescript插件</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://rile14929.github.io/zh-CN/%E8%A7%84%E8%8C%83%E5%9B%A2%E9%98%9FGitCommitMessage.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/Trevor.jpeg">
      <meta itemprop="name" content="rile">
      <meta itemprop="description" content="FE">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="右耳听风">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/zh-CN/%E8%A7%84%E8%8C%83%E5%9B%A2%E9%98%9FGitCommitMessage.html" class="post-title-link" itemprop="url">规范团队 Git Commit Message</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-02-06 00:00:00" itemprop="dateCreated datePublished" datetime="2023-02-06T00:00:00+08:00">2023-02-06</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h2><p>目前正在推动团队做持续部署，包括自动提交 npm 包到公司私库和自动生成 CHANGELOG，重中之重是根据 commit 来自动判断版本号，所以规范 git commit message 势在必行。<br>本文就介绍下团队是如何做的 commit message 的规范和格式化。</p>
<h2 id="Commit-Message-格式"><a href="#Commit-Message-格式" class="headerlink" title="Commit Message 格式"></a>Commit Message 格式</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;type&gt;(&lt;scope&gt;): &lt;subject&gt;</span><br></pre></td></tr></table></figure>

<h4 id="type-必须"><a href="#type-必须" class="headerlink" title="type(必须)"></a>type(必须)</h4><ul>
<li>feat: 新功能（feature）</li>
<li>fix: 修复 bug</li>
<li>perf: 优化相关，比如提升性能、体验</li>
<li>refactor: 重构（即不是新增功能，也不是修改 bug 的代码变动）</li>
<li>docs: 文档（documentation）</li>
<li>style: 格式（不影响代码运行的变动, 不是 css 样式）</li>
<li>test: 增加测试</li>
</ul>
<h4 id="scope-可选"><a href="#scope-可选" class="headerlink" title="scope(可选)"></a>scope(可选)</h4><ul>
<li>scope 用于说明 commit 影响的范围</li>
</ul>
<h4 id="subject-必须"><a href="#subject-必须" class="headerlink" title="subject(必须)"></a>subject(必须)</h4><ul>
<li>subject 是 commit 目的的简短描述，不超过 50 个字符。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">e.g.</span><br><span class="line">fix: 修复xxx问题</span><br><span class="line">feat: 新增xxx功能</span><br></pre></td></tr></table></figure>

<h2 id="Commintlint-校验你的-Message"><a href="#Commintlint-校验你的-Message" class="headerlink" title="Commintlint 校验你的 Message"></a>Commintlint 校验你的 Message</h2><p>commitlint 可以帮助我们 lint commit messages, 如果我们提交的不符合预设的规范, 直接拒绝提交。</p>
<p>目前团队使用的是<a href="https://github.com/conventional-changelog/commitlint/tree/master/%40commitlint/config-conventional" target="_blank" rel="noopener"><br>@commitlint/config-conventional</a>，因为团队后面要使用<br><a href="https://github.com/semantic-release/commit-analyzer/tree/master" target="_blank" rel="noopener">@semantic-release/commit-analyzer</a>进行一系列自动化操作，</p>
<p>，二者底层均依赖<a href="https://github.com/conventional-changelog/conventional-changelog/tree/master/packages/conventional-changelog-conventionalcommits" target="_blank" rel="noopener">conventional-changelog-conventionalcommits</a>，属于完美适配。</p>
<h2 id="结合-Husky"><a href="#结合-Husky" class="headerlink" title="结合 Husky"></a>结合 Husky</h2><p>本地校验 commit message 的最佳方式是结合 git hook, 所以需要配合 Husky。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">npm install husky --save-dev</span><br><span class="line"></span><br><span class="line">npx husky install</span><br><span class="line"></span><br><span class="line">npm set-script prepare &quot;husky install&quot;</span><br></pre></td></tr></table></figure>

<h5 id="执行完上面命令将带来以下几个变化"><a href="#执行完上面命令将带来以下几个变化" class="headerlink" title="执行完上面命令将带来以下几个变化"></a>执行完上面命令将带来以下几个变化</h5><ul>
<li>在.git 同级目录生成.husky 文件夹，文件夹下有一个可以编辑的示例 pre-commit 钩子</li>
<li>在 package.json 中的 scripts 中添加了”prepare”: “husky install”</li>
<li>更改 git 配置项 core.hooksPath 为.husky</li>
</ul>
<h5 id="package-json-配置"><a href="#package-json-配置" class="headerlink" title="package.json 配置:"></a>package.json 配置:</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&quot;husky&quot;: &#123;</span><br><span class="line">        &quot;hooks&quot;: &#123;</span><br><span class="line">            &quot;commit-msg&quot;: &quot;commitlint -E HUSKY_GIT_PARAMS&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>

<h2 id="shell-脚本"><a href="#shell-脚本" class="headerlink" title="shell 脚本"></a>shell 脚本</h2><p>上文的操作中会有一个小 bug，就是在本地绕过 git hook 校验的情况，当通过 gitlab 做持续部署时，会导致自动计算版本号等操作出错，所以在持续部署脚本启动前，通过 commit lint shell 脚本来避免这种情况发生。</p>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>commit message 的规范性很重要, 但是是否需要像本文这样强制限制, 每个团队和个人都有自己的想法, 但是个人认为: 好的习惯, 受益终身.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://rile14929.github.io/zh-CN/%E4%BD%BF%E7%94%A8verdaccio%E6%90%AD%E5%BB%BA%E7%A7%81%E6%9C%89npm%E4%BB%93%E5%BA%93.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/Trevor.jpeg">
      <meta itemprop="name" content="rile">
      <meta itemprop="description" content="FE">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="右耳听风">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/zh-CN/%E4%BD%BF%E7%94%A8verdaccio%E6%90%AD%E5%BB%BA%E7%A7%81%E6%9C%89npm%E4%BB%93%E5%BA%93.html" class="post-title-link" itemprop="url">使用verdaccio搭建私有npm仓库</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-12-27 00:00:00" itemprop="dateCreated datePublished" datetime="2022-12-27T00:00:00+08:00">2022-12-27</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><ul>
<li>公司内部开发的私有包,统一管理,方便开发和使用，尤其版本管理需要统一；</li>
<li>安全性，既要保证组件的使用方便也要保证组件的私有性。</li>
</ul>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>为什么选择 verdaccio？ <strong>免费</strong>！</p>
<p>市面上付费的软件大概有下面几种：</p>
<ul>
<li>付费选择：MyGet (<a href="http://www.myget.org" target="_blank" rel="noopener">www.myget.org</a>) 团队版 40 美元/月，且只能有五个账号和 2GB 的存储空间。</li>
<li>NPM Org (<a href="http://www.npmjs.com" target="_blank" rel="noopener">www.npmjs.com</a>) 每个账号每月 7 美元付费的我们就不考虑了，没这个必要，而且付费的也不是就更好。</li>
</ul>
<p>sinopia 搭建十分简单友好，不过这玩意儿已经停止维护了，最近的更新在几年前，但有一群人出了 sinopia 的一个分支，起了个名字叫 verdaccio，这个就是这次主要推荐的方案，这个库一直在积极维护中，github start 13000+，看来还是比较靠谱的，而且国内外各种资料参考下来，这个方案也是受到极力推荐的。</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>详细的<a href="https://verdaccio.org/docs/installation/" target="_blank" rel="noopener">安装教程</a>。如果是本地安装, 可以使用 npm、yarn 或 pnpm 全局安装即可。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">npm install --g verdaccio</span><br><span class="line">或</span><br><span class="line">yarn global add verdaccio</span><br><span class="line">或</span><br><span class="line">pnpm install -g verdaccio</span><br></pre></td></tr></table></figure>

<h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><p>在命令行执行下方命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">verdaccio</span><br></pre></td></tr></table></figure>

<p>启动后会输出配置文件地址和浏览器访问地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">warn --- config file  - xxx&#x2F;xxx&#x2F;config.yaml</span><br><span class="line">warn --- http address - http:&#x2F;&#x2F;localhost:4873&#x2F; - verdaccio&#x2F;5.14.0</span><br></pre></td></tr></table></figure>

<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><h4 id="nrm"><a href="#nrm" class="headerlink" title="nrm"></a>nrm</h4><p>nrm 是一个 NPM 源管理器，可以使用 nrm 在不同的源切换。</p>
<ul>
<li>安装 nrm</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g nrm</span><br></pre></td></tr></table></figure>

<ul>
<li>查看源</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nrm ls</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">  npm ---------- https:&#x2F;&#x2F;registry.npmjs.org&#x2F;</span><br><span class="line">  yarn --------- https:&#x2F;&#x2F;registry.yarnpkg.com&#x2F;</span><br><span class="line">  tencent ------ https:&#x2F;&#x2F;mirrors.cloud.tencent.com&#x2F;npm&#x2F;</span><br><span class="line">  cnpm --------- https:&#x2F;&#x2F;r.cnpmjs.org&#x2F;</span><br><span class="line">  taobao ------- https:&#x2F;&#x2F;registry.npmmirror.com&#x2F;</span><br><span class="line">  npmMirror ---- https:&#x2F;&#x2F;skimdb.npmjs.com&#x2F;registry&#x2F;</span><br><span class="line">* fc ----------- http:&#x2F;&#x2F;localhost:4873&#x2F;</span><br></pre></td></tr></table></figure>

<ul>
<li>添加或删除私有源</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">nrm add registry_name registry_url #添加源，registry_name为源的名称，registry_url为源的地址</span><br><span class="line">nrm del registry_name #删除源</span><br></pre></td></tr></table></figure>

<ul>
<li>使用私有源</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nrm use registry_name</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="登录私有源"><a href="#登录私有源" class="headerlink" title="登录私有源"></a>登录私有源</h4><ul>
<li>添加用户</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm adduser</span><br></pre></td></tr></table></figure>

<ul>
<li>登录</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm login</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="发布包"><a href="#发布包" class="headerlink" title="发布包"></a>发布包</h4><p>在项目的根目录下执行 npm publish 就可以将包发布到私有源</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm publish</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="权限管理"><a href="#权限管理" class="headerlink" title="权限管理"></a>权限管理</h3><h4 id="权限配置"><a href="#权限配置" class="headerlink" title="权限配置"></a>权限配置</h4><p>一般团队或者公司的私有项目，会采用不同的权限控制，配置文件的 packages 是配置包的权限的</p>
<ul>
<li>匹配包名<ul>
<li>‘@/‘ 表示带有@<em>/</em>的作用域包</li>
<li>** 表示其他的所有包</li>
<li>可以配置自己的包比如：’private-‘, ‘my-‘等等</li>
</ul>
</li>
<li>操作权限<ul>
<li>access 表示哪一类用户可以对匹配的项目进行安装(install)</li>
<li>publish 表示哪一类用户可以对匹配的项目进行发布(publish)</li>
<li>proxy 表示如果库中没有此包，此能过上面配置的 npmjs 去获取</li>
</ul>
</li>
<li>用户权限：<ul>
<li>$all 表示所有人都可以执行对应的操作</li>
<li>$authenticated 表示只有通过验证的人可以执行对应操作</li>
<li>$anonymous 表示只有匿名者可以进行对应操作（通常无用）</li>
<li>这里可以写已经注册的用户名，做到精细化控制</li>
</ul>
</li>
</ul>
<hr>
<h4 id="实际配置场景"><a href="#实际配置场景" class="headerlink" title="实际配置场景"></a>实际配置场景</h4><p>公司里有两个前端团队 teamA 和 teamB，私有源上的所有包都可以安装，但是每个团队只能发布或移除自己团队的包。则可以使用以下配置。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># config.yaml</span></span><br><span class="line"><span class="attr">packages:</span></span><br><span class="line">  <span class="comment"># teamA</span></span><br><span class="line">  <span class="string">'@teamA/*'</span><span class="string">:</span></span><br><span class="line">    <span class="attr">access:</span> <span class="string">$all</span></span><br><span class="line">    <span class="attr">publish:</span> <span class="string">teamA-user1</span> <span class="string">teamA-user2</span> <span class="string">teamA-user3</span></span><br><span class="line">    <span class="attr">unpublish:</span> <span class="string">teamA-user1</span> <span class="string">teamA-user2</span> <span class="string">teamA-user3</span></span><br><span class="line">    <span class="attr">proxy:</span> <span class="string">npmjs</span></span><br><span class="line">  <span class="comment"># teamB</span></span><br><span class="line">  <span class="string">'@teamB/*'</span><span class="string">:</span></span><br><span class="line">    <span class="attr">access:</span> <span class="string">$all</span></span><br><span class="line">    <span class="attr">publish:</span> <span class="string">teamB-user1</span> <span class="string">teamB-user2</span> <span class="string">teamB-user3</span></span><br><span class="line">    <span class="attr">unpublish:</span> <span class="string">teamB-user1</span> <span class="string">teamB-user2</span> <span class="string">teamB-user3</span></span><br><span class="line">    <span class="attr">proxy:</span> <span class="string">npmjs</span></span><br><span class="line">  <span class="comment"># 其他所有包</span></span><br><span class="line">  <span class="string">'**'</span><span class="string">:</span></span><br><span class="line">    <span class="attr">access:</span> <span class="string">$all</span></span><br><span class="line">    <span class="attr">publish:</span> <span class="string">$authenticated</span></span><br><span class="line">    <span class="attr">unpublish:</span> <span class="string">$authenticated</span></span><br><span class="line">    <span class="attr">proxy:</span> <span class="string">npmjs</span></span><br></pre></td></tr></table></figure>

<p>设置好 packages 后，我们还得更改 auth 的值，因为此时注册用户是没有限制的，也就是说如果你的私有 npm 库部署在外网环境的话，任何人都可以通过 npm adduser 命令注册用户。</p>
<p>显然，这是不允许出现的情况，所以这里我们需要设置 auth 的 max_users 为 -1，它代表的是禁用注册用户：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">auth:</span></span><br><span class="line">  <span class="attr">max_users:</span> <span class="number">-1</span></span><br></pre></td></tr></table></figure>

<p>如果需要添加用户这里介绍两种方法：</p>
<ul>
<li>可以通过安装 htpasswd-for-sinopia 来添加账号</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install htpasswd-for-sinopia -g #全局安装htpasswd-for-sinopia</span><br><span class="line">sinopia-adduser # 在 htpasswd 目录下执行</span><br></pre></td></tr></table></figure>

<ul>
<li>可以通过官方提供的工具来生成  <a href="https://hostingcanada.org/htpasswd-generator/" target="_blank" rel="noopener">htpasswd-generator</a> ，将生成的段字符串添加到 htpasswd 中即可。</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://rile14929.github.io/zh-CN/lerna%E6%9E%84%E5%BB%BAmonorepo%E5%AE%9E%E6%88%98.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/Trevor.jpeg">
      <meta itemprop="name" content="rile">
      <meta itemprop="description" content="FE">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="右耳听风">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/zh-CN/lerna%E6%9E%84%E5%BB%BAmonorepo%E5%AE%9E%E6%88%98.html" class="post-title-link" itemprop="url">lerna构建monorepo实战</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-11-26 00:00:00" itemprop="dateCreated datePublished" datetime="2022-11-26T00:00:00+08:00">2022-11-26</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><p>创建空文件夹，然后运行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx lerna init</span><br></pre></td></tr></table></figure>

<p>这行命令会创建一个空的<code>packages</code>文件夹，一个<code>package.json</code> 和 <code>lerna.json</code></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">|<span class="comment">-- mono-repo</span></span><br><span class="line">    |<span class="comment">-- packages</span></span><br><span class="line">    |<span class="comment">-- lerna.json</span></span><br><span class="line">    |<span class="comment">-- package.json</span></span><br></pre></td></tr></table></figure>

<p><code>package.json</code>有一点需要注意，他的<code>private</code>必须设置为<code>true</code>，因为本身并不是一个项目，而是承载多个子项目的项目，所以他自己不能直接发布，发布的应该是 packages/下面的各个子项目。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">"private": true</span><br></pre></td></tr></table></figure>

<p>lerna.json 初始化长这样：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"packages"</span>: [<span class="string">"packages/*"</span>],</span><br><span class="line">  <span class="attr">"version"</span>: <span class="string">"0.0.0"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>packages</code>字段就是标记你子项目的位置，默认就是<code>packages/</code>文件夹，他是一个数组，所以是支持多个不同位置的。</p>
<p>另外一个需要特别注意的是<code>version</code>字段，这个字段有两个类型的值，一个是像上面的<code>0.0.0</code>这样一个具体版本号，还可以是<code>independent</code>这个关键字。如果是具体版本号，那<code>lerna</code>管理的所有子项目都会有相同的版本号，如果你设置为<code>independent</code>，那各个子项目可以有自己的版本号。</p>
<p>因为我们的组件都是需要独立版本号，所以直接将<code>version</code>设置为<code>independent</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"packages"</span>: [<span class="string">"packages/*"</span>],</span><br><span class="line">  <span class="attr">"version"</span>: <span class="string">"independent"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="创建子项目"><a href="#创建子项目" class="headerlink" title="创建子项目"></a>创建子项目</h2><p>创建子项目可以使用 lerna 的命令来创建：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lerna create &lt;name&gt;</span><br></pre></td></tr></table></figure>

<p>通过 create 创建的子项目目录：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">|<span class="comment">-- mono-repo</span></span><br><span class="line">    |<span class="comment">-- packages</span></span><br><span class="line">        |<span class="comment">-- @mono-repo/project_1 # 推荐使用 `@&lt;项目名&gt;/&lt;子项目名&gt;` 的方式命名</span></span><br><span class="line">            |<span class="comment">--  __test__</span></span><br><span class="line">            |<span class="comment">-- lib</span></span><br><span class="line">        |<span class="comment">-- @mono-repo/project_2</span></span><br><span class="line">            |<span class="comment">--  __test__</span></span><br><span class="line">            |<span class="comment">-- lib</span></span><br><span class="line">    |<span class="comment">-- lerna.json</span></span><br><span class="line">    |<span class="comment">-- package.json</span></span><br></pre></td></tr></table></figure>

<p>这个是使用<code>lerna create</code>默认生成的目录结构，<code>__test__</code>文件夹下面放得是单元测试内容，<code>lib</code>下面放得是代码。实际使用过程中可以进行调整。</p>
<h2 id="安装依赖项"><a href="#安装依赖项" class="headerlink" title="安装依赖项"></a>安装依赖项</h2><h4 id="lerna-bootstrap"><a href="#lerna-bootstrap" class="headerlink" title="lerna bootstrap"></a>lerna bootstrap</h4><p><code>packages/</code>下面的每个子项目有自己的依赖包，可使用命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">lerna bootstrap</span><br><span class="line">或</span><br><span class="line">lerna bootstrap --hoist</span><br></pre></td></tr></table></figure>

<p>删除已经安装的子项目<code>node_modules</code>可以手动删除，也可以使用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lerna clean</span><br></pre></td></tr></table></figure>

<p>具体命令含义可参考</p>
<ul>
<li><a href="http://www.febeacon.com/lerna-docs-zh-cn/routes/commands/bootstrap.html" target="_blank" rel="noopener">lerna/bootstrap</a></li>
<li><a href="http://www.febeacon.com/lerna-docs-zh-cn/routes/commands/clean.html" target="_blank" rel="noopener">lerna/clean</a></li>
</ul>
<hr>
<h4 id="yarn-workspace"><a href="#yarn-workspace" class="headerlink" title="yarn workspace"></a>yarn workspace</h4><p><code>lerna bootstrap --hoist</code>虽然可以将子项目的依赖提升到顶层，但是他的方式比较粗暴：先在每个子项目运行<code>npm install</code>，等所有依赖都安装好后，将他们移动到顶层的<code>node_modules</code>。这会导致一个问题，如果多个子项目依赖同一个第三方库，但是需求的版本不同怎么办？比如我们三个子项目都依赖 antd，但是他们的版本不完全一样：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @mono-repo/project_1</span></span><br><span class="line">"antd": "3.1.0"</span><br><span class="line"></span><br><span class="line"><span class="comment">// @mono-repo/project_2</span></span><br><span class="line">"antd": "3.1.0"</span><br><span class="line"></span><br><span class="line"><span class="comment">// @mono-repo/project_3</span></span><br><span class="line">"antd": "4.9.4"</span><br></pre></td></tr></table></figure>

<p>这时候就需要介绍<code>yarn workspace</code>了，他可以解决前面说的版本不一致的问题，<code>lerna bootstrap --hoist</code>会把所有子项目用的最多的版本移动到顶层, 从而导致某些子项目依赖不正确，而<code>yarn workspace</code> 则会检查每个子项目里面依赖及其版本，如果版本不一样则会留在子项目自己的<code>node_modules</code>里面，只有完全一样的依赖才会提升到顶层。</p>
<p>还是以上面这个<code>antd</code>为例，使用<code>yarn workspace</code>的话，会把<code>project1</code>和<code>project2</code>的 3.1.0 版本移动到顶层，而<code>project3</code>项目下会保留自己 4.9.4 的 antd，这样每个子项目都可以拿到自己需要的依赖了。</p>
<p><code>yarn workspace</code>使用也很简单，<code>yarn 1.0</code>以上的版本默认就是开启<code>workspace</code>的，所以我们只需要在顶层的<code>package.json</code>加一个配置就行：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 顶层package.json</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"workspaces"</span>: [<span class="string">"packages/*"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 lerna.json 里面指定<code>npmClient</code>为<code>yarn</code>，并将<code>useWorkspaces</code>设置为<code>true</code>，稍稍改动变成这样：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"packages"</span>: [<span class="string">"packages/*"</span>],</span><br><span class="line">  <span class="attr">"version"</span>: <span class="string">"independent"</span>,</span><br><span class="line">  <span class="attr">"npmClient"</span>: <span class="string">"yarn"</span>,</span><br><span class="line">  <span class="attr">"useWorkspaces"</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用了<code>yarn workspace</code>，我们就不用<code>lerna bootstrap</code>来安装依赖了，而是像以前一样<code>yarn install</code>就行了，他会自动帮我们提升依赖，这里的<code>yarn install</code>无论在顶层运行还是在任意一个子项目运行效果都是一样的。</p>
<p>更多请参考</p>
<ul>
<li><a href="https://classic.yarnpkg.com/en/docs/workspaces/" target="_blank" rel="noopener">yarn workspace</a></li>
<li><a href="https://yarnpkg.com/cli/workspace" target="_blank" rel="noopener">yarn workspace 命令</a></li>
</ul>
<h2 id="启动子项目"><a href="#启动子项目" class="headerlink" title="启动子项目"></a>启动子项目</h2><p>我们可以到子项目的目录运行 start 命令， 但是频繁切换文件是在太麻烦，lerna 提供了相应的命令以帮助我们直接在顶层运行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lerna run [script]</span><br></pre></td></tr></table></figure>

<p>比如我们在顶层运行了 lerna run start，这相当于去每个子项目下面都去执行 yarn run start 或者 npm run start，具体是 yarn 还是 npm，取决于你在 lerna.json 里面的这个设置：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">"npmClient": "yarn"</span><br></pre></td></tr></table></figure>

<p>如果我只想在其中一个子项目运行命令，应该怎么办呢？加上<code>--scope</code>就行了，比如我就在顶层的<code>package.json</code>里面加了这么一行命令：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 顶层package.json</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"start:project1"</span>: <span class="string">"lerna --scope @mono-repo/project_1 run start"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意<code>scope</code>后面的项目名称不是目录名，而是子项目<code>package.json</code>的<code>name</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 子项目project_1的package.json</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"@mono-repo/project_1"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="引入公共组件"><a href="#引入公共组件" class="headerlink" title="引入公共组件"></a>引入公共组件</h2><p>当我们的<code>@mono-repo/project_2</code>要引用<code>@mono-repo/project_1</code>的组件，我们需要先在<code>@mono-repo/project_2</code>的<code>package.json</code>里面将依赖加上，我们可以去手动修改他，也可以使用<code>lerna</code>命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lerna add @mono-repo&#x2F;project_1 --scope @mono-repo&#x2F;project_2</span><br></pre></td></tr></table></figure>

<p>这样我们可以在<code>project2</code>中引入<code>project1</code>的组件，但是需要注意多个项目引用时，要避免各个子项目之间的循环引用。</p>
<p>组件库相关请参考<a href="">组件库构建与编写</a></p>
<h2 id="发布"><a href="#发布" class="headerlink" title="发布"></a>发布</h2><p>发布直接使用 lerna publish，因为此前我们已经将 version 修改为 independent，所以在发布时，只会自动更新有变动的子项目以及依赖该子项目的子项目的版本号。</p>
<p>更多发布命令参数及解释请参考<a href="http://www.febeacon.com/lerna-docs-zh-cn/routes/commands/publish.html" target="_blank" rel="noopener">lerna/publish</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://rile14929.github.io/zh-CN/Git%E4%BB%93%E5%BA%93%E8%BF%81%E7%A7%BB%E6%96%B9%E6%A1%88.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/Trevor.jpeg">
      <meta itemprop="name" content="rile">
      <meta itemprop="description" content="FE">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="右耳听风">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/zh-CN/Git%E4%BB%93%E5%BA%93%E8%BF%81%E7%A7%BB%E6%96%B9%E6%A1%88.html" class="post-title-link" itemprop="url">Git仓库迁移方案</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-10-30 00:00:00" itemprop="dateCreated datePublished" datetime="2022-10-30T00:00:00+08:00">2022-10-30</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>公司有一些前端代码在不同的托管平台上，为了统一管理和维护的效率，所以要将其他托管平台的代码全部快捷平迁到公司的私有 gitlab 上。</p>
<h1 id="迁移方式"><a href="#迁移方式" class="headerlink" title="迁移方式"></a>迁移方式</h1><blockquote>
<p>在你把原来的仓库推到你的仓库的新副本或镜像之前，你必须在新的托管平台上创建新的仓库。<br>在以下的这些示例中，exampleuser/new-repository 或 exampleuser/mirrored 是镜像。</p>
</blockquote>
<h3 id="镜像存储库"><a href="#镜像存储库" class="headerlink" title="镜像存储库"></a>镜像存储库</h3><ol>
<li>创建存储库的裸克隆</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git clone --bare https:&#x2F;&#x2F;github.com&#x2F;EXAMPLE-USER&#x2F;OLD-REPOSITORY.git</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>镜像推送到新的存储库</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cd OLD-REPOSITORY.git</span><br><span class="line">$ git push --mirror https:&#x2F;&#x2F;github.com&#x2F;EXAMPLE-USER&#x2F;NEW-REPOSITORY.git</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>删除前面创建的临时本地存储库</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cd ..</span><br><span class="line">$ rm -rf OLD-REPOSITORY.git</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>拉取新存储库或者更改本地项目的源为新的存储库的地址</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git remote set-url origin https:&#x2F;&#x2F;github.com&#x2F;EXAMPLE-USER&#x2F;NEW-REPOSITORY.git</span><br></pre></td></tr></table></figure>

<h3 id="其它方式"><a href="#其它方式" class="headerlink" title="其它方式"></a>其它方式</h3><p>由于上面的方式可以满足目前已有的迁移需求，其它方式可参考<a href="https://docs.github.com/en/repositories/creating-and-managing-repositories/duplicating-a-repository" target="_blank" rel="noopener">文档</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://rile14929.github.io/zh-CN/rollup.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/Trevor.jpeg">
      <meta itemprop="name" content="rile">
      <meta itemprop="description" content="FE">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="右耳听风">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/zh-CN/rollup.html" class="post-title-link" itemprop="url">rollup使用总结</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-09-10 00:00:00" itemprop="dateCreated datePublished" datetime="2022-09-10T00:00:00+08:00">2022-09-10</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>项目中一直用的都是 webpack，前一段需要开发几个类库， 看过很多开源库源码都是用 rollup。这次通过开发类库，于是就快速上手了 rollup。</p>
<h2 id="定位"><a href="#定位" class="headerlink" title="定位"></a>定位</h2><p>Rollup 是一个 JavaScript 模块打包器，可以将小块代码编译成大块复杂的代码，例如 library 或应用程序。</p>
<p>与 Webpack 偏向于应用打包的定位不同，rollup.js 更专注于 Javascript 类库打包。</p>
<p>我们熟知的 Vue2、React 等诸多知名框架或类库都是通过 rollup.js 进行打包的。</p>
<h2 id="常用配置"><a href="#常用配置" class="headerlink" title="常用配置"></a>常用配置</h2><h4 id="入口文件"><a href="#入口文件" class="headerlink" title="入口文件"></a>入口文件</h4><p>Rollup 既然是打包类库文件，那么它的入口也就只能是 JS 文件了（通过第三方插件可以支持 Html，这里不作展开），因此我们新建一个 main.js 作为入口文件，打包出来的文件我们命名为 bundle.js，我们可以简单的通过命令行进行打包：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 针对浏览器环境打包</span><br><span class="line">rollup main.js --file bundle.js --format iife</span><br><span class="line"></span><br><span class="line"># 针对Nodejs环境打包</span><br><span class="line">rollup main.js --file bundle.js --format cjs</span><br></pre></td></tr></table></figure>

<p>推荐使用配置文件进行打包：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 默认使用rollup.config.js配置文件</span><br><span class="line">rollup --config</span><br><span class="line"></span><br><span class="line"># 使用自定义my.config.js配置文件</span><br><span class="line">$ rollup --config my.config.js</span><br></pre></td></tr></table></figure>

<p>一个基础的配置文件如下</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// rollup.config.js</span></span><br><span class="line">export default &#123;</span><br><span class="line">    input: "main.js",</span><br><span class="line">    output: &#123;</span><br><span class="line">        file: "bundle.js",</span><br><span class="line">        format: "cjs"</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;;</span><br></pre></td></tr></table></figure>

<p>这里的 format 字段有六种选项：</p>
<ul>
<li>amd： 异步模块定义，用于像 RequireJS 这样的模块加载器</li>
<li>cjs：CommonJS，适用于 Node 和 Browserify/Webpack</li>
<li>es：ES 模块文件</li>
<li>iife：自执行模块，适用于浏览器环境 script 标签</li>
<li>umd：通用模块定义，以 amd，cjs 和 iife 为一体</li>
<li>system：SystemJS 加载器格式</li>
</ul>
<p>Rollup 也支持配置多个文件入口，我们新建 foo.js 和 bar.js 两个入口文件：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  input: &#123;</span><br><span class="line">    foo: <span class="string">'./foo.js'</span>,</span><br><span class="line">    bar: <span class="string">'./bar.js'</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  output: &#123;</span><br><span class="line">    dir: <span class="string">'dist'</span>,</span><br><span class="line">    format: <span class="string">'cjs'</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样打包出来的两个文件就放入 dist 中。</p>
<hr>
<h4 id="插件-plugins"><a href="#插件-plugins" class="headerlink" title="插件(plugins)"></a>插件(plugins)</h4><ul>
<li>@rollup/plugin-json<ul>
<li>可以读取 json 文件</li>
</ul>
</li>
<li>@rollup/plugin-commonjs<ul>
<li>第三方的模块为了能够直接使用，往往不是 ES6 模块而是用 commonjs 的模块方式编写的，<strong>将 commonjs 的模块转化为 ES6 模块</strong></li>
</ul>
</li>
<li>@rollup/plugin-node-resolve<ul>
<li><strong>帮助 rollup 查找 node_modules 里的三方模块</strong></li>
</ul>
</li>
<li>@rollup-plugin-alias<ul>
<li><strong>提供 modules 名称的 alias 和 reslove 功能</strong></li>
</ul>
</li>
<li>@rollup/plugin-babel<ul>
<li><strong>打包的时候使用 babel 编译 js 代码</strong></li>
</ul>
</li>
<li>@rollup/plugin-replace<ul>
<li>类似 Webpack 的 DefinePlugin, 可在源码中通过 process.env.NODE_ENV 用于构建区分环境.</li>
</ul>
</li>
<li>rollup-plugin-typescript2<ul>
<li>这是对原始 rollup-plugin-typescript 的重写，这个版本比原始版本慢一些，但是它将打印出打字稿的句法和语义诊断消息（毕竟使用打字稿的主要原因）。使用该插件还有一个重要的原因，该插件能生成 声明文件 首先需要提供基础安装环境, 除了 typescript 基础环境 该插件需要依赖 tslib 去编译 ts 代码</li>
</ul>
</li>
<li>rollup-plugin-terser<ul>
<li><strong>可以打包压缩 es6 的 js 代码</strong></li>
</ul>
</li>
</ul>
<hr>
<h4 id="外链-external"><a href="#外链-external" class="headerlink" title="外链(external)"></a>外链(external)</h4><p>我们在自己的库中需要使用第三方库，例如 vue 等，又不想在最终生成的打包文件中出现 vue，这个时候我们就需要 external 属性。</p>
<ol>
<li>外部依赖的名称</li>
<li>一个已被找到路径的 ID（像文件的绝对路径）</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// rollup.config.js</span></span><br><span class="line"><span class="keyword">import</span> path <span class="keyword">from</span> <span class="string">'path'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  ...,</span><br><span class="line">  external: [</span><br><span class="line">    <span class="string">'some-externally-required-library'</span>,</span><br><span class="line">    path.resolve( <span class="string">'./src/some-local-file-that-should-not-be-bundled.js'</span> )</span><br><span class="line">  ]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="全局模块-globals"><a href="#全局模块-globals" class="headerlink" title="全局模块(globals)"></a>全局模块(globals)</h4><p><code>Object</code>  形式的  <code>id: name</code> 键值对，用于<code>umd/iife</code>包。例如在这样的情况下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import $ from &#39;jquery&#39;;</span><br></pre></td></tr></table></figure>

<p>我们想告诉 Rollup jquery  模块的 id 等同于  $  变量:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// rollup.config.js</span></span><br><span class="line">export default &#123;</span><br><span class="line">  ...,</span><br><span class="line">  format: 'iife',</span><br><span class="line">  name: 'MyBundle',</span><br><span class="line">  globals: &#123;</span><br><span class="line">    jquery: '$'</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">var MyBundle = (function ($) &#123;</span></span><br><span class="line"><span class="comment">  // 代码到这里</span></span><br><span class="line"><span class="comment">&#125;(window.jQuery));</span></span><br><span class="line">*/.</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="Tree-Shaking"><a href="#Tree-Shaking" class="headerlink" title="Tree Shaking"></a>Tree Shaking</h4><p>由于 Rollup 本身支持 ES6 模块化规范，因此不需要额外配置即可进行 Tree Shaking</p>
<hr>
<h4 id="代码分割"><a href="#代码分割" class="headerlink" title="代码分割"></a>代码分割</h4><p>import()实现了按需加载, rollup 内部会进行代码拆分，注意 format 不能用 iife 模式，因为 iife 会把所有模块放在同一个函数中</p>
<hr>
<p>更多可参考<a href="https://www.rollupjs.com/guide/big-list-of-options" target="_blank" rel="noopener">大选项列表</a></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>以上就是在开发类库的过程中对 rollup 的简单总结，接下来会进一步剖析 rollup 打包流程和原理。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="rile"
      src="/images/Trevor.jpeg">
  <p class="site-author-name" itemprop="name">rile</p>
  <div class="site-description" itemprop="description">FE</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">38</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Rile14929" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Rile14929" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:rile14929@163.com" title="E-Mail → mailto:rile14929@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2020 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-rocket"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">rile</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
